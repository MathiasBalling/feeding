<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.6.1"/>
    <title>sims.panda_cable_weaving API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../sims.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;sims</a>

            <img src="mujoco-logo-reborn.png" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Gripper">Gripper</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Gripper.__init__">Gripper</a>
                        </li>
                        <li>
                                <a class="variable" href="#Gripper.name">name</a>
                        </li>
                        <li>
                                <a class="function" href="#Gripper.get_ee_pose">get_ee_pose</a>
                        </li>
                        <li>
                                <a class="variable" href="#Gripper.data">data</a>
                        </li>
                        <li>
                                <a class="variable" href="#Gripper.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#Gripper.info">info</a>
                        </li>
                        <li>
                                <a class="function" href="#Gripper.step">step</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MjSim">MjSim</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#MjSim.gripper">gripper</a>
                        </li>
                        <li>
                                <a class="variable" href="#MjSim.mocap">mocap</a>
                        </li>
                        <li>
                                <a class="variable" href="#MjSim.T_mocap_tcp">T_mocap_tcp</a>
                        </li>
                        <li>
                                <a class="variable" href="#MjSim.spec">spec</a>
                        </li>
                        <li>
                                <a class="variable" href="#MjSim.tasks">tasks</a>
                        </li>
                        <li>
                                <a class="variable" href="#MjSim.h">h</a>
                        </li>
                        <li>
                                <a class="variable" href="#MjSim.theta">theta</a>
                        </li>
                        <li>
                                <a class="variable" href="#MjSim.delta">delta</a>
                        </li>
                        <li>
                                <a class="variable" href="#MjSim.begin">begin</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.init">init</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.spin">spin</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.get_check_point_frames">get_check_point_frames</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.weaving">weaving</a>
                        </li>
                        <li>
                                <a class="variable" href="#MjSim.data">data</a>
                        </li>
                        <li>
                                <a class="variable" href="#MjSim.model">model</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.keyboard_callback">keyboard_callback</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.init_orientation">init_orientation</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.move_close">move_close</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.angle_to_next_alignment">angle_to_next_alignment</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.rotate_about">rotate_about</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.opp1">opp1</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.opp2">opp2</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.opp3">opp3</a>
                        </li>
                        <li>
                                <a class="function" href="#MjSim.opp4">opp4</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../sims.html">sims</a><wbr>.panda_cable_weaving    </h1>

                
                        <input id="mod-panda_cable_weaving-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-panda_cable_weaving-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">import</span> <span class="nn">glfw</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">mujoco</span> <span class="k">as</span> <span class="nn">mj</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">spatialmath</span> <span class="k">as</span> <span class="nn">sm</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">dm_control</span> <span class="kn">import</span> <span class="n">mjcf</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">robots.base_robot</span> <span class="kn">import</span> <span class="n">BaseRobot</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">robots.mocap</span> <span class="kn">import</span> <span class="n">Mocap</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span> <span class="nn">sims</span> <span class="kn">import</span> <span class="n">BaseSim</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span> <span class="nn">sims.base_sim</span> <span class="kn">import</span> <span class="n">SimSync</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">utils.math</span> <span class="kn">import</span> <span class="n">angle</span><span class="p">,</span> <span class="n">rotate_vector_2d</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">utils.mj</span> <span class="kn">import</span> <span class="n">ObjType</span><span class="p">,</span> <span class="n">RobotInfo</span><span class="p">,</span> <span class="n">get_pose</span><span class="p">,</span> <span class="n">load_keyframe</span><span class="p">,</span> <span class="n">save_keyframe</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span> <span class="nn">utils.sm</span> <span class="kn">import</span> <span class="n">make_tf</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="k">class</span> <span class="nc">Gripper</span><span class="p">(</span><span class="n">BaseRobot</span><span class="p">):</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">):</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="n">RobotInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>    <span class="nd">@property</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>        <span class="k">return</span> <span class="s2">&quot;panda hand&quot;</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="k">def</span> <span class="nf">get_ee_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>        <span class="k">return</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tcp&quot;</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">SITE</span><span class="p">)</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="nd">@property</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">:</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>    <span class="nd">@property</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="p">:</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>    <span class="nd">@property</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RobotInfo</span><span class="p">:</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="k">class</span> <span class="nc">MjSim</span><span class="p">(</span><span class="n">BaseSim</span><span class="p">):</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span> <span class="o">=</span> <span class="n">Gripper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span> <span class="o">=</span> <span class="n">Mocap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="n">T_w_mocap</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;mocap_site&quot;</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">SITE</span><span class="p">)</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span> <span class="o">=</span> <span class="n">T_w_mocap</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span> <span class="o">@</span> <span class="n">T_w_tcp</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>            <span class="s2">&quot;o0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;task_board/wire_washer_3&quot;</span><span class="p">,</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span> <span class="s2">&quot;ccw&quot;</span><span class="p">},</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>            <span class="s2">&quot;o1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;task_board/wire_washer_2&quot;</span><span class="p">,</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span> <span class="s2">&quot;cw&quot;</span><span class="p">},</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>            <span class="s2">&quot;o2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;task_board/wire_washer_1&quot;</span><span class="p">,</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span> <span class="s2">&quot;ccw&quot;</span><span class="p">},</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>        <span class="p">}</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">]</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>        <span class="c1"># self.tasks = [self.spin, self.weaving]</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="n">load_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;unnamed_model/s0_1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="mf">0.05</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="c1"># root</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="n">_HERE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="c1"># create keyframe file</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span><span class="p">,</span> <span class="s2">&quot;keyframes&quot;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.xml&quot;</span><span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="c1"># Ensure the parent directory exists</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="c1"># Create an empty file if it doesn&#39;t exist</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>            <span class="c1"># Define the XML content you want to append</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>            <span class="n">xml_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="s2">            &lt;mujoco&gt;</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="s2">            &lt;/mujoco&gt;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>            <span class="c1"># Open the file in append mode and write the XML content</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xml_content</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>            <span class="c1"># find keyframes file and load in</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="c1"># scene path</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="n">_XML_SCENE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;scenes/empty.xml&quot;</span><span class="p">)</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="n">scene</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_SCENE</span><span class="p">)</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">keyframe</span><span class="p">)</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>        <span class="c1"># panda path</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>        <span class="n">_XML_PANDA</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/franka_emika_panda/hand.xml&quot;</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>        <span class="c1"># _XML_panda = Path(_HERE / &quot;assets/robotiq_panda/panda-gs.xml&quot;)</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>        <span class="n">panda_hand</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_PANDA</span><span class="p">)</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>        <span class="n">mocap_body</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>            <span class="s2">&quot;body&quot;</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mocap&quot;</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>            <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;0 0 0.1&quot;</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>            <span class="n">mocap</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="p">)</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="n">mocap_body</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>            <span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;0.01 0.01 0.01&quot;</span><span class="p">,</span> <span class="n">contype</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">conaffinity</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="p">)</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="n">mocap_site</span> <span class="o">=</span> <span class="n">mocap_body</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mocap_site&quot;</span><span class="p">)</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>        <span class="n">mocap_site</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">panda_hand</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>        <span class="c1"># rgmc practice board</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>        <span class="n">_XML_BOARD</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>            <span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/rgmc_practice_task_board_2020/task_board_mjx.xml&quot;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>        <span class="p">)</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>        <span class="n">board</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_BOARD</span><span class="p">)</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="c1"># table</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="n">_XML_TABLE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/props/flexcell_top.xml&quot;</span><span class="p">)</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>        <span class="n">table</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_TABLE</span><span class="p">)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="c1"># cable</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="n">_XML_CABLE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/props/cable.xml&quot;</span><span class="p">)</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="n">cable</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_CABLE</span><span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="n">cable_body</span> <span class="o">=</span> <span class="n">cable</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;cable&quot;</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>        <span class="n">cable_body</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.67521462</span><span class="p">,</span> <span class="mf">0.27162106</span><span class="p">,</span> <span class="mf">0.08657647</span><span class="p">]</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">cable</span><span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>        <span class="c1"># add pseudo fingers</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="n">rf</span> <span class="o">=</span> <span class="n">panda_hand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;right_finger&quot;</span><span class="p">)</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>        <span class="n">rf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>            <span class="s2">&quot;geom&quot;</span><span class="p">,</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;right_finger&quot;</span><span class="p">,</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="n">size</span><span class="o">=</span><span class="s2">&quot;0.01 0.02 0.01&quot;</span><span class="p">,</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>            <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;0 0.02 0.1&quot;</span><span class="p">,</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>            <span class="n">axisangle</span><span class="o">=</span><span class="s2">&quot;1 0 0 -1&quot;</span><span class="p">,</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>            <span class="n">solref</span><span class="o">=</span><span class="s2">&quot;0.000000001 1&quot;</span><span class="p">,</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>            <span class="n">friction</span><span class="o">=</span><span class="s2">&quot;0.3 0.3 0.3&quot;</span><span class="p">,</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>            <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>        <span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>        <span class="n">lf</span> <span class="o">=</span> <span class="n">panda_hand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;left_finger&quot;</span><span class="p">)</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="n">lf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>            <span class="s2">&quot;geom&quot;</span><span class="p">,</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;left_finger&quot;</span><span class="p">,</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>            <span class="n">size</span><span class="o">=</span><span class="s2">&quot;0.01 0.02 0.01&quot;</span><span class="p">,</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>            <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;0 0.02 0.1&quot;</span><span class="p">,</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>            <span class="n">axisangle</span><span class="o">=</span><span class="s2">&quot;1 0 0 -1&quot;</span><span class="p">,</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>            <span class="n">solref</span><span class="o">=</span><span class="s2">&quot;0.000000001 1&quot;</span><span class="p">,</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>            <span class="n">friction</span><span class="o">=</span><span class="s2">&quot;0.3 0.3 0.3&quot;</span><span class="p">,</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>            <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="p">)</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>        <span class="n">board_body</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;task_board&quot;</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="n">board_body</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>        <span class="n">wire_washer_3</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_washer_3&quot;</span><span class="p">)</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="n">wire_washer_2</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_washer_2&quot;</span><span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="n">wire_washer_1</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_washer_1&quot;</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="n">wire_bolt_3</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_bolt_3&quot;</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="n">wire_bolt_2</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_bolt_2&quot;</span><span class="p">)</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>        <span class="n">wire_bolt_1</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_bolt_1&quot;</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="n">wire_washer_3</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="n">wire_washer_2</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="n">wire_washer_1</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="n">wire_bolt_3</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>        <span class="n">wire_bolt_2</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="n">wire_bolt_1</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="n">m</span> <span class="o">=</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="o">.</span><span class="n">from_xml_string</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">to_xml_string</span><span class="p">(),</span> <span class="n">scene</span><span class="o">.</span><span class="n">get_assets</span><span class="p">())</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="c1"># step once to compute the poses of objects</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="n">mj</span><span class="o">.</span><span class="n">mj_step</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a>        <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>    <span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ss</span><span class="p">:</span> <span class="n">SimSync</span><span class="p">):</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>            <span class="n">ss</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>    <span class="k">def</span> <span class="nf">get_check_point_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">]:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>        <span class="n">traj</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="n">traj</span><span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="n">z_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_orientation</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="n">traj</span><span class="p">[</span><span class="s2">&quot;init_orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="n">N_SPEC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SPEC</span><span class="p">):</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_close</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;move_close_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp1_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp2_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp3_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp4</span><span class="p">(</span><span class="n">z_height</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp4_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">N_SPEC</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>                <span class="n">o_next_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>                <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_to_next_alignment</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">o_next_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate_about</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">Ti</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>                    <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;rotate_about_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ti</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>        <span class="k">return</span> <span class="n">traj</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>    <span class="k">def</span> <span class="nf">weaving</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ss</span><span class="p">:</span> <span class="n">SimSync</span><span class="p">):</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">:</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>            <span class="n">ss</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="n">DEFAULT_VEL</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>        <span class="n">FAST_VEL</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>        <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>        <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>        <span class="n">z_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_orientation</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="c1"># rotate the gripper towards the first obstacle</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span><span class="p">)</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="n">N_SPEC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SPEC</span><span class="p">):</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>            <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>            <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_close</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>            <span class="c1"># move towards the i&#39;th obstacle and keep moving until a distance of (radius) is achieved</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">DEFAULT_VEL</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>                <span class="k">return</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>            <span class="c1"># lift up the cable</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">DEFAULT_VEL</span><span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>            <span class="c1"># rotate the gripper theta</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span><span class="p">)</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>            <span class="c1"># move over the obstacle distance delta</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span><span class="p">)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>            <span class="c1"># move down again</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp4</span><span class="p">(</span><span class="n">z_height</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">DEFAULT_VEL</span><span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">N_SPEC</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>                <span class="c1"># rotate about the obstacle until the gripper is aligned with the new</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>                <span class="n">o_next_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>                <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_to_next_alignment</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">o_next_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate_about</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                <span class="k">for</span> <span class="n">Ti</span> <span class="ow">in</span> <span class="n">T</span><span class="p">:</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>                        <span class="n">Ti</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                    <span class="p">)</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>    <span class="nd">@property</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>    <span class="nd">@property</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="p">:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>    <span class="k">def</span> <span class="nf">keyboard_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="n">glfw</span><span class="o">.</span><span class="n">KEY_SPACE</span><span class="p">:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You pressed space...&quot;</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="n">glfw</span><span class="o">.</span><span class="n">KEY_PERIOD</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You pressed period...&quot;</span><span class="p">)</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>            <span class="n">save_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;s0_1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>    <span class="k">def</span> <span class="nf">init_orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vel</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">        Align the TCP&#39;s y-axis to point directly away from a specified object.</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a><span class="sd">        Parameters:</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a><span class="sd">        - geom_name (str): Name of the geometry to align away from.</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a><span class="sd">        - vel (float): Desired rotation velocity in radians per second (currently unused).</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="sd">        Returns:</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">        - sm.SE3: The target pose after rotation.</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="n">ry_T_w_tcp</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Extract the x-axis of the TCP&#39;s rotation matrix</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="n">T_w_o</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="n">p_tcp_p_o</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="n">T_w_o</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>        <span class="p">)</span>  <span class="c1"># Relative 2D position from TCP to object</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="c1"># Normalize vectors for angle calculation</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="n">ry_T_w_tcp</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ry_T_w_tcp</span><span class="p">)</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="n">p_tcp_p_o</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p_tcp_p_o</span><span class="p">)</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="c1"># Compute the angle between the TCP&#39;s x-axis and the relative position vector</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="n">phi</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="n">ry_T_w_tcp</span><span class="p">,</span> <span class="n">p_tcp_p_o</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="p">)</span>  <span class="c1"># Angle between current x-axis and target direction</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="n">cross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="n">ry_T_w_tcp</span><span class="p">,</span> <span class="n">p_tcp_p_o</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>        <span class="p">)</span>  <span class="c1"># Determine rotation direction (2D cross product)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>        <span class="k">if</span> <span class="n">cross</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">phi</span>  <span class="c1"># Rotate counter-clockwise</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">phi</span>  <span class="c1"># Rotate clockwise</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="c1"># Compute the target pose by rotating the TCP pose around the z-axis</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="n">T_target</span> <span class="o">=</span> <span class="n">T_w_tcp</span> <span class="o">@</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>        <span class="k">return</span> <span class="n">T_target</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>    <span class="k">def</span> <span class="nf">move_close</span><span class="p">(</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>        <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.06</span><span class="p">,</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">        Move towards the object specified by geom_name until within a given radius.</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">        Parameters:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">        - geom_name: str, the name of the geometry to move towards.</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">        - radius: float, the distance to maintain from the object.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">        - vel: float, the velocity of the movement.</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">        Returns:</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a><span class="sd">        - sm.SE3: Pose radius away from a geometry.</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>        <span class="n">dpos</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dpos</span><span class="p">)</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        <span class="c1"># Adjust the translation to stop within the specified radius</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">radius</span><span class="p">:</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>            <span class="n">pos_unit</span> <span class="o">=</span> <span class="n">dpos</span> <span class="o">/</span> <span class="n">dt</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">radius</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="n">pos_unit</span> <span class="o">*=</span> <span class="n">scale</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="n">T1</span> <span class="o">=</span> <span class="n">make_tf</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">pos_unit</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>            <span class="c1"># T1 = sm.SE3.Rt(R=T_gripper.R, t=T_gripper.t + pos_unit)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>            <span class="n">T1</span> <span class="o">=</span> <span class="n">T_w_geom</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="k">return</span> <span class="n">T1</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>    <span class="k">def</span> <span class="nf">angle_to_next_alignment</span><span class="p">(</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>        <span class="n">geom_indx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="n">current_geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="n">next_geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">        Compute the angle to align the TCP with a tangent direction between two geometries.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">        Parameters:</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">        - geom_indx (int): Index of the geometry in the specification.</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">        - current_geom_name (str): Name of the current geometry.</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">        - next_geom_name (str): Name of the next geometry to align with.</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">        Returns:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a><span class="sd">        - float: The angle in radians for the alignment.</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="k">def</span> <span class="nf">tangent_points</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">):</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">            Compute the tangent points on a circle centered at (cx, cy) with radius r</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a><span class="sd">            from an external point (px, py).</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a><span class="sd">            Parameters</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a><span class="sd">            ----------</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a><span class="sd">            cx, cy : float</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a><span class="sd">                Circle center coordinates.</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a><span class="sd">            r : float</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a><span class="sd">                Circle radius.</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a><span class="sd">            px, py : float</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a><span class="sd">                External point coordinates.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a><span class="sd">            Returns</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a><span class="sd">            -------</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a><span class="sd">            tuple</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a><span class="sd">                Coordinates of the two tangent points as (t1, t2), where t1 and t2</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a><span class="sd">                are (x, y) tuples.</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="c1"># Translate the circle center and point to local coordinates</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">])</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>            <span class="n">local_p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">c</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>            <span class="c1"># Compute tangent points in local coordinates</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>            <span class="n">d0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">local_p</span><span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>            <span class="k">if</span> <span class="n">d0</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                    <span class="s2">&quot;Point must be outside the circle for tangent lines to exist.&quot;</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                <span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>            <span class="n">i1_local</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">local_p</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>                <span class="n">d0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">local_p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">local_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="n">i2_local</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">local_p</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                <span class="n">d0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>            <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">local_p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">local_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="c1"># Transform tangent points back to global coordinates</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="n">i1_local</span> <span class="o">+</span> <span class="n">c</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="n">t2</span> <span class="o">=</span> <span class="n">i2_local</span> <span class="o">+</span> <span class="n">c</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>            <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>        <span class="k">def</span> <span class="nf">angle_between_vectors</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;ccw&quot;</span><span class="p">):</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">            Compute the angle between two 2D vectors in the specified direction.</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">            Parameters</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">            ----------</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="sd">            u, v : array-like</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a><span class="sd">                Input 2D vectors.</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a><span class="sd">            direction : str, optional</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a><span class="sd">                Direction of the angle, either &quot;ccw&quot; (counterclockwise) or &quot;cw&quot; (clockwise).</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a><span class="sd">                Default is &quot;ccw&quot;.</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a><span class="sd">            Returns</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a><span class="sd">            -------</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a><span class="sd">            float</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a><span class="sd">                Angle in radians (0 to 2π) in the specified direction.</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a><span class="sd">            Raises</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a><span class="sd">            ------</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a><span class="sd">            ValueError</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a><span class="sd">                If the `direction` is not &quot;ccw&quot; or &quot;cw&quot;.</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>            <span class="c1"># Normalize the vectors</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>            <span class="c1"># Dot product and cross product (z-component only)</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>            <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>            <span class="n">cross</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>            <span class="c1"># Compute the unsigned angle using the dot product</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>  <span class="c1"># Clip for numerical stability</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>            <span class="c1"># Adjust for the specified direction</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>            <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>                <span class="k">if</span> <span class="n">cross</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Negative cross-product means CW direction</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                    <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">angle</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;cw&quot;</span><span class="p">:</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>                <span class="k">if</span> <span class="n">cross</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Positive cross-product means CCW direction</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>                    <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">angle</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>                    <span class="sa">f</span><span class="s2">&quot;Invalid direction: </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">. Must be &#39;ccw&#39; or &#39;cw&#39;.&quot;</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>                <span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>            <span class="k">return</span> <span class="n">angle</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">current_geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">next_geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span><span class="o">.</span><span class="n">t</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">tangent_points</span><span class="p">(</span><span class="n">cx</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cy</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">px</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">py</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a>        <span class="n">v1</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a>        <span class="n">v2</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a>        <span class="n">theta1</span> <span class="o">=</span> <span class="n">angle_between_vectors</span><span class="p">(</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>            <span class="n">u</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">geom_indx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>        <span class="p">)</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a>        <span class="n">theta2</span> <span class="o">=</span> <span class="n">angle_between_vectors</span><span class="p">(</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a>            <span class="n">u</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">geom_indx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>        <span class="p">)</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a>        <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">)</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a>        <span class="k">return</span> <span class="n">theta</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>    <span class="k">def</span> <span class="nf">rotate_about</span><span class="p">(</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>        <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>        <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>        <span class="n">phi</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>        <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a><span class="sd">        Generate a pose rotating the TCP relative to a specified geometry.</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a><span class="sd">        Parameters:</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a><span class="sd">        - geom_name (str): Name of the geometry to rotate around.</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a><span class="sd">        - dir (str): Direction of rotation, &quot;ccw&quot; for counterclockwise or &quot;cw&quot; for clockwise.</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a><span class="sd">        - phi (float): Angle of rotation in radians.</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a><span class="sd">        - n_steps (int): Number of steps in the trajectory.</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a><span class="sd">        Returns:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a><span class="sd">        - sm.SE3: Rotated pose.</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>        <span class="n">c_traj</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_w_tcp</span><span class="p">]</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="n">phi</span> <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span> <span class="k">else</span> <span class="n">phi</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>        <span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">):</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>            <span class="n">T_tcp_geom</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span> <span class="o">*</span> <span class="n">T_w_tcp</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>            <span class="n">Rz</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>            <span class="n">T_w_tcp_new</span> <span class="o">=</span> <span class="n">T_w_geom</span> <span class="o">*</span> <span class="n">Rz</span> <span class="o">*</span> <span class="n">T_tcp_geom</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>            <span class="n">c_traj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T_w_tcp_new</span><span class="p">)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>        <span class="k">return</span> <span class="n">c_traj</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>    <span class="k">def</span> <span class="nf">opp1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a><span class="sd">        Generate a Cartesian pose from the end effector pose to a new pose above an obstacle.</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a><span class="sd">        Parameters:</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a><span class="sd">        - h (float): Height offset above the obstacle.</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a><span class="sd">        - geom_name (str): Name of the obstacle geometry.</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a><span class="sd">        Returns:</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a><span class="sd">        - sm.SE3: Target pose above the obstacle.</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>        <span class="n">Tz</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Tz</span><span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>        <span class="n">T_w_up</span> <span class="o">=</span> <span class="n">Tz</span> <span class="o">@</span> <span class="n">T_w_tcp</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>        <span class="c1"># T = ctraj(T_start=T_w_tcp, T_end=T_world_up, t=n_steps)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>        <span class="c1"># # T = rtb.ctraj(T0=T_world_tcp, T1=T_world_up, t=n_steps)</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>        <span class="c1"># poses.extend(T)</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>        <span class="c1"># return poses</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>        <span class="k">return</span> <span class="n">T_w_up</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>    <span class="k">def</span> <span class="nf">opp2</span><span class="p">(</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a><span class="sd">        Generate a Cartesian pose rotated theta raltive to some obstacle.</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a><span class="sd">        Parameters:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a><span class="sd">        - theta (float): Angle of rotation in radians.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a><span class="sd">        - dir (str): Direction of rotation, &quot;ccw&quot; or &quot;cw&quot;.</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a><span class="sd">        - geom_name (str): Name of the obstacle geometry.</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a><span class="sd">        Returns:</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a><span class="sd">        - sm.SE3: Target pose after the rotation.</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="k">elif</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;cw&quot;</span><span class="p">:</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dir must be either &quot;ccw&quot; or &quot;cw&quot;, but &quot;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">&quot; was given&#39;</span><span class="p">)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>        <span class="c1"># angle to slign axis with direction towards obstacle</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>        <span class="k">def</span> <span class="nf">get_phi</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>            <span class="n">tcp_y</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">tcp_y</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>            <span class="k">return</span> <span class="n">angle</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>        <span class="c1"># the angle to correct the direction and the deviation angle theta</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="n">theta</span> <span class="o">=</span> <span class="n">get_phi</span><span class="p">()</span> <span class="o">+</span> <span class="n">theta</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="k">return</span> <span class="n">T_w_tcp</span> <span class="o">@</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>    <span class="k">def</span> <span class="nf">opp3</span><span class="p">(</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>        <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>        <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a><span class="sd">        Compute a target pose for the robot&#39;s end-effector based on positional and rotational offsets.</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a><span class="sd">        Parameters</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a><span class="sd">        ----------</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a><span class="sd">        delta : float</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a><span class="sd">            Distance offset from the current end-effector position towards the target geometry in the xy-plane.</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a><span class="sd">        theta : float</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a><span class="sd">            Angle of rotation around the z-axis (in radians).</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a><span class="sd">        dir : str</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a><span class="sd">            Direction of rotation (&quot;ccw&quot; for counterclockwise, any other value for clockwise).</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a><span class="sd">        geom_name : str</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a><span class="sd">            Name of the target geometry to compute the offset and rotation with respect to.</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a><span class="sd">        T_init : sm.SE3, optional</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a><span class="sd">            Initial pose of the end-effector. If None, the current pose is fetched from the robot, by default None.</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a><span class="sd">        Returns</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a><span class="sd">        -------</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a><span class="sd">        sm.SE3</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a><span class="sd">            The computed target pose in the world frame.</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>        <span class="n">t_tcp_geom</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>        <span class="n">t_tcp_geom_norm</span> <span class="o">=</span> <span class="n">t_tcp_geom</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t_tcp_geom</span><span class="p">)</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>        <span class="n">t_tcp_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_tcp_geom_norm</span><span class="p">))</span> <span class="o">+</span> <span class="n">t_tcp_geom</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="n">t_tcp_target_rot</span> <span class="o">=</span> <span class="n">rotate_vector_2d</span><span class="p">(</span><span class="n">t_tcp_target</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_tcp_target_rot</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        <span class="n">rz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">0</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        <span class="p">)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>            <span class="n">rx</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>        <span class="n">ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rz</span><span class="p">,</span> <span class="n">rx</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rz</span><span class="p">,</span> <span class="n">rx</span><span class="p">))</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">))</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>            <span class="n">ry</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">))</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>        <span class="n">T_w_target</span> <span class="o">=</span> <span class="n">make_tf</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>        <span class="k">return</span> <span class="n">T_w_target</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>    <span class="k">def</span> <span class="nf">opp4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_height</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a><span class="sd">        Compute a target pose for the robot&#39;s end-effector with a specified z-height.</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a><span class="sd">        Parameters</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a><span class="sd">        ----------</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a><span class="sd">        z_height : float</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a><span class="sd">            Desired height (z-coordinate) for the end-effector in the world frame.</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a><span class="sd">        T_init : sm.SE3, optional</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a><span class="sd">            Initial pose of the end-effector. If None, the current pose is fetched from the robot, by default None.</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a><span class="sd">        Returns</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a><span class="sd">        -------</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a><span class="sd">        sm.SE3</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a><span class="sd">            The computed target pose with the specified z-height.</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Make a copy of the translation vector</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>        <span class="n">end_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_height</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>        <span class="n">T_target</span> <span class="o">=</span> <span class="n">make_tf</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">end_pos</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>        <span class="k">return</span> <span class="n">T_target</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>    <span class="n">sim</span> <span class="o">=</span> <span class="n">MjSim</span><span class="p">()</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>    <span class="n">sim</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</span></pre></div>


            </section>
                <section id="Gripper">
                            <input id="Gripper-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Gripper</span><wbr>(<span class="base"><a href="../robots/base_robot.html#BaseRobot">robots.base_robot.BaseRobot</a></span>):

                <label class="view-source-button" for="Gripper-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Gripper"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Gripper-20"><a href="#Gripper-20"><span class="linenos">20</span></a><span class="k">class</span> <span class="nc">Gripper</span><span class="p">(</span><span class="n">BaseRobot</span><span class="p">):</span>
</span><span id="Gripper-21"><a href="#Gripper-21"><span class="linenos">21</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">):</span>
</span><span id="Gripper-22"><a href="#Gripper-22"><span class="linenos">22</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Gripper-23"><a href="#Gripper-23"><span class="linenos">23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="Gripper-24"><a href="#Gripper-24"><span class="linenos">24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="Gripper-25"><a href="#Gripper-25"><span class="linenos">25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="n">RobotInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="Gripper-26"><a href="#Gripper-26"><span class="linenos">26</span></a>
</span><span id="Gripper-27"><a href="#Gripper-27"><span class="linenos">27</span></a>    <span class="nd">@property</span>
</span><span id="Gripper-28"><a href="#Gripper-28"><span class="linenos">28</span></a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Gripper-29"><a href="#Gripper-29"><span class="linenos">29</span></a>        <span class="k">return</span> <span class="s2">&quot;panda hand&quot;</span>
</span><span id="Gripper-30"><a href="#Gripper-30"><span class="linenos">30</span></a>
</span><span id="Gripper-31"><a href="#Gripper-31"><span class="linenos">31</span></a>    <span class="k">def</span> <span class="nf">get_ee_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="Gripper-32"><a href="#Gripper-32"><span class="linenos">32</span></a>        <span class="k">return</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tcp&quot;</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">SITE</span><span class="p">)</span>
</span><span id="Gripper-33"><a href="#Gripper-33"><span class="linenos">33</span></a>
</span><span id="Gripper-34"><a href="#Gripper-34"><span class="linenos">34</span></a>    <span class="nd">@property</span>
</span><span id="Gripper-35"><a href="#Gripper-35"><span class="linenos">35</span></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">:</span>
</span><span id="Gripper-36"><a href="#Gripper-36"><span class="linenos">36</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span><span id="Gripper-37"><a href="#Gripper-37"><span class="linenos">37</span></a>
</span><span id="Gripper-38"><a href="#Gripper-38"><span class="linenos">38</span></a>    <span class="nd">@property</span>
</span><span id="Gripper-39"><a href="#Gripper-39"><span class="linenos">39</span></a>    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="p">:</span>
</span><span id="Gripper-40"><a href="#Gripper-40"><span class="linenos">40</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</span><span id="Gripper-41"><a href="#Gripper-41"><span class="linenos">41</span></a>
</span><span id="Gripper-42"><a href="#Gripper-42"><span class="linenos">42</span></a>    <span class="nd">@property</span>
</span><span id="Gripper-43"><a href="#Gripper-43"><span class="linenos">43</span></a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RobotInfo</span><span class="p">:</span>
</span><span id="Gripper-44"><a href="#Gripper-44"><span class="linenos">44</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span>
</span><span id="Gripper-45"><a href="#Gripper-45"><span class="linenos">45</span></a>
</span><span id="Gripper-46"><a href="#Gripper-46"><span class="linenos">46</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Gripper-47"><a href="#Gripper-47"><span class="linenos">47</span></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Base class for robot simulation in MuJoCo.</p>

<p>This class provides a framework for simulating robots in MuJoCo environments. It defines
key properties and methods that should be implemented in child classes, including access
to the robot's model, data, and control mechanisms.</p>
</div>


                            <div id="Gripper.__init__" class="classattr">
                                        <input id="Gripper.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Gripper</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">model</span><span class="p">:</span> <span class="n">mujoco</span><span class="o">.</span><span class="n">_structs</span><span class="o">.</span><span class="n">MjModel</span>, </span><span class="param"><span class="n">data</span><span class="p">:</span> <span class="n">mujoco</span><span class="o">.</span><span class="n">_structs</span><span class="o">.</span><span class="n">MjData</span></span>)</span>

                <label class="view-source-button" for="Gripper.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Gripper.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Gripper.__init__-21"><a href="#Gripper.__init__-21"><span class="linenos">21</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">):</span>
</span><span id="Gripper.__init__-22"><a href="#Gripper.__init__-22"><span class="linenos">22</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="Gripper.__init__-23"><a href="#Gripper.__init__-23"><span class="linenos">23</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
</span><span id="Gripper.__init__-24"><a href="#Gripper.__init__-24"><span class="linenos">24</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="Gripper.__init__-25"><a href="#Gripper.__init__-25"><span class="linenos">25</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_info</span> <span class="o">=</span> <span class="n">RobotInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Gripper.name" class="classattr">
                                        <input id="Gripper.name-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">name</span><span class="annotation">: str</span>

                <label class="view-source-button" for="Gripper.name-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Gripper.name"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Gripper.name-27"><a href="#Gripper.name-27"><span class="linenos">27</span></a>    <span class="nd">@property</span>
</span><span id="Gripper.name-28"><a href="#Gripper.name-28"><span class="linenos">28</span></a>    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Gripper.name-29"><a href="#Gripper.name-29"><span class="linenos">29</span></a>        <span class="k">return</span> <span class="s2">&quot;panda hand&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Get the name of the robot.</p>

<p>This property returns the name of the robot as a string. The name is typically a unique identifier
used to distinguish between different robots in the simulation environment.</p>

<h2 id="returns">Returns</h2>

<p>str
    The name of the robot as a string.</p>
</div>


                            </div>
                            <div id="Gripper.get_ee_pose" class="classattr">
                                        <input id="Gripper.get_ee_pose-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_ee_pose</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span>:</span></span>

                <label class="view-source-button" for="Gripper.get_ee_pose-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Gripper.get_ee_pose"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Gripper.get_ee_pose-31"><a href="#Gripper.get_ee_pose-31"><span class="linenos">31</span></a>    <span class="k">def</span> <span class="nf">get_ee_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="Gripper.get_ee_pose-32"><a href="#Gripper.get_ee_pose-32"><span class="linenos">32</span></a>        <span class="k">return</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/tcp&quot;</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">SITE</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="Gripper.data" class="classattr">
                                        <input id="Gripper.data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">data</span><span class="annotation">: mujoco._structs.MjData</span>

                <label class="view-source-button" for="Gripper.data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Gripper.data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Gripper.data-34"><a href="#Gripper.data-34"><span class="linenos">34</span></a>    <span class="nd">@property</span>
</span><span id="Gripper.data-35"><a href="#Gripper.data-35"><span class="linenos">35</span></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">:</span>
</span><span id="Gripper.data-36"><a href="#Gripper.data-36"><span class="linenos">36</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span></pre></div>


            <div class="docstring"><p>Access the current simulation data.</p>

<p>This property provides access to an instance of the <code>MjData</code> class, which contains the dynamic
simulation state. This includes quantities such as joint positions, velocities,
actuator forces, and sensory information. The <code>MjData</code> object is updated at each simulation step
and can be used to inspect the real-time state of the robot during the simulation.</p>

<h2 id="returns">Returns</h2>

<p>mj.MjData
    An object representing the current dynamic state of the simulation.</p>
</div>


                            </div>
                            <div id="Gripper.model" class="classattr">
                                        <input id="Gripper.model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">model</span><span class="annotation">: mujoco._structs.MjModel</span>

                <label class="view-source-button" for="Gripper.model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Gripper.model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Gripper.model-38"><a href="#Gripper.model-38"><span class="linenos">38</span></a>    <span class="nd">@property</span>
</span><span id="Gripper.model-39"><a href="#Gripper.model-39"><span class="linenos">39</span></a>    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="p">:</span>
</span><span id="Gripper.model-40"><a href="#Gripper.model-40"><span class="linenos">40</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</span></pre></div>


            <div class="docstring"><p>Access the model of the MuJoCo simulation.</p>

<p>This property returns an instance of the <code>MjModel</code> class, which describes the physical and
mechanical properties of the simulation. The <code>MjModel</code> object contains static information about the
robot such as its kinematic tree, inertial properties, joint and actuator definitions, and geometry
configurations. It is used to define the robot's structure and behavior within the simulation.</p>

<h2 id="returns">Returns</h2>

<p>mj.MjModel
    An object representing the static model of the robot and overall MuJoCo simulation.</p>
</div>


                            </div>
                            <div id="Gripper.info" class="classattr">
                                        <input id="Gripper.info-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">info</span><span class="annotation">: <a href="../utils/mj.html#RobotInfo">utils.mj.RobotInfo</a></span>

                <label class="view-source-button" for="Gripper.info-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Gripper.info"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Gripper.info-42"><a href="#Gripper.info-42"><span class="linenos">42</span></a>    <span class="nd">@property</span>
</span><span id="Gripper.info-43"><a href="#Gripper.info-43"><span class="linenos">43</span></a>    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RobotInfo</span><span class="p">:</span>
</span><span id="Gripper.info-44"><a href="#Gripper.info-44"><span class="linenos">44</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_info</span>
</span></pre></div>


            <div class="docstring"><p>Get detailed information about the robot.</p>

<p>This property returns an instance of the <code>RobotInfo</code> class, which provides comprehensive
details about the robot's structure and components. This includes information on the robot's
bodies, joints, actuators, and geometries, among other attributes. The <code>RobotInfo</code> instance
can be used to access various properties such as the number of joints, actuator limits, joint
limits, and more.</p>

<h2 id="returns">Returns</h2>

<p>RobotInfo
    An object containing detailed information about the robot's configuration and components.</p>
</div>


                            </div>
                            <div id="Gripper.step" class="classattr">
                                        <input id="Gripper.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Gripper.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Gripper.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Gripper.step-46"><a href="#Gripper.step-46"><span class="linenos">46</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Gripper.step-47"><a href="#Gripper.step-47"><span class="linenos">47</span></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Perform a step in the controller.</p>

<p>This method calls the <code><a href="#Gripper.step">step()</a></code> method of the controller object and
before doing so it checks if there are any tasks to be performed in
the robot task queue</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="../robots/base_robot.html#BaseRobot">robots.base_robot.BaseRobot</a></dt>
                                <dd id="Gripper.set_ctrl" class="function"><a href="../robots/base_robot.html#BaseRobot.set_ctrl">set_ctrl</a></dd>
                <dd id="Gripper.ctrl" class="variable"><a href="../robots/base_robot.html#BaseRobot.ctrl">ctrl</a></dd>
                <dd id="Gripper.Jp" class="variable"><a href="../robots/base_robot.html#BaseRobot.Jp">Jp</a></dd>
                <dd id="Gripper.Jo" class="variable"><a href="../robots/base_robot.html#BaseRobot.Jo">Jo</a></dd>
                <dd id="Gripper.J" class="variable"><a href="../robots/base_robot.html#BaseRobot.J">J</a></dd>
                <dd id="Gripper.c" class="variable"><a href="../robots/base_robot.html#BaseRobot.c">c</a></dd>
                <dd id="Gripper.Mq" class="variable"><a href="../robots/base_robot.html#BaseRobot.Mq">Mq</a></dd>
                <dd id="Gripper.Mx" class="variable"><a href="../robots/base_robot.html#BaseRobot.Mx">Mx</a></dd>
                <dd id="Gripper.q" class="variable"><a href="../robots/base_robot.html#BaseRobot.q">q</a></dd>
                <dd id="Gripper.dq" class="variable"><a href="../robots/base_robot.html#BaseRobot.dq">dq</a></dd>
                <dd id="Gripper.ddq" class="variable"><a href="../robots/base_robot.html#BaseRobot.ddq">ddq</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="MjSim">
                            <input id="MjSim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MjSim</span><wbr>(<span class="base"><a href="base_sim.html#BaseSim">sims.base_sim.BaseSim</a></span>):

                <label class="view-source-button" for="MjSim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim-50"><a href="#MjSim-50"><span class="linenos"> 50</span></a><span class="k">class</span> <span class="nc">MjSim</span><span class="p">(</span><span class="n">BaseSim</span><span class="p">):</span>
</span><span id="MjSim-51"><a href="#MjSim-51"><span class="linenos"> 51</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MjSim-52"><a href="#MjSim-52"><span class="linenos"> 52</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="MjSim-53"><a href="#MjSim-53"><span class="linenos"> 53</span></a>
</span><span id="MjSim-54"><a href="#MjSim-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</span><span id="MjSim-55"><a href="#MjSim-55"><span class="linenos"> 55</span></a>
</span><span id="MjSim-56"><a href="#MjSim-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span> <span class="o">=</span> <span class="n">Gripper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>
</span><span id="MjSim-57"><a href="#MjSim-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span> <span class="o">=</span> <span class="n">Mocap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</span><span id="MjSim-58"><a href="#MjSim-58"><span class="linenos"> 58</span></a>
</span><span id="MjSim-59"><a href="#MjSim-59"><span class="linenos"> 59</span></a>        <span class="n">T_w_mocap</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;mocap_site&quot;</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">SITE</span><span class="p">)</span>
</span><span id="MjSim-60"><a href="#MjSim-60"><span class="linenos"> 60</span></a>        <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>
</span><span id="MjSim-61"><a href="#MjSim-61"><span class="linenos"> 61</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span> <span class="o">=</span> <span class="n">T_w_mocap</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span> <span class="o">@</span> <span class="n">T_w_tcp</span>
</span><span id="MjSim-62"><a href="#MjSim-62"><span class="linenos"> 62</span></a>
</span><span id="MjSim-63"><a href="#MjSim-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="MjSim-64"><a href="#MjSim-64"><span class="linenos"> 64</span></a>            <span class="s2">&quot;o0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;task_board/wire_washer_3&quot;</span><span class="p">,</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span> <span class="s2">&quot;ccw&quot;</span><span class="p">},</span>
</span><span id="MjSim-65"><a href="#MjSim-65"><span class="linenos"> 65</span></a>            <span class="s2">&quot;o1&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;task_board/wire_washer_2&quot;</span><span class="p">,</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span> <span class="s2">&quot;cw&quot;</span><span class="p">},</span>
</span><span id="MjSim-66"><a href="#MjSim-66"><span class="linenos"> 66</span></a>            <span class="s2">&quot;o2&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;task_board/wire_washer_1&quot;</span><span class="p">,</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span> <span class="s2">&quot;ccw&quot;</span><span class="p">},</span>
</span><span id="MjSim-67"><a href="#MjSim-67"><span class="linenos"> 67</span></a>        <span class="p">}</span>
</span><span id="MjSim-68"><a href="#MjSim-68"><span class="linenos"> 68</span></a>
</span><span id="MjSim-69"><a href="#MjSim-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spin</span><span class="p">]</span>
</span><span id="MjSim-70"><a href="#MjSim-70"><span class="linenos"> 70</span></a>        <span class="c1"># self.tasks = [self.spin, self.weaving]</span>
</span><span id="MjSim-71"><a href="#MjSim-71"><span class="linenos"> 71</span></a>
</span><span id="MjSim-72"><a href="#MjSim-72"><span class="linenos"> 72</span></a>        <span class="n">load_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;unnamed_model/s0_1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span><span id="MjSim-73"><a href="#MjSim-73"><span class="linenos"> 73</span></a>
</span><span id="MjSim-74"><a href="#MjSim-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="mf">0.05</span>
</span><span id="MjSim-75"><a href="#MjSim-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span><span id="MjSim-76"><a href="#MjSim-76"><span class="linenos"> 76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="MjSim-77"><a href="#MjSim-77"><span class="linenos"> 77</span></a>
</span><span id="MjSim-78"><a href="#MjSim-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">begin</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="MjSim-79"><a href="#MjSim-79"><span class="linenos"> 79</span></a>
</span><span id="MjSim-80"><a href="#MjSim-80"><span class="linenos"> 80</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MjSim-81"><a href="#MjSim-81"><span class="linenos"> 81</span></a>        <span class="c1"># root</span>
</span><span id="MjSim-82"><a href="#MjSim-82"><span class="linenos"> 82</span></a>        <span class="n">_HERE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
</span><span id="MjSim-83"><a href="#MjSim-83"><span class="linenos"> 83</span></a>
</span><span id="MjSim-84"><a href="#MjSim-84"><span class="linenos"> 84</span></a>        <span class="c1"># create keyframe file</span>
</span><span id="MjSim-85"><a href="#MjSim-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span><span class="p">,</span> <span class="s2">&quot;keyframes&quot;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.xml&quot;</span><span class="p">)</span>
</span><span id="MjSim-86"><a href="#MjSim-86"><span class="linenos"> 86</span></a>
</span><span id="MjSim-87"><a href="#MjSim-87"><span class="linenos"> 87</span></a>        <span class="c1"># Ensure the parent directory exists</span>
</span><span id="MjSim-88"><a href="#MjSim-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MjSim-89"><a href="#MjSim-89"><span class="linenos"> 89</span></a>
</span><span id="MjSim-90"><a href="#MjSim-90"><span class="linenos"> 90</span></a>        <span class="c1"># Create an empty file if it doesn&#39;t exist</span>
</span><span id="MjSim-91"><a href="#MjSim-91"><span class="linenos"> 91</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="MjSim-92"><a href="#MjSim-92"><span class="linenos"> 92</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
</span><span id="MjSim-93"><a href="#MjSim-93"><span class="linenos"> 93</span></a>            <span class="c1"># Define the XML content you want to append</span>
</span><span id="MjSim-94"><a href="#MjSim-94"><span class="linenos"> 94</span></a>            <span class="n">xml_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="MjSim-95"><a href="#MjSim-95"><span class="linenos"> 95</span></a><span class="s2">            &lt;mujoco&gt;</span>
</span><span id="MjSim-96"><a href="#MjSim-96"><span class="linenos"> 96</span></a><span class="s2">            &lt;/mujoco&gt;</span>
</span><span id="MjSim-97"><a href="#MjSim-97"><span class="linenos"> 97</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="MjSim-98"><a href="#MjSim-98"><span class="linenos"> 98</span></a>            <span class="c1"># Open the file in append mode and write the XML content</span>
</span><span id="MjSim-99"><a href="#MjSim-99"><span class="linenos"> 99</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="MjSim-100"><a href="#MjSim-100"><span class="linenos">100</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xml_content</span><span class="p">)</span>
</span><span id="MjSim-101"><a href="#MjSim-101"><span class="linenos">101</span></a>
</span><span id="MjSim-102"><a href="#MjSim-102"><span class="linenos">102</span></a>            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span><span id="MjSim-103"><a href="#MjSim-103"><span class="linenos">103</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-104"><a href="#MjSim-104"><span class="linenos">104</span></a>            <span class="c1"># find keyframes file and load in</span>
</span><span id="MjSim-105"><a href="#MjSim-105"><span class="linenos">105</span></a>            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span><span id="MjSim-106"><a href="#MjSim-106"><span class="linenos">106</span></a>
</span><span id="MjSim-107"><a href="#MjSim-107"><span class="linenos">107</span></a>        <span class="c1"># scene path</span>
</span><span id="MjSim-108"><a href="#MjSim-108"><span class="linenos">108</span></a>        <span class="n">_XML_SCENE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;scenes/empty.xml&quot;</span><span class="p">)</span>
</span><span id="MjSim-109"><a href="#MjSim-109"><span class="linenos">109</span></a>        <span class="n">scene</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_SCENE</span><span class="p">)</span>
</span><span id="MjSim-110"><a href="#MjSim-110"><span class="linenos">110</span></a>
</span><span id="MjSim-111"><a href="#MjSim-111"><span class="linenos">111</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">keyframe</span><span class="p">)</span>
</span><span id="MjSim-112"><a href="#MjSim-112"><span class="linenos">112</span></a>
</span><span id="MjSim-113"><a href="#MjSim-113"><span class="linenos">113</span></a>        <span class="c1"># panda path</span>
</span><span id="MjSim-114"><a href="#MjSim-114"><span class="linenos">114</span></a>        <span class="n">_XML_PANDA</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/franka_emika_panda/hand.xml&quot;</span><span class="p">)</span>
</span><span id="MjSim-115"><a href="#MjSim-115"><span class="linenos">115</span></a>        <span class="c1"># _XML_panda = Path(_HERE / &quot;assets/robotiq_panda/panda-gs.xml&quot;)</span>
</span><span id="MjSim-116"><a href="#MjSim-116"><span class="linenos">116</span></a>        <span class="n">panda_hand</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_PANDA</span><span class="p">)</span>
</span><span id="MjSim-117"><a href="#MjSim-117"><span class="linenos">117</span></a>
</span><span id="MjSim-118"><a href="#MjSim-118"><span class="linenos">118</span></a>        <span class="n">mocap_body</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="MjSim-119"><a href="#MjSim-119"><span class="linenos">119</span></a>            <span class="s2">&quot;body&quot;</span><span class="p">,</span>
</span><span id="MjSim-120"><a href="#MjSim-120"><span class="linenos">120</span></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mocap&quot;</span><span class="p">,</span>
</span><span id="MjSim-121"><a href="#MjSim-121"><span class="linenos">121</span></a>            <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;0 0 0.1&quot;</span><span class="p">,</span>
</span><span id="MjSim-122"><a href="#MjSim-122"><span class="linenos">122</span></a>            <span class="n">mocap</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span id="MjSim-123"><a href="#MjSim-123"><span class="linenos">123</span></a>        <span class="p">)</span>
</span><span id="MjSim-124"><a href="#MjSim-124"><span class="linenos">124</span></a>        <span class="n">mocap_body</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="MjSim-125"><a href="#MjSim-125"><span class="linenos">125</span></a>            <span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;0.01 0.01 0.01&quot;</span><span class="p">,</span> <span class="n">contype</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">conaffinity</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
</span><span id="MjSim-126"><a href="#MjSim-126"><span class="linenos">126</span></a>        <span class="p">)</span>
</span><span id="MjSim-127"><a href="#MjSim-127"><span class="linenos">127</span></a>        <span class="n">mocap_site</span> <span class="o">=</span> <span class="n">mocap_body</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mocap_site&quot;</span><span class="p">)</span>
</span><span id="MjSim-128"><a href="#MjSim-128"><span class="linenos">128</span></a>
</span><span id="MjSim-129"><a href="#MjSim-129"><span class="linenos">129</span></a>        <span class="n">mocap_site</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">panda_hand</span><span class="p">)</span>
</span><span id="MjSim-130"><a href="#MjSim-130"><span class="linenos">130</span></a>
</span><span id="MjSim-131"><a href="#MjSim-131"><span class="linenos">131</span></a>        <span class="c1"># rgmc practice board</span>
</span><span id="MjSim-132"><a href="#MjSim-132"><span class="linenos">132</span></a>        <span class="n">_XML_BOARD</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
</span><span id="MjSim-133"><a href="#MjSim-133"><span class="linenos">133</span></a>            <span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/rgmc_practice_task_board_2020/task_board_mjx.xml&quot;</span>
</span><span id="MjSim-134"><a href="#MjSim-134"><span class="linenos">134</span></a>        <span class="p">)</span>
</span><span id="MjSim-135"><a href="#MjSim-135"><span class="linenos">135</span></a>        <span class="n">board</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_BOARD</span><span class="p">)</span>
</span><span id="MjSim-136"><a href="#MjSim-136"><span class="linenos">136</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
</span><span id="MjSim-137"><a href="#MjSim-137"><span class="linenos">137</span></a>
</span><span id="MjSim-138"><a href="#MjSim-138"><span class="linenos">138</span></a>        <span class="c1"># table</span>
</span><span id="MjSim-139"><a href="#MjSim-139"><span class="linenos">139</span></a>        <span class="n">_XML_TABLE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/props/flexcell_top.xml&quot;</span><span class="p">)</span>
</span><span id="MjSim-140"><a href="#MjSim-140"><span class="linenos">140</span></a>        <span class="n">table</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_TABLE</span><span class="p">)</span>
</span><span id="MjSim-141"><a href="#MjSim-141"><span class="linenos">141</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</span><span id="MjSim-142"><a href="#MjSim-142"><span class="linenos">142</span></a>
</span><span id="MjSim-143"><a href="#MjSim-143"><span class="linenos">143</span></a>        <span class="c1"># cable</span>
</span><span id="MjSim-144"><a href="#MjSim-144"><span class="linenos">144</span></a>        <span class="n">_XML_CABLE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/props/cable.xml&quot;</span><span class="p">)</span>
</span><span id="MjSim-145"><a href="#MjSim-145"><span class="linenos">145</span></a>        <span class="n">cable</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_CABLE</span><span class="p">)</span>
</span><span id="MjSim-146"><a href="#MjSim-146"><span class="linenos">146</span></a>
</span><span id="MjSim-147"><a href="#MjSim-147"><span class="linenos">147</span></a>        <span class="n">cable_body</span> <span class="o">=</span> <span class="n">cable</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;cable&quot;</span><span class="p">)</span>
</span><span id="MjSim-148"><a href="#MjSim-148"><span class="linenos">148</span></a>        <span class="n">cable_body</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.67521462</span><span class="p">,</span> <span class="mf">0.27162106</span><span class="p">,</span> <span class="mf">0.08657647</span><span class="p">]</span>
</span><span id="MjSim-149"><a href="#MjSim-149"><span class="linenos">149</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">cable</span><span class="p">)</span>
</span><span id="MjSim-150"><a href="#MjSim-150"><span class="linenos">150</span></a>
</span><span id="MjSim-151"><a href="#MjSim-151"><span class="linenos">151</span></a>        <span class="c1"># add pseudo fingers</span>
</span><span id="MjSim-152"><a href="#MjSim-152"><span class="linenos">152</span></a>        <span class="n">rf</span> <span class="o">=</span> <span class="n">panda_hand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;right_finger&quot;</span><span class="p">)</span>
</span><span id="MjSim-153"><a href="#MjSim-153"><span class="linenos">153</span></a>        <span class="n">rf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="MjSim-154"><a href="#MjSim-154"><span class="linenos">154</span></a>            <span class="s2">&quot;geom&quot;</span><span class="p">,</span>
</span><span id="MjSim-155"><a href="#MjSim-155"><span class="linenos">155</span></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;right_finger&quot;</span><span class="p">,</span>
</span><span id="MjSim-156"><a href="#MjSim-156"><span class="linenos">156</span></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span>
</span><span id="MjSim-157"><a href="#MjSim-157"><span class="linenos">157</span></a>            <span class="n">size</span><span class="o">=</span><span class="s2">&quot;0.01 0.02 0.01&quot;</span><span class="p">,</span>
</span><span id="MjSim-158"><a href="#MjSim-158"><span class="linenos">158</span></a>            <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;0 0.02 0.1&quot;</span><span class="p">,</span>
</span><span id="MjSim-159"><a href="#MjSim-159"><span class="linenos">159</span></a>            <span class="n">axisangle</span><span class="o">=</span><span class="s2">&quot;1 0 0 -1&quot;</span><span class="p">,</span>
</span><span id="MjSim-160"><a href="#MjSim-160"><span class="linenos">160</span></a>            <span class="n">solref</span><span class="o">=</span><span class="s2">&quot;0.000000001 1&quot;</span><span class="p">,</span>
</span><span id="MjSim-161"><a href="#MjSim-161"><span class="linenos">161</span></a>            <span class="n">friction</span><span class="o">=</span><span class="s2">&quot;0.3 0.3 0.3&quot;</span><span class="p">,</span>
</span><span id="MjSim-162"><a href="#MjSim-162"><span class="linenos">162</span></a>            <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="MjSim-163"><a href="#MjSim-163"><span class="linenos">163</span></a>        <span class="p">)</span>
</span><span id="MjSim-164"><a href="#MjSim-164"><span class="linenos">164</span></a>        <span class="n">lf</span> <span class="o">=</span> <span class="n">panda_hand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;left_finger&quot;</span><span class="p">)</span>
</span><span id="MjSim-165"><a href="#MjSim-165"><span class="linenos">165</span></a>        <span class="n">lf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="MjSim-166"><a href="#MjSim-166"><span class="linenos">166</span></a>            <span class="s2">&quot;geom&quot;</span><span class="p">,</span>
</span><span id="MjSim-167"><a href="#MjSim-167"><span class="linenos">167</span></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;left_finger&quot;</span><span class="p">,</span>
</span><span id="MjSim-168"><a href="#MjSim-168"><span class="linenos">168</span></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span>
</span><span id="MjSim-169"><a href="#MjSim-169"><span class="linenos">169</span></a>            <span class="n">size</span><span class="o">=</span><span class="s2">&quot;0.01 0.02 0.01&quot;</span><span class="p">,</span>
</span><span id="MjSim-170"><a href="#MjSim-170"><span class="linenos">170</span></a>            <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;0 0.02 0.1&quot;</span><span class="p">,</span>
</span><span id="MjSim-171"><a href="#MjSim-171"><span class="linenos">171</span></a>            <span class="n">axisangle</span><span class="o">=</span><span class="s2">&quot;1 0 0 -1&quot;</span><span class="p">,</span>
</span><span id="MjSim-172"><a href="#MjSim-172"><span class="linenos">172</span></a>            <span class="n">solref</span><span class="o">=</span><span class="s2">&quot;0.000000001 1&quot;</span><span class="p">,</span>
</span><span id="MjSim-173"><a href="#MjSim-173"><span class="linenos">173</span></a>            <span class="n">friction</span><span class="o">=</span><span class="s2">&quot;0.3 0.3 0.3&quot;</span><span class="p">,</span>
</span><span id="MjSim-174"><a href="#MjSim-174"><span class="linenos">174</span></a>            <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="MjSim-175"><a href="#MjSim-175"><span class="linenos">175</span></a>        <span class="p">)</span>
</span><span id="MjSim-176"><a href="#MjSim-176"><span class="linenos">176</span></a>
</span><span id="MjSim-177"><a href="#MjSim-177"><span class="linenos">177</span></a>        <span class="n">board_body</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;task_board&quot;</span><span class="p">)</span>
</span><span id="MjSim-178"><a href="#MjSim-178"><span class="linenos">178</span></a>        <span class="n">board_body</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim-179"><a href="#MjSim-179"><span class="linenos">179</span></a>        <span class="n">wire_washer_3</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_washer_3&quot;</span><span class="p">)</span>
</span><span id="MjSim-180"><a href="#MjSim-180"><span class="linenos">180</span></a>        <span class="n">wire_washer_2</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_washer_2&quot;</span><span class="p">)</span>
</span><span id="MjSim-181"><a href="#MjSim-181"><span class="linenos">181</span></a>        <span class="n">wire_washer_1</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_washer_1&quot;</span><span class="p">)</span>
</span><span id="MjSim-182"><a href="#MjSim-182"><span class="linenos">182</span></a>        <span class="n">wire_bolt_3</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_bolt_3&quot;</span><span class="p">)</span>
</span><span id="MjSim-183"><a href="#MjSim-183"><span class="linenos">183</span></a>        <span class="n">wire_bolt_2</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_bolt_2&quot;</span><span class="p">)</span>
</span><span id="MjSim-184"><a href="#MjSim-184"><span class="linenos">184</span></a>        <span class="n">wire_bolt_1</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_bolt_1&quot;</span><span class="p">)</span>
</span><span id="MjSim-185"><a href="#MjSim-185"><span class="linenos">185</span></a>        <span class="n">wire_washer_3</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim-186"><a href="#MjSim-186"><span class="linenos">186</span></a>        <span class="n">wire_washer_2</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim-187"><a href="#MjSim-187"><span class="linenos">187</span></a>        <span class="n">wire_washer_1</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim-188"><a href="#MjSim-188"><span class="linenos">188</span></a>        <span class="n">wire_bolt_3</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim-189"><a href="#MjSim-189"><span class="linenos">189</span></a>        <span class="n">wire_bolt_2</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim-190"><a href="#MjSim-190"><span class="linenos">190</span></a>        <span class="n">wire_bolt_1</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim-191"><a href="#MjSim-191"><span class="linenos">191</span></a>
</span><span id="MjSim-192"><a href="#MjSim-192"><span class="linenos">192</span></a>        <span class="n">m</span> <span class="o">=</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="o">.</span><span class="n">from_xml_string</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">to_xml_string</span><span class="p">(),</span> <span class="n">scene</span><span class="o">.</span><span class="n">get_assets</span><span class="p">())</span>
</span><span id="MjSim-193"><a href="#MjSim-193"><span class="linenos">193</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span id="MjSim-194"><a href="#MjSim-194"><span class="linenos">194</span></a>
</span><span id="MjSim-195"><a href="#MjSim-195"><span class="linenos">195</span></a>        <span class="c1"># step once to compute the poses of objects</span>
</span><span id="MjSim-196"><a href="#MjSim-196"><span class="linenos">196</span></a>        <span class="n">mj</span><span class="o">.</span><span class="n">mj_step</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="MjSim-197"><a href="#MjSim-197"><span class="linenos">197</span></a>
</span><span id="MjSim-198"><a href="#MjSim-198"><span class="linenos">198</span></a>        <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span>
</span><span id="MjSim-199"><a href="#MjSim-199"><span class="linenos">199</span></a>
</span><span id="MjSim-200"><a href="#MjSim-200"><span class="linenos">200</span></a>    <span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ss</span><span class="p">:</span> <span class="n">SimSync</span><span class="p">):</span>
</span><span id="MjSim-201"><a href="#MjSim-201"><span class="linenos">201</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MjSim-202"><a href="#MjSim-202"><span class="linenos">202</span></a>            <span class="n">ss</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="MjSim-203"><a href="#MjSim-203"><span class="linenos">203</span></a>
</span><span id="MjSim-204"><a href="#MjSim-204"><span class="linenos">204</span></a>    <span class="k">def</span> <span class="nf">get_check_point_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">]:</span>
</span><span id="MjSim-205"><a href="#MjSim-205"><span class="linenos">205</span></a>        <span class="n">traj</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MjSim-206"><a href="#MjSim-206"><span class="linenos">206</span></a>        <span class="n">traj</span><span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>
</span><span id="MjSim-207"><a href="#MjSim-207"><span class="linenos">207</span></a>
</span><span id="MjSim-208"><a href="#MjSim-208"><span class="linenos">208</span></a>        <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim-209"><a href="#MjSim-209"><span class="linenos">209</span></a>        <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim-210"><a href="#MjSim-210"><span class="linenos">210</span></a>        <span class="n">z_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim-211"><a href="#MjSim-211"><span class="linenos">211</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_orientation</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
</span><span id="MjSim-212"><a href="#MjSim-212"><span class="linenos">212</span></a>        <span class="n">traj</span><span class="p">[</span><span class="s2">&quot;init_orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim-213"><a href="#MjSim-213"><span class="linenos">213</span></a>        <span class="n">N_SPEC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="MjSim-214"><a href="#MjSim-214"><span class="linenos">214</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SPEC</span><span class="p">):</span>
</span><span id="MjSim-215"><a href="#MjSim-215"><span class="linenos">215</span></a>            <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim-216"><a href="#MjSim-216"><span class="linenos">216</span></a>            <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim-217"><a href="#MjSim-217"><span class="linenos">217</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_close</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-218"><a href="#MjSim-218"><span class="linenos">218</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;move_close_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim-219"><a href="#MjSim-219"><span class="linenos">219</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-220"><a href="#MjSim-220"><span class="linenos">220</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp1_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim-221"><a href="#MjSim-221"><span class="linenos">221</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-222"><a href="#MjSim-222"><span class="linenos">222</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp2_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim-223"><a href="#MjSim-223"><span class="linenos">223</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-224"><a href="#MjSim-224"><span class="linenos">224</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp3_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim-225"><a href="#MjSim-225"><span class="linenos">225</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp4</span><span class="p">(</span><span class="n">z_height</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-226"><a href="#MjSim-226"><span class="linenos">226</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp4_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim-227"><a href="#MjSim-227"><span class="linenos">227</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">N_SPEC</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MjSim-228"><a href="#MjSim-228"><span class="linenos">228</span></a>                <span class="n">o_next_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim-229"><a href="#MjSim-229"><span class="linenos">229</span></a>                <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_to_next_alignment</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">o_next_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-230"><a href="#MjSim-230"><span class="linenos">230</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate_about</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-231"><a href="#MjSim-231"><span class="linenos">231</span></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">Ti</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
</span><span id="MjSim-232"><a href="#MjSim-232"><span class="linenos">232</span></a>                    <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;rotate_about_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ti</span>
</span><span id="MjSim-233"><a href="#MjSim-233"><span class="linenos">233</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MjSim-234"><a href="#MjSim-234"><span class="linenos">234</span></a>
</span><span id="MjSim-235"><a href="#MjSim-235"><span class="linenos">235</span></a>        <span class="k">return</span> <span class="n">traj</span>
</span><span id="MjSim-236"><a href="#MjSim-236"><span class="linenos">236</span></a>
</span><span id="MjSim-237"><a href="#MjSim-237"><span class="linenos">237</span></a>    <span class="k">def</span> <span class="nf">weaving</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ss</span><span class="p">:</span> <span class="n">SimSync</span><span class="p">):</span>
</span><span id="MjSim-238"><a href="#MjSim-238"><span class="linenos">238</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">:</span>
</span><span id="MjSim-239"><a href="#MjSim-239"><span class="linenos">239</span></a>            <span class="n">ss</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="MjSim-240"><a href="#MjSim-240"><span class="linenos">240</span></a>
</span><span id="MjSim-241"><a href="#MjSim-241"><span class="linenos">241</span></a>        <span class="n">DEFAULT_VEL</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="MjSim-242"><a href="#MjSim-242"><span class="linenos">242</span></a>        <span class="n">FAST_VEL</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MjSim-243"><a href="#MjSim-243"><span class="linenos">243</span></a>        <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim-244"><a href="#MjSim-244"><span class="linenos">244</span></a>        <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim-245"><a href="#MjSim-245"><span class="linenos">245</span></a>        <span class="n">z_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim-246"><a href="#MjSim-246"><span class="linenos">246</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_orientation</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
</span><span id="MjSim-247"><a href="#MjSim-247"><span class="linenos">247</span></a>        <span class="c1"># rotate the gripper towards the first obstacle</span>
</span><span id="MjSim-248"><a href="#MjSim-248"><span class="linenos">248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span><span class="p">)</span>
</span><span id="MjSim-249"><a href="#MjSim-249"><span class="linenos">249</span></a>
</span><span id="MjSim-250"><a href="#MjSim-250"><span class="linenos">250</span></a>        <span class="n">N_SPEC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="MjSim-251"><a href="#MjSim-251"><span class="linenos">251</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SPEC</span><span class="p">):</span>
</span><span id="MjSim-252"><a href="#MjSim-252"><span class="linenos">252</span></a>            <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim-253"><a href="#MjSim-253"><span class="linenos">253</span></a>            <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim-254"><a href="#MjSim-254"><span class="linenos">254</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_close</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</span><span id="MjSim-255"><a href="#MjSim-255"><span class="linenos">255</span></a>            <span class="c1"># move towards the i&#39;th obstacle and keep moving until a distance of (radius) is achieved</span>
</span><span id="MjSim-256"><a href="#MjSim-256"><span class="linenos">256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">DEFAULT_VEL</span><span class="p">)</span>
</span><span id="MjSim-257"><a href="#MjSim-257"><span class="linenos">257</span></a>
</span><span id="MjSim-258"><a href="#MjSim-258"><span class="linenos">258</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MjSim-259"><a href="#MjSim-259"><span class="linenos">259</span></a>                <span class="k">return</span>
</span><span id="MjSim-260"><a href="#MjSim-260"><span class="linenos">260</span></a>
</span><span id="MjSim-261"><a href="#MjSim-261"><span class="linenos">261</span></a>            <span class="c1"># lift up the cable</span>
</span><span id="MjSim-262"><a href="#MjSim-262"><span class="linenos">262</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-263"><a href="#MjSim-263"><span class="linenos">263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">DEFAULT_VEL</span><span class="p">)</span>
</span><span id="MjSim-264"><a href="#MjSim-264"><span class="linenos">264</span></a>            <span class="c1"># rotate the gripper theta</span>
</span><span id="MjSim-265"><a href="#MjSim-265"><span class="linenos">265</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-266"><a href="#MjSim-266"><span class="linenos">266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span><span class="p">)</span>
</span><span id="MjSim-267"><a href="#MjSim-267"><span class="linenos">267</span></a>            <span class="c1"># move over the obstacle distance delta</span>
</span><span id="MjSim-268"><a href="#MjSim-268"><span class="linenos">268</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-269"><a href="#MjSim-269"><span class="linenos">269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span><span class="p">)</span>
</span><span id="MjSim-270"><a href="#MjSim-270"><span class="linenos">270</span></a>            <span class="c1"># move down again</span>
</span><span id="MjSim-271"><a href="#MjSim-271"><span class="linenos">271</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp4</span><span class="p">(</span><span class="n">z_height</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-272"><a href="#MjSim-272"><span class="linenos">272</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">DEFAULT_VEL</span><span class="p">)</span>
</span><span id="MjSim-273"><a href="#MjSim-273"><span class="linenos">273</span></a>
</span><span id="MjSim-274"><a href="#MjSim-274"><span class="linenos">274</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">N_SPEC</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MjSim-275"><a href="#MjSim-275"><span class="linenos">275</span></a>                <span class="c1"># rotate about the obstacle until the gripper is aligned with the new</span>
</span><span id="MjSim-276"><a href="#MjSim-276"><span class="linenos">276</span></a>                <span class="n">o_next_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim-277"><a href="#MjSim-277"><span class="linenos">277</span></a>                <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_to_next_alignment</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">o_next_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-278"><a href="#MjSim-278"><span class="linenos">278</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate_about</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim-279"><a href="#MjSim-279"><span class="linenos">279</span></a>                <span class="k">for</span> <span class="n">Ti</span> <span class="ow">in</span> <span class="n">T</span><span class="p">:</span>
</span><span id="MjSim-280"><a href="#MjSim-280"><span class="linenos">280</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span>
</span><span id="MjSim-281"><a href="#MjSim-281"><span class="linenos">281</span></a>                        <span class="n">Ti</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span>
</span><span id="MjSim-282"><a href="#MjSim-282"><span class="linenos">282</span></a>                    <span class="p">)</span>
</span><span id="MjSim-283"><a href="#MjSim-283"><span class="linenos">283</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MjSim-284"><a href="#MjSim-284"><span class="linenos">284</span></a>
</span><span id="MjSim-285"><a href="#MjSim-285"><span class="linenos">285</span></a>    <span class="nd">@property</span>
</span><span id="MjSim-286"><a href="#MjSim-286"><span class="linenos">286</span></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">:</span>
</span><span id="MjSim-287"><a href="#MjSim-287"><span class="linenos">287</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span><span id="MjSim-288"><a href="#MjSim-288"><span class="linenos">288</span></a>
</span><span id="MjSim-289"><a href="#MjSim-289"><span class="linenos">289</span></a>    <span class="nd">@property</span>
</span><span id="MjSim-290"><a href="#MjSim-290"><span class="linenos">290</span></a>    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="p">:</span>
</span><span id="MjSim-291"><a href="#MjSim-291"><span class="linenos">291</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</span><span id="MjSim-292"><a href="#MjSim-292"><span class="linenos">292</span></a>
</span><span id="MjSim-293"><a href="#MjSim-293"><span class="linenos">293</span></a>    <span class="k">def</span> <span class="nf">keyboard_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="MjSim-294"><a href="#MjSim-294"><span class="linenos">294</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="n">glfw</span><span class="o">.</span><span class="n">KEY_SPACE</span><span class="p">:</span>
</span><span id="MjSim-295"><a href="#MjSim-295"><span class="linenos">295</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You pressed space...&quot;</span><span class="p">)</span>
</span><span id="MjSim-296"><a href="#MjSim-296"><span class="linenos">296</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="n">glfw</span><span class="o">.</span><span class="n">KEY_PERIOD</span><span class="p">:</span>
</span><span id="MjSim-297"><a href="#MjSim-297"><span class="linenos">297</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You pressed period...&quot;</span><span class="p">)</span>
</span><span id="MjSim-298"><a href="#MjSim-298"><span class="linenos">298</span></a>            <span class="n">save_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;s0_1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span><span id="MjSim-299"><a href="#MjSim-299"><span class="linenos">299</span></a>
</span><span id="MjSim-300"><a href="#MjSim-300"><span class="linenos">300</span></a>    <span class="k">def</span> <span class="nf">init_orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vel</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="MjSim-301"><a href="#MjSim-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim-302"><a href="#MjSim-302"><span class="linenos">302</span></a><span class="sd">        Align the TCP&#39;s y-axis to point directly away from a specified object.</span>
</span><span id="MjSim-303"><a href="#MjSim-303"><span class="linenos">303</span></a>
</span><span id="MjSim-304"><a href="#MjSim-304"><span class="linenos">304</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim-305"><a href="#MjSim-305"><span class="linenos">305</span></a><span class="sd">        - geom_name (str): Name of the geometry to align away from.</span>
</span><span id="MjSim-306"><a href="#MjSim-306"><span class="linenos">306</span></a><span class="sd">        - vel (float): Desired rotation velocity in radians per second (currently unused).</span>
</span><span id="MjSim-307"><a href="#MjSim-307"><span class="linenos">307</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="MjSim-308"><a href="#MjSim-308"><span class="linenos">308</span></a>
</span><span id="MjSim-309"><a href="#MjSim-309"><span class="linenos">309</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim-310"><a href="#MjSim-310"><span class="linenos">310</span></a><span class="sd">        - sm.SE3: The target pose after rotation.</span>
</span><span id="MjSim-311"><a href="#MjSim-311"><span class="linenos">311</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim-312"><a href="#MjSim-312"><span class="linenos">312</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim-313"><a href="#MjSim-313"><span class="linenos">313</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim-314"><a href="#MjSim-314"><span class="linenos">314</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-315"><a href="#MjSim-315"><span class="linenos">315</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim-316"><a href="#MjSim-316"><span class="linenos">316</span></a>
</span><span id="MjSim-317"><a href="#MjSim-317"><span class="linenos">317</span></a>        <span class="n">ry_T_w_tcp</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Extract the x-axis of the TCP&#39;s rotation matrix</span>
</span><span id="MjSim-318"><a href="#MjSim-318"><span class="linenos">318</span></a>
</span><span id="MjSim-319"><a href="#MjSim-319"><span class="linenos">319</span></a>        <span class="n">T_w_o</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim-320"><a href="#MjSim-320"><span class="linenos">320</span></a>
</span><span id="MjSim-321"><a href="#MjSim-321"><span class="linenos">321</span></a>        <span class="n">p_tcp_p_o</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MjSim-322"><a href="#MjSim-322"><span class="linenos">322</span></a>            <span class="n">T_w_o</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim-323"><a href="#MjSim-323"><span class="linenos">323</span></a>        <span class="p">)</span>  <span class="c1"># Relative 2D position from TCP to object</span>
</span><span id="MjSim-324"><a href="#MjSim-324"><span class="linenos">324</span></a>
</span><span id="MjSim-325"><a href="#MjSim-325"><span class="linenos">325</span></a>        <span class="c1"># Normalize vectors for angle calculation</span>
</span><span id="MjSim-326"><a href="#MjSim-326"><span class="linenos">326</span></a>        <span class="n">ry_T_w_tcp</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ry_T_w_tcp</span><span class="p">)</span>
</span><span id="MjSim-327"><a href="#MjSim-327"><span class="linenos">327</span></a>        <span class="n">p_tcp_p_o</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p_tcp_p_o</span><span class="p">)</span>
</span><span id="MjSim-328"><a href="#MjSim-328"><span class="linenos">328</span></a>
</span><span id="MjSim-329"><a href="#MjSim-329"><span class="linenos">329</span></a>        <span class="c1"># Compute the angle between the TCP&#39;s x-axis and the relative position vector</span>
</span><span id="MjSim-330"><a href="#MjSim-330"><span class="linenos">330</span></a>        <span class="n">phi</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span>
</span><span id="MjSim-331"><a href="#MjSim-331"><span class="linenos">331</span></a>            <span class="n">ry_T_w_tcp</span><span class="p">,</span> <span class="n">p_tcp_p_o</span>
</span><span id="MjSim-332"><a href="#MjSim-332"><span class="linenos">332</span></a>        <span class="p">)</span>  <span class="c1"># Angle between current x-axis and target direction</span>
</span><span id="MjSim-333"><a href="#MjSim-333"><span class="linenos">333</span></a>        <span class="n">cross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span>
</span><span id="MjSim-334"><a href="#MjSim-334"><span class="linenos">334</span></a>            <span class="n">ry_T_w_tcp</span><span class="p">,</span> <span class="n">p_tcp_p_o</span>
</span><span id="MjSim-335"><a href="#MjSim-335"><span class="linenos">335</span></a>        <span class="p">)</span>  <span class="c1"># Determine rotation direction (2D cross product)</span>
</span><span id="MjSim-336"><a href="#MjSim-336"><span class="linenos">336</span></a>
</span><span id="MjSim-337"><a href="#MjSim-337"><span class="linenos">337</span></a>        <span class="k">if</span> <span class="n">cross</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MjSim-338"><a href="#MjSim-338"><span class="linenos">338</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">phi</span>  <span class="c1"># Rotate counter-clockwise</span>
</span><span id="MjSim-339"><a href="#MjSim-339"><span class="linenos">339</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-340"><a href="#MjSim-340"><span class="linenos">340</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">phi</span>  <span class="c1"># Rotate clockwise</span>
</span><span id="MjSim-341"><a href="#MjSim-341"><span class="linenos">341</span></a>
</span><span id="MjSim-342"><a href="#MjSim-342"><span class="linenos">342</span></a>        <span class="c1"># Compute the target pose by rotating the TCP pose around the z-axis</span>
</span><span id="MjSim-343"><a href="#MjSim-343"><span class="linenos">343</span></a>        <span class="n">T_target</span> <span class="o">=</span> <span class="n">T_w_tcp</span> <span class="o">@</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="MjSim-344"><a href="#MjSim-344"><span class="linenos">344</span></a>
</span><span id="MjSim-345"><a href="#MjSim-345"><span class="linenos">345</span></a>        <span class="k">return</span> <span class="n">T_target</span>
</span><span id="MjSim-346"><a href="#MjSim-346"><span class="linenos">346</span></a>
</span><span id="MjSim-347"><a href="#MjSim-347"><span class="linenos">347</span></a>    <span class="k">def</span> <span class="nf">move_close</span><span class="p">(</span>
</span><span id="MjSim-348"><a href="#MjSim-348"><span class="linenos">348</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MjSim-349"><a href="#MjSim-349"><span class="linenos">349</span></a>        <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim-350"><a href="#MjSim-350"><span class="linenos">350</span></a>        <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.06</span><span class="p">,</span>
</span><span id="MjSim-351"><a href="#MjSim-351"><span class="linenos">351</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MjSim-352"><a href="#MjSim-352"><span class="linenos">352</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim-353"><a href="#MjSim-353"><span class="linenos">353</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim-354"><a href="#MjSim-354"><span class="linenos">354</span></a><span class="sd">        Move towards the object specified by geom_name until within a given radius.</span>
</span><span id="MjSim-355"><a href="#MjSim-355"><span class="linenos">355</span></a>
</span><span id="MjSim-356"><a href="#MjSim-356"><span class="linenos">356</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim-357"><a href="#MjSim-357"><span class="linenos">357</span></a><span class="sd">        - geom_name: str, the name of the geometry to move towards.</span>
</span><span id="MjSim-358"><a href="#MjSim-358"><span class="linenos">358</span></a><span class="sd">        - radius: float, the distance to maintain from the object.</span>
</span><span id="MjSim-359"><a href="#MjSim-359"><span class="linenos">359</span></a><span class="sd">        - vel: float, the velocity of the movement.</span>
</span><span id="MjSim-360"><a href="#MjSim-360"><span class="linenos">360</span></a>
</span><span id="MjSim-361"><a href="#MjSim-361"><span class="linenos">361</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim-362"><a href="#MjSim-362"><span class="linenos">362</span></a><span class="sd">        - sm.SE3: Pose radius away from a geometry.</span>
</span><span id="MjSim-363"><a href="#MjSim-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim-364"><a href="#MjSim-364"><span class="linenos">364</span></a>
</span><span id="MjSim-365"><a href="#MjSim-365"><span class="linenos">365</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim-366"><a href="#MjSim-366"><span class="linenos">366</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim-367"><a href="#MjSim-367"><span class="linenos">367</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-368"><a href="#MjSim-368"><span class="linenos">368</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim-369"><a href="#MjSim-369"><span class="linenos">369</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim-370"><a href="#MjSim-370"><span class="linenos">370</span></a>        <span class="n">dpos</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span>
</span><span id="MjSim-371"><a href="#MjSim-371"><span class="linenos">371</span></a>        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dpos</span><span class="p">)</span>
</span><span id="MjSim-372"><a href="#MjSim-372"><span class="linenos">372</span></a>
</span><span id="MjSim-373"><a href="#MjSim-373"><span class="linenos">373</span></a>        <span class="c1"># Adjust the translation to stop within the specified radius</span>
</span><span id="MjSim-374"><a href="#MjSim-374"><span class="linenos">374</span></a>        <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">radius</span><span class="p">:</span>
</span><span id="MjSim-375"><a href="#MjSim-375"><span class="linenos">375</span></a>            <span class="n">pos_unit</span> <span class="o">=</span> <span class="n">dpos</span> <span class="o">/</span> <span class="n">dt</span>
</span><span id="MjSim-376"><a href="#MjSim-376"><span class="linenos">376</span></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">radius</span>
</span><span id="MjSim-377"><a href="#MjSim-377"><span class="linenos">377</span></a>            <span class="n">pos_unit</span> <span class="o">*=</span> <span class="n">scale</span>
</span><span id="MjSim-378"><a href="#MjSim-378"><span class="linenos">378</span></a>            <span class="n">T1</span> <span class="o">=</span> <span class="n">make_tf</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">pos_unit</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
</span><span id="MjSim-379"><a href="#MjSim-379"><span class="linenos">379</span></a>            <span class="c1"># T1 = sm.SE3.Rt(R=T_gripper.R, t=T_gripper.t + pos_unit)</span>
</span><span id="MjSim-380"><a href="#MjSim-380"><span class="linenos">380</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-381"><a href="#MjSim-381"><span class="linenos">381</span></a>            <span class="n">T1</span> <span class="o">=</span> <span class="n">T_w_geom</span>
</span><span id="MjSim-382"><a href="#MjSim-382"><span class="linenos">382</span></a>
</span><span id="MjSim-383"><a href="#MjSim-383"><span class="linenos">383</span></a>        <span class="k">return</span> <span class="n">T1</span>
</span><span id="MjSim-384"><a href="#MjSim-384"><span class="linenos">384</span></a>
</span><span id="MjSim-385"><a href="#MjSim-385"><span class="linenos">385</span></a>    <span class="k">def</span> <span class="nf">angle_to_next_alignment</span><span class="p">(</span>
</span><span id="MjSim-386"><a href="#MjSim-386"><span class="linenos">386</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MjSim-387"><a href="#MjSim-387"><span class="linenos">387</span></a>        <span class="n">geom_indx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MjSim-388"><a href="#MjSim-388"><span class="linenos">388</span></a>        <span class="n">current_geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim-389"><a href="#MjSim-389"><span class="linenos">389</span></a>        <span class="n">next_geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim-390"><a href="#MjSim-390"><span class="linenos">390</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MjSim-391"><a href="#MjSim-391"><span class="linenos">391</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="MjSim-392"><a href="#MjSim-392"><span class="linenos">392</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim-393"><a href="#MjSim-393"><span class="linenos">393</span></a><span class="sd">        Compute the angle to align the TCP with a tangent direction between two geometries.</span>
</span><span id="MjSim-394"><a href="#MjSim-394"><span class="linenos">394</span></a>
</span><span id="MjSim-395"><a href="#MjSim-395"><span class="linenos">395</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim-396"><a href="#MjSim-396"><span class="linenos">396</span></a><span class="sd">        - geom_indx (int): Index of the geometry in the specification.</span>
</span><span id="MjSim-397"><a href="#MjSim-397"><span class="linenos">397</span></a><span class="sd">        - current_geom_name (str): Name of the current geometry.</span>
</span><span id="MjSim-398"><a href="#MjSim-398"><span class="linenos">398</span></a><span class="sd">        - next_geom_name (str): Name of the next geometry to align with.</span>
</span><span id="MjSim-399"><a href="#MjSim-399"><span class="linenos">399</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="MjSim-400"><a href="#MjSim-400"><span class="linenos">400</span></a>
</span><span id="MjSim-401"><a href="#MjSim-401"><span class="linenos">401</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim-402"><a href="#MjSim-402"><span class="linenos">402</span></a><span class="sd">        - float: The angle in radians for the alignment.</span>
</span><span id="MjSim-403"><a href="#MjSim-403"><span class="linenos">403</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim-404"><a href="#MjSim-404"><span class="linenos">404</span></a>
</span><span id="MjSim-405"><a href="#MjSim-405"><span class="linenos">405</span></a>        <span class="k">def</span> <span class="nf">tangent_points</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">):</span>
</span><span id="MjSim-406"><a href="#MjSim-406"><span class="linenos">406</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim-407"><a href="#MjSim-407"><span class="linenos">407</span></a><span class="sd">            Compute the tangent points on a circle centered at (cx, cy) with radius r</span>
</span><span id="MjSim-408"><a href="#MjSim-408"><span class="linenos">408</span></a><span class="sd">            from an external point (px, py).</span>
</span><span id="MjSim-409"><a href="#MjSim-409"><span class="linenos">409</span></a>
</span><span id="MjSim-410"><a href="#MjSim-410"><span class="linenos">410</span></a><span class="sd">            Parameters</span>
</span><span id="MjSim-411"><a href="#MjSim-411"><span class="linenos">411</span></a><span class="sd">            ----------</span>
</span><span id="MjSim-412"><a href="#MjSim-412"><span class="linenos">412</span></a><span class="sd">            cx, cy : float</span>
</span><span id="MjSim-413"><a href="#MjSim-413"><span class="linenos">413</span></a><span class="sd">                Circle center coordinates.</span>
</span><span id="MjSim-414"><a href="#MjSim-414"><span class="linenos">414</span></a><span class="sd">            r : float</span>
</span><span id="MjSim-415"><a href="#MjSim-415"><span class="linenos">415</span></a><span class="sd">                Circle radius.</span>
</span><span id="MjSim-416"><a href="#MjSim-416"><span class="linenos">416</span></a><span class="sd">            px, py : float</span>
</span><span id="MjSim-417"><a href="#MjSim-417"><span class="linenos">417</span></a><span class="sd">                External point coordinates.</span>
</span><span id="MjSim-418"><a href="#MjSim-418"><span class="linenos">418</span></a>
</span><span id="MjSim-419"><a href="#MjSim-419"><span class="linenos">419</span></a><span class="sd">            Returns</span>
</span><span id="MjSim-420"><a href="#MjSim-420"><span class="linenos">420</span></a><span class="sd">            -------</span>
</span><span id="MjSim-421"><a href="#MjSim-421"><span class="linenos">421</span></a><span class="sd">            tuple</span>
</span><span id="MjSim-422"><a href="#MjSim-422"><span class="linenos">422</span></a><span class="sd">                Coordinates of the two tangent points as (t1, t2), where t1 and t2</span>
</span><span id="MjSim-423"><a href="#MjSim-423"><span class="linenos">423</span></a><span class="sd">                are (x, y) tuples.</span>
</span><span id="MjSim-424"><a href="#MjSim-424"><span class="linenos">424</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="MjSim-425"><a href="#MjSim-425"><span class="linenos">425</span></a>            <span class="c1"># Translate the circle center and point to local coordinates</span>
</span><span id="MjSim-426"><a href="#MjSim-426"><span class="linenos">426</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">])</span>
</span><span id="MjSim-427"><a href="#MjSim-427"><span class="linenos">427</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</span><span id="MjSim-428"><a href="#MjSim-428"><span class="linenos">428</span></a>            <span class="n">local_p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">c</span>
</span><span id="MjSim-429"><a href="#MjSim-429"><span class="linenos">429</span></a>
</span><span id="MjSim-430"><a href="#MjSim-430"><span class="linenos">430</span></a>            <span class="c1"># Compute tangent points in local coordinates</span>
</span><span id="MjSim-431"><a href="#MjSim-431"><span class="linenos">431</span></a>            <span class="n">d0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">local_p</span><span class="p">)</span>
</span><span id="MjSim-432"><a href="#MjSim-432"><span class="linenos">432</span></a>            <span class="k">if</span> <span class="n">d0</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">:</span>
</span><span id="MjSim-433"><a href="#MjSim-433"><span class="linenos">433</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MjSim-434"><a href="#MjSim-434"><span class="linenos">434</span></a>                    <span class="s2">&quot;Point must be outside the circle for tangent lines to exist.&quot;</span>
</span><span id="MjSim-435"><a href="#MjSim-435"><span class="linenos">435</span></a>                <span class="p">)</span>
</span><span id="MjSim-436"><a href="#MjSim-436"><span class="linenos">436</span></a>
</span><span id="MjSim-437"><a href="#MjSim-437"><span class="linenos">437</span></a>            <span class="n">i1_local</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">local_p</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="MjSim-438"><a href="#MjSim-438"><span class="linenos">438</span></a>                <span class="n">d0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>
</span><span id="MjSim-439"><a href="#MjSim-439"><span class="linenos">439</span></a>            <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">local_p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">local_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</span><span id="MjSim-440"><a href="#MjSim-440"><span class="linenos">440</span></a>            <span class="n">i2_local</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">local_p</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="MjSim-441"><a href="#MjSim-441"><span class="linenos">441</span></a>                <span class="n">d0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>
</span><span id="MjSim-442"><a href="#MjSim-442"><span class="linenos">442</span></a>            <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">local_p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">local_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</span><span id="MjSim-443"><a href="#MjSim-443"><span class="linenos">443</span></a>
</span><span id="MjSim-444"><a href="#MjSim-444"><span class="linenos">444</span></a>            <span class="c1"># Transform tangent points back to global coordinates</span>
</span><span id="MjSim-445"><a href="#MjSim-445"><span class="linenos">445</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="n">i1_local</span> <span class="o">+</span> <span class="n">c</span>
</span><span id="MjSim-446"><a href="#MjSim-446"><span class="linenos">446</span></a>            <span class="n">t2</span> <span class="o">=</span> <span class="n">i2_local</span> <span class="o">+</span> <span class="n">c</span>
</span><span id="MjSim-447"><a href="#MjSim-447"><span class="linenos">447</span></a>
</span><span id="MjSim-448"><a href="#MjSim-448"><span class="linenos">448</span></a>            <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>
</span><span id="MjSim-449"><a href="#MjSim-449"><span class="linenos">449</span></a>
</span><span id="MjSim-450"><a href="#MjSim-450"><span class="linenos">450</span></a>        <span class="k">def</span> <span class="nf">angle_between_vectors</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;ccw&quot;</span><span class="p">):</span>
</span><span id="MjSim-451"><a href="#MjSim-451"><span class="linenos">451</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim-452"><a href="#MjSim-452"><span class="linenos">452</span></a><span class="sd">            Compute the angle between two 2D vectors in the specified direction.</span>
</span><span id="MjSim-453"><a href="#MjSim-453"><span class="linenos">453</span></a>
</span><span id="MjSim-454"><a href="#MjSim-454"><span class="linenos">454</span></a><span class="sd">            Parameters</span>
</span><span id="MjSim-455"><a href="#MjSim-455"><span class="linenos">455</span></a><span class="sd">            ----------</span>
</span><span id="MjSim-456"><a href="#MjSim-456"><span class="linenos">456</span></a><span class="sd">            u, v : array-like</span>
</span><span id="MjSim-457"><a href="#MjSim-457"><span class="linenos">457</span></a><span class="sd">                Input 2D vectors.</span>
</span><span id="MjSim-458"><a href="#MjSim-458"><span class="linenos">458</span></a><span class="sd">            direction : str, optional</span>
</span><span id="MjSim-459"><a href="#MjSim-459"><span class="linenos">459</span></a><span class="sd">                Direction of the angle, either &quot;ccw&quot; (counterclockwise) or &quot;cw&quot; (clockwise).</span>
</span><span id="MjSim-460"><a href="#MjSim-460"><span class="linenos">460</span></a><span class="sd">                Default is &quot;ccw&quot;.</span>
</span><span id="MjSim-461"><a href="#MjSim-461"><span class="linenos">461</span></a>
</span><span id="MjSim-462"><a href="#MjSim-462"><span class="linenos">462</span></a><span class="sd">            Returns</span>
</span><span id="MjSim-463"><a href="#MjSim-463"><span class="linenos">463</span></a><span class="sd">            -------</span>
</span><span id="MjSim-464"><a href="#MjSim-464"><span class="linenos">464</span></a><span class="sd">            float</span>
</span><span id="MjSim-465"><a href="#MjSim-465"><span class="linenos">465</span></a><span class="sd">                Angle in radians (0 to 2π) in the specified direction.</span>
</span><span id="MjSim-466"><a href="#MjSim-466"><span class="linenos">466</span></a>
</span><span id="MjSim-467"><a href="#MjSim-467"><span class="linenos">467</span></a><span class="sd">            Raises</span>
</span><span id="MjSim-468"><a href="#MjSim-468"><span class="linenos">468</span></a><span class="sd">            ------</span>
</span><span id="MjSim-469"><a href="#MjSim-469"><span class="linenos">469</span></a><span class="sd">            ValueError</span>
</span><span id="MjSim-470"><a href="#MjSim-470"><span class="linenos">470</span></a><span class="sd">                If the `direction` is not &quot;ccw&quot; or &quot;cw&quot;.</span>
</span><span id="MjSim-471"><a href="#MjSim-471"><span class="linenos">471</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="MjSim-472"><a href="#MjSim-472"><span class="linenos">472</span></a>            <span class="c1"># Normalize the vectors</span>
</span><span id="MjSim-473"><a href="#MjSim-473"><span class="linenos">473</span></a>            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="MjSim-474"><a href="#MjSim-474"><span class="linenos">474</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span id="MjSim-475"><a href="#MjSim-475"><span class="linenos">475</span></a>
</span><span id="MjSim-476"><a href="#MjSim-476"><span class="linenos">476</span></a>            <span class="c1"># Dot product and cross product (z-component only)</span>
</span><span id="MjSim-477"><a href="#MjSim-477"><span class="linenos">477</span></a>            <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="MjSim-478"><a href="#MjSim-478"><span class="linenos">478</span></a>            <span class="n">cross</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MjSim-479"><a href="#MjSim-479"><span class="linenos">479</span></a>
</span><span id="MjSim-480"><a href="#MjSim-480"><span class="linenos">480</span></a>            <span class="c1"># Compute the unsigned angle using the dot product</span>
</span><span id="MjSim-481"><a href="#MjSim-481"><span class="linenos">481</span></a>            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>  <span class="c1"># Clip for numerical stability</span>
</span><span id="MjSim-482"><a href="#MjSim-482"><span class="linenos">482</span></a>
</span><span id="MjSim-483"><a href="#MjSim-483"><span class="linenos">483</span></a>            <span class="c1"># Adjust for the specified direction</span>
</span><span id="MjSim-484"><a href="#MjSim-484"><span class="linenos">484</span></a>            <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="MjSim-485"><a href="#MjSim-485"><span class="linenos">485</span></a>                <span class="k">if</span> <span class="n">cross</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Negative cross-product means CW direction</span>
</span><span id="MjSim-486"><a href="#MjSim-486"><span class="linenos">486</span></a>                    <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">angle</span>
</span><span id="MjSim-487"><a href="#MjSim-487"><span class="linenos">487</span></a>            <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;cw&quot;</span><span class="p">:</span>
</span><span id="MjSim-488"><a href="#MjSim-488"><span class="linenos">488</span></a>                <span class="k">if</span> <span class="n">cross</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Positive cross-product means CCW direction</span>
</span><span id="MjSim-489"><a href="#MjSim-489"><span class="linenos">489</span></a>                    <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">angle</span>
</span><span id="MjSim-490"><a href="#MjSim-490"><span class="linenos">490</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-491"><a href="#MjSim-491"><span class="linenos">491</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MjSim-492"><a href="#MjSim-492"><span class="linenos">492</span></a>                    <span class="sa">f</span><span class="s2">&quot;Invalid direction: </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">. Must be &#39;ccw&#39; or &#39;cw&#39;.&quot;</span>
</span><span id="MjSim-493"><a href="#MjSim-493"><span class="linenos">493</span></a>                <span class="p">)</span>
</span><span id="MjSim-494"><a href="#MjSim-494"><span class="linenos">494</span></a>
</span><span id="MjSim-495"><a href="#MjSim-495"><span class="linenos">495</span></a>            <span class="k">return</span> <span class="n">angle</span>
</span><span id="MjSim-496"><a href="#MjSim-496"><span class="linenos">496</span></a>
</span><span id="MjSim-497"><a href="#MjSim-497"><span class="linenos">497</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim-498"><a href="#MjSim-498"><span class="linenos">498</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim-499"><a href="#MjSim-499"><span class="linenos">499</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-500"><a href="#MjSim-500"><span class="linenos">500</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim-501"><a href="#MjSim-501"><span class="linenos">501</span></a>
</span><span id="MjSim-502"><a href="#MjSim-502"><span class="linenos">502</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">current_geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim-503"><a href="#MjSim-503"><span class="linenos">503</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">next_geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span><span class="o">.</span><span class="n">t</span>
</span><span id="MjSim-504"><a href="#MjSim-504"><span class="linenos">504</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span>
</span><span id="MjSim-505"><a href="#MjSim-505"><span class="linenos">505</span></a>
</span><span id="MjSim-506"><a href="#MjSim-506"><span class="linenos">506</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</span><span id="MjSim-507"><a href="#MjSim-507"><span class="linenos">507</span></a>
</span><span id="MjSim-508"><a href="#MjSim-508"><span class="linenos">508</span></a>        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">tangent_points</span><span class="p">(</span><span class="n">cx</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cy</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">px</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">py</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MjSim-509"><a href="#MjSim-509"><span class="linenos">509</span></a>
</span><span id="MjSim-510"><a href="#MjSim-510"><span class="linenos">510</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim-511"><a href="#MjSim-511"><span class="linenos">511</span></a>        <span class="n">v1</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim-512"><a href="#MjSim-512"><span class="linenos">512</span></a>        <span class="n">v2</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim-513"><a href="#MjSim-513"><span class="linenos">513</span></a>
</span><span id="MjSim-514"><a href="#MjSim-514"><span class="linenos">514</span></a>        <span class="n">theta1</span> <span class="o">=</span> <span class="n">angle_between_vectors</span><span class="p">(</span>
</span><span id="MjSim-515"><a href="#MjSim-515"><span class="linenos">515</span></a>            <span class="n">u</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">geom_indx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim-516"><a href="#MjSim-516"><span class="linenos">516</span></a>        <span class="p">)</span>
</span><span id="MjSim-517"><a href="#MjSim-517"><span class="linenos">517</span></a>        <span class="n">theta2</span> <span class="o">=</span> <span class="n">angle_between_vectors</span><span class="p">(</span>
</span><span id="MjSim-518"><a href="#MjSim-518"><span class="linenos">518</span></a>            <span class="n">u</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">geom_indx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim-519"><a href="#MjSim-519"><span class="linenos">519</span></a>        <span class="p">)</span>
</span><span id="MjSim-520"><a href="#MjSim-520"><span class="linenos">520</span></a>        <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">)</span>
</span><span id="MjSim-521"><a href="#MjSim-521"><span class="linenos">521</span></a>
</span><span id="MjSim-522"><a href="#MjSim-522"><span class="linenos">522</span></a>        <span class="k">return</span> <span class="n">theta</span>
</span><span id="MjSim-523"><a href="#MjSim-523"><span class="linenos">523</span></a>
</span><span id="MjSim-524"><a href="#MjSim-524"><span class="linenos">524</span></a>    <span class="k">def</span> <span class="nf">rotate_about</span><span class="p">(</span>
</span><span id="MjSim-525"><a href="#MjSim-525"><span class="linenos">525</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MjSim-526"><a href="#MjSim-526"><span class="linenos">526</span></a>        <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim-527"><a href="#MjSim-527"><span class="linenos">527</span></a>        <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim-528"><a href="#MjSim-528"><span class="linenos">528</span></a>        <span class="n">phi</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="MjSim-529"><a href="#MjSim-529"><span class="linenos">529</span></a>        <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="MjSim-530"><a href="#MjSim-530"><span class="linenos">530</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MjSim-531"><a href="#MjSim-531"><span class="linenos">531</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim-532"><a href="#MjSim-532"><span class="linenos">532</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim-533"><a href="#MjSim-533"><span class="linenos">533</span></a><span class="sd">        Generate a pose rotating the TCP relative to a specified geometry.</span>
</span><span id="MjSim-534"><a href="#MjSim-534"><span class="linenos">534</span></a>
</span><span id="MjSim-535"><a href="#MjSim-535"><span class="linenos">535</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim-536"><a href="#MjSim-536"><span class="linenos">536</span></a><span class="sd">        - geom_name (str): Name of the geometry to rotate around.</span>
</span><span id="MjSim-537"><a href="#MjSim-537"><span class="linenos">537</span></a><span class="sd">        - dir (str): Direction of rotation, &quot;ccw&quot; for counterclockwise or &quot;cw&quot; for clockwise.</span>
</span><span id="MjSim-538"><a href="#MjSim-538"><span class="linenos">538</span></a><span class="sd">        - phi (float): Angle of rotation in radians.</span>
</span><span id="MjSim-539"><a href="#MjSim-539"><span class="linenos">539</span></a><span class="sd">        - n_steps (int): Number of steps in the trajectory.</span>
</span><span id="MjSim-540"><a href="#MjSim-540"><span class="linenos">540</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="MjSim-541"><a href="#MjSim-541"><span class="linenos">541</span></a>
</span><span id="MjSim-542"><a href="#MjSim-542"><span class="linenos">542</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim-543"><a href="#MjSim-543"><span class="linenos">543</span></a><span class="sd">        - sm.SE3: Rotated pose.</span>
</span><span id="MjSim-544"><a href="#MjSim-544"><span class="linenos">544</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim-545"><a href="#MjSim-545"><span class="linenos">545</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim-546"><a href="#MjSim-546"><span class="linenos">546</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim-547"><a href="#MjSim-547"><span class="linenos">547</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-548"><a href="#MjSim-548"><span class="linenos">548</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim-549"><a href="#MjSim-549"><span class="linenos">549</span></a>
</span><span id="MjSim-550"><a href="#MjSim-550"><span class="linenos">550</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim-551"><a href="#MjSim-551"><span class="linenos">551</span></a>        <span class="n">c_traj</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_w_tcp</span><span class="p">]</span>
</span><span id="MjSim-552"><a href="#MjSim-552"><span class="linenos">552</span></a>        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="n">phi</span> <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span> <span class="k">else</span> <span class="n">phi</span>
</span><span id="MjSim-553"><a href="#MjSim-553"><span class="linenos">553</span></a>        <span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">):</span>
</span><span id="MjSim-554"><a href="#MjSim-554"><span class="linenos">554</span></a>            <span class="n">T_tcp_geom</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span> <span class="o">*</span> <span class="n">T_w_tcp</span>
</span><span id="MjSim-555"><a href="#MjSim-555"><span class="linenos">555</span></a>            <span class="n">Rz</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
</span><span id="MjSim-556"><a href="#MjSim-556"><span class="linenos">556</span></a>            <span class="n">T_w_tcp_new</span> <span class="o">=</span> <span class="n">T_w_geom</span> <span class="o">*</span> <span class="n">Rz</span> <span class="o">*</span> <span class="n">T_tcp_geom</span>
</span><span id="MjSim-557"><a href="#MjSim-557"><span class="linenos">557</span></a>            <span class="n">c_traj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T_w_tcp_new</span><span class="p">)</span>
</span><span id="MjSim-558"><a href="#MjSim-558"><span class="linenos">558</span></a>        <span class="k">return</span> <span class="n">c_traj</span>
</span><span id="MjSim-559"><a href="#MjSim-559"><span class="linenos">559</span></a>
</span><span id="MjSim-560"><a href="#MjSim-560"><span class="linenos">560</span></a>    <span class="k">def</span> <span class="nf">opp1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim-561"><a href="#MjSim-561"><span class="linenos">561</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim-562"><a href="#MjSim-562"><span class="linenos">562</span></a><span class="sd">        Generate a Cartesian pose from the end effector pose to a new pose above an obstacle.</span>
</span><span id="MjSim-563"><a href="#MjSim-563"><span class="linenos">563</span></a>
</span><span id="MjSim-564"><a href="#MjSim-564"><span class="linenos">564</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim-565"><a href="#MjSim-565"><span class="linenos">565</span></a><span class="sd">        - h (float): Height offset above the obstacle.</span>
</span><span id="MjSim-566"><a href="#MjSim-566"><span class="linenos">566</span></a><span class="sd">        - geom_name (str): Name of the obstacle geometry.</span>
</span><span id="MjSim-567"><a href="#MjSim-567"><span class="linenos">567</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="MjSim-568"><a href="#MjSim-568"><span class="linenos">568</span></a>
</span><span id="MjSim-569"><a href="#MjSim-569"><span class="linenos">569</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim-570"><a href="#MjSim-570"><span class="linenos">570</span></a><span class="sd">        - sm.SE3: Target pose above the obstacle.</span>
</span><span id="MjSim-571"><a href="#MjSim-571"><span class="linenos">571</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim-572"><a href="#MjSim-572"><span class="linenos">572</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim-573"><a href="#MjSim-573"><span class="linenos">573</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim-574"><a href="#MjSim-574"><span class="linenos">574</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-575"><a href="#MjSim-575"><span class="linenos">575</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim-576"><a href="#MjSim-576"><span class="linenos">576</span></a>
</span><span id="MjSim-577"><a href="#MjSim-577"><span class="linenos">577</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim-578"><a href="#MjSim-578"><span class="linenos">578</span></a>        <span class="n">Tz</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Tz</span><span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span id="MjSim-579"><a href="#MjSim-579"><span class="linenos">579</span></a>        <span class="n">T_w_up</span> <span class="o">=</span> <span class="n">Tz</span> <span class="o">@</span> <span class="n">T_w_tcp</span>
</span><span id="MjSim-580"><a href="#MjSim-580"><span class="linenos">580</span></a>
</span><span id="MjSim-581"><a href="#MjSim-581"><span class="linenos">581</span></a>        <span class="c1"># T = ctraj(T_start=T_w_tcp, T_end=T_world_up, t=n_steps)</span>
</span><span id="MjSim-582"><a href="#MjSim-582"><span class="linenos">582</span></a>        <span class="c1"># # T = rtb.ctraj(T0=T_world_tcp, T1=T_world_up, t=n_steps)</span>
</span><span id="MjSim-583"><a href="#MjSim-583"><span class="linenos">583</span></a>        <span class="c1"># poses.extend(T)</span>
</span><span id="MjSim-584"><a href="#MjSim-584"><span class="linenos">584</span></a>        <span class="c1"># return poses</span>
</span><span id="MjSim-585"><a href="#MjSim-585"><span class="linenos">585</span></a>        <span class="k">return</span> <span class="n">T_w_up</span>
</span><span id="MjSim-586"><a href="#MjSim-586"><span class="linenos">586</span></a>
</span><span id="MjSim-587"><a href="#MjSim-587"><span class="linenos">587</span></a>    <span class="k">def</span> <span class="nf">opp2</span><span class="p">(</span>
</span><span id="MjSim-588"><a href="#MjSim-588"><span class="linenos">588</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MjSim-589"><a href="#MjSim-589"><span class="linenos">589</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim-590"><a href="#MjSim-590"><span class="linenos">590</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim-591"><a href="#MjSim-591"><span class="linenos">591</span></a><span class="sd">        Generate a Cartesian pose rotated theta raltive to some obstacle.</span>
</span><span id="MjSim-592"><a href="#MjSim-592"><span class="linenos">592</span></a>
</span><span id="MjSim-593"><a href="#MjSim-593"><span class="linenos">593</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim-594"><a href="#MjSim-594"><span class="linenos">594</span></a><span class="sd">        - theta (float): Angle of rotation in radians.</span>
</span><span id="MjSim-595"><a href="#MjSim-595"><span class="linenos">595</span></a><span class="sd">        - dir (str): Direction of rotation, &quot;ccw&quot; or &quot;cw&quot;.</span>
</span><span id="MjSim-596"><a href="#MjSim-596"><span class="linenos">596</span></a><span class="sd">        - geom_name (str): Name of the obstacle geometry.</span>
</span><span id="MjSim-597"><a href="#MjSim-597"><span class="linenos">597</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="MjSim-598"><a href="#MjSim-598"><span class="linenos">598</span></a>
</span><span id="MjSim-599"><a href="#MjSim-599"><span class="linenos">599</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim-600"><a href="#MjSim-600"><span class="linenos">600</span></a><span class="sd">        - sm.SE3: Target pose after the rotation.</span>
</span><span id="MjSim-601"><a href="#MjSim-601"><span class="linenos">601</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim-602"><a href="#MjSim-602"><span class="linenos">602</span></a>
</span><span id="MjSim-603"><a href="#MjSim-603"><span class="linenos">603</span></a>        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="MjSim-604"><a href="#MjSim-604"><span class="linenos">604</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span>
</span><span id="MjSim-605"><a href="#MjSim-605"><span class="linenos">605</span></a>        <span class="k">elif</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;cw&quot;</span><span class="p">:</span>
</span><span id="MjSim-606"><a href="#MjSim-606"><span class="linenos">606</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span>
</span><span id="MjSim-607"><a href="#MjSim-607"><span class="linenos">607</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-608"><a href="#MjSim-608"><span class="linenos">608</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dir must be either &quot;ccw&quot; or &quot;cw&quot;, but &quot;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">&quot; was given&#39;</span><span class="p">)</span>
</span><span id="MjSim-609"><a href="#MjSim-609"><span class="linenos">609</span></a>
</span><span id="MjSim-610"><a href="#MjSim-610"><span class="linenos">610</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim-611"><a href="#MjSim-611"><span class="linenos">611</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim-612"><a href="#MjSim-612"><span class="linenos">612</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-613"><a href="#MjSim-613"><span class="linenos">613</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim-614"><a href="#MjSim-614"><span class="linenos">614</span></a>
</span><span id="MjSim-615"><a href="#MjSim-615"><span class="linenos">615</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim-616"><a href="#MjSim-616"><span class="linenos">616</span></a>
</span><span id="MjSim-617"><a href="#MjSim-617"><span class="linenos">617</span></a>        <span class="c1"># angle to slign axis with direction towards obstacle</span>
</span><span id="MjSim-618"><a href="#MjSim-618"><span class="linenos">618</span></a>        <span class="k">def</span> <span class="nf">get_phi</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="MjSim-619"><a href="#MjSim-619"><span class="linenos">619</span></a>            <span class="n">tcp_y</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MjSim-620"><a href="#MjSim-620"><span class="linenos">620</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">tcp_y</span>
</span><span id="MjSim-621"><a href="#MjSim-621"><span class="linenos">621</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim-622"><a href="#MjSim-622"><span class="linenos">622</span></a>            <span class="k">return</span> <span class="n">angle</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span id="MjSim-623"><a href="#MjSim-623"><span class="linenos">623</span></a>
</span><span id="MjSim-624"><a href="#MjSim-624"><span class="linenos">624</span></a>        <span class="c1"># the angle to correct the direction and the deviation angle theta</span>
</span><span id="MjSim-625"><a href="#MjSim-625"><span class="linenos">625</span></a>        <span class="n">theta</span> <span class="o">=</span> <span class="n">get_phi</span><span class="p">()</span> <span class="o">+</span> <span class="n">theta</span>
</span><span id="MjSim-626"><a href="#MjSim-626"><span class="linenos">626</span></a>
</span><span id="MjSim-627"><a href="#MjSim-627"><span class="linenos">627</span></a>        <span class="k">return</span> <span class="n">T_w_tcp</span> <span class="o">@</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="MjSim-628"><a href="#MjSim-628"><span class="linenos">628</span></a>
</span><span id="MjSim-629"><a href="#MjSim-629"><span class="linenos">629</span></a>    <span class="k">def</span> <span class="nf">opp3</span><span class="p">(</span>
</span><span id="MjSim-630"><a href="#MjSim-630"><span class="linenos">630</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MjSim-631"><a href="#MjSim-631"><span class="linenos">631</span></a>        <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="MjSim-632"><a href="#MjSim-632"><span class="linenos">632</span></a>        <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="MjSim-633"><a href="#MjSim-633"><span class="linenos">633</span></a>        <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim-634"><a href="#MjSim-634"><span class="linenos">634</span></a>        <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim-635"><a href="#MjSim-635"><span class="linenos">635</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MjSim-636"><a href="#MjSim-636"><span class="linenos">636</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim-637"><a href="#MjSim-637"><span class="linenos">637</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim-638"><a href="#MjSim-638"><span class="linenos">638</span></a><span class="sd">        Compute a target pose for the robot&#39;s end-effector based on positional and rotational offsets.</span>
</span><span id="MjSim-639"><a href="#MjSim-639"><span class="linenos">639</span></a>
</span><span id="MjSim-640"><a href="#MjSim-640"><span class="linenos">640</span></a><span class="sd">        Parameters</span>
</span><span id="MjSim-641"><a href="#MjSim-641"><span class="linenos">641</span></a><span class="sd">        ----------</span>
</span><span id="MjSim-642"><a href="#MjSim-642"><span class="linenos">642</span></a><span class="sd">        delta : float</span>
</span><span id="MjSim-643"><a href="#MjSim-643"><span class="linenos">643</span></a><span class="sd">            Distance offset from the current end-effector position towards the target geometry in the xy-plane.</span>
</span><span id="MjSim-644"><a href="#MjSim-644"><span class="linenos">644</span></a><span class="sd">        theta : float</span>
</span><span id="MjSim-645"><a href="#MjSim-645"><span class="linenos">645</span></a><span class="sd">            Angle of rotation around the z-axis (in radians).</span>
</span><span id="MjSim-646"><a href="#MjSim-646"><span class="linenos">646</span></a><span class="sd">        dir : str</span>
</span><span id="MjSim-647"><a href="#MjSim-647"><span class="linenos">647</span></a><span class="sd">            Direction of rotation (&quot;ccw&quot; for counterclockwise, any other value for clockwise).</span>
</span><span id="MjSim-648"><a href="#MjSim-648"><span class="linenos">648</span></a><span class="sd">        geom_name : str</span>
</span><span id="MjSim-649"><a href="#MjSim-649"><span class="linenos">649</span></a><span class="sd">            Name of the target geometry to compute the offset and rotation with respect to.</span>
</span><span id="MjSim-650"><a href="#MjSim-650"><span class="linenos">650</span></a><span class="sd">        T_init : sm.SE3, optional</span>
</span><span id="MjSim-651"><a href="#MjSim-651"><span class="linenos">651</span></a><span class="sd">            Initial pose of the end-effector. If None, the current pose is fetched from the robot, by default None.</span>
</span><span id="MjSim-652"><a href="#MjSim-652"><span class="linenos">652</span></a>
</span><span id="MjSim-653"><a href="#MjSim-653"><span class="linenos">653</span></a><span class="sd">        Returns</span>
</span><span id="MjSim-654"><a href="#MjSim-654"><span class="linenos">654</span></a><span class="sd">        -------</span>
</span><span id="MjSim-655"><a href="#MjSim-655"><span class="linenos">655</span></a><span class="sd">        sm.SE3</span>
</span><span id="MjSim-656"><a href="#MjSim-656"><span class="linenos">656</span></a><span class="sd">            The computed target pose in the world frame.</span>
</span><span id="MjSim-657"><a href="#MjSim-657"><span class="linenos">657</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim-658"><a href="#MjSim-658"><span class="linenos">658</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim-659"><a href="#MjSim-659"><span class="linenos">659</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim-660"><a href="#MjSim-660"><span class="linenos">660</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-661"><a href="#MjSim-661"><span class="linenos">661</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim-662"><a href="#MjSim-662"><span class="linenos">662</span></a>
</span><span id="MjSim-663"><a href="#MjSim-663"><span class="linenos">663</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim-664"><a href="#MjSim-664"><span class="linenos">664</span></a>
</span><span id="MjSim-665"><a href="#MjSim-665"><span class="linenos">665</span></a>        <span class="n">t_tcp_geom</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim-666"><a href="#MjSim-666"><span class="linenos">666</span></a>        <span class="n">t_tcp_geom_norm</span> <span class="o">=</span> <span class="n">t_tcp_geom</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t_tcp_geom</span><span class="p">)</span>
</span><span id="MjSim-667"><a href="#MjSim-667"><span class="linenos">667</span></a>        <span class="n">t_tcp_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_tcp_geom_norm</span><span class="p">))</span> <span class="o">+</span> <span class="n">t_tcp_geom</span>
</span><span id="MjSim-668"><a href="#MjSim-668"><span class="linenos">668</span></a>
</span><span id="MjSim-669"><a href="#MjSim-669"><span class="linenos">669</span></a>        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="MjSim-670"><a href="#MjSim-670"><span class="linenos">670</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span>
</span><span id="MjSim-671"><a href="#MjSim-671"><span class="linenos">671</span></a>
</span><span id="MjSim-672"><a href="#MjSim-672"><span class="linenos">672</span></a>        <span class="n">t_tcp_target_rot</span> <span class="o">=</span> <span class="n">rotate_vector_2d</span><span class="p">(</span><span class="n">t_tcp_target</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
</span><span id="MjSim-673"><a href="#MjSim-673"><span class="linenos">673</span></a>
</span><span id="MjSim-674"><a href="#MjSim-674"><span class="linenos">674</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_tcp_target_rot</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="MjSim-675"><a href="#MjSim-675"><span class="linenos">675</span></a>
</span><span id="MjSim-676"><a href="#MjSim-676"><span class="linenos">676</span></a>        <span class="n">rz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MjSim-677"><a href="#MjSim-677"><span class="linenos">677</span></a>        <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="MjSim-678"><a href="#MjSim-678"><span class="linenos">678</span></a>            <span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">0</span>
</span><span id="MjSim-679"><a href="#MjSim-679"><span class="linenos">679</span></a>        <span class="p">)</span>
</span><span id="MjSim-680"><a href="#MjSim-680"><span class="linenos">680</span></a>        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="MjSim-681"><a href="#MjSim-681"><span class="linenos">681</span></a>            <span class="n">rx</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="MjSim-682"><a href="#MjSim-682"><span class="linenos">682</span></a>        <span class="n">ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rz</span><span class="p">,</span> <span class="n">rx</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rz</span><span class="p">,</span> <span class="n">rx</span><span class="p">))</span>
</span><span id="MjSim-683"><a href="#MjSim-683"><span class="linenos">683</span></a>
</span><span id="MjSim-684"><a href="#MjSim-684"><span class="linenos">684</span></a>        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">))</span>
</span><span id="MjSim-685"><a href="#MjSim-685"><span class="linenos">685</span></a>
</span><span id="MjSim-686"><a href="#MjSim-686"><span class="linenos">686</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MjSim-687"><a href="#MjSim-687"><span class="linenos">687</span></a>            <span class="n">ry</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="MjSim-688"><a href="#MjSim-688"><span class="linenos">688</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">))</span>
</span><span id="MjSim-689"><a href="#MjSim-689"><span class="linenos">689</span></a>
</span><span id="MjSim-690"><a href="#MjSim-690"><span class="linenos">690</span></a>        <span class="n">T_w_target</span> <span class="o">=</span> <span class="n">make_tf</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>
</span><span id="MjSim-691"><a href="#MjSim-691"><span class="linenos">691</span></a>
</span><span id="MjSim-692"><a href="#MjSim-692"><span class="linenos">692</span></a>        <span class="k">return</span> <span class="n">T_w_target</span>
</span><span id="MjSim-693"><a href="#MjSim-693"><span class="linenos">693</span></a>
</span><span id="MjSim-694"><a href="#MjSim-694"><span class="linenos">694</span></a>    <span class="k">def</span> <span class="nf">opp4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_height</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim-695"><a href="#MjSim-695"><span class="linenos">695</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim-696"><a href="#MjSim-696"><span class="linenos">696</span></a><span class="sd">        Compute a target pose for the robot&#39;s end-effector with a specified z-height.</span>
</span><span id="MjSim-697"><a href="#MjSim-697"><span class="linenos">697</span></a>
</span><span id="MjSim-698"><a href="#MjSim-698"><span class="linenos">698</span></a><span class="sd">        Parameters</span>
</span><span id="MjSim-699"><a href="#MjSim-699"><span class="linenos">699</span></a><span class="sd">        ----------</span>
</span><span id="MjSim-700"><a href="#MjSim-700"><span class="linenos">700</span></a><span class="sd">        z_height : float</span>
</span><span id="MjSim-701"><a href="#MjSim-701"><span class="linenos">701</span></a><span class="sd">            Desired height (z-coordinate) for the end-effector in the world frame.</span>
</span><span id="MjSim-702"><a href="#MjSim-702"><span class="linenos">702</span></a><span class="sd">        T_init : sm.SE3, optional</span>
</span><span id="MjSim-703"><a href="#MjSim-703"><span class="linenos">703</span></a><span class="sd">            Initial pose of the end-effector. If None, the current pose is fetched from the robot, by default None.</span>
</span><span id="MjSim-704"><a href="#MjSim-704"><span class="linenos">704</span></a>
</span><span id="MjSim-705"><a href="#MjSim-705"><span class="linenos">705</span></a><span class="sd">        Returns</span>
</span><span id="MjSim-706"><a href="#MjSim-706"><span class="linenos">706</span></a><span class="sd">        -------</span>
</span><span id="MjSim-707"><a href="#MjSim-707"><span class="linenos">707</span></a><span class="sd">        sm.SE3</span>
</span><span id="MjSim-708"><a href="#MjSim-708"><span class="linenos">708</span></a><span class="sd">            The computed target pose with the specified z-height.</span>
</span><span id="MjSim-709"><a href="#MjSim-709"><span class="linenos">709</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim-710"><a href="#MjSim-710"><span class="linenos">710</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim-711"><a href="#MjSim-711"><span class="linenos">711</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim-712"><a href="#MjSim-712"><span class="linenos">712</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim-713"><a href="#MjSim-713"><span class="linenos">713</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim-714"><a href="#MjSim-714"><span class="linenos">714</span></a>
</span><span id="MjSim-715"><a href="#MjSim-715"><span class="linenos">715</span></a>        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Make a copy of the translation vector</span>
</span><span id="MjSim-716"><a href="#MjSim-716"><span class="linenos">716</span></a>        <span class="n">end_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_height</span>
</span><span id="MjSim-717"><a href="#MjSim-717"><span class="linenos">717</span></a>        <span class="n">T_target</span> <span class="o">=</span> <span class="n">make_tf</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">end_pos</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
</span><span id="MjSim-718"><a href="#MjSim-718"><span class="linenos">718</span></a>
</span><span id="MjSim-719"><a href="#MjSim-719"><span class="linenos">719</span></a>        <span class="k">return</span> <span class="n">T_target</span>
</span></pre></div>


            <div class="docstring"><p>Abstract base class for MuJoCo robot simulations.</p>

<p>This class serves as the foundational framework for simulating robots in MuJoCo. It defines
key properties and methods that must be implemented in subclasses, including access to
the simulation's dynamic data (<code>MjData</code>), the static model (<code>MjModel</code>), and control mechanisms.</p>

<p>Child classes are responsible for implementing the control logic (<code><a href="#MjSim.control_loop">control_loop</a></code>) and handling
user inputs via the keyboard (<code><a href="#MjSim.keyboard_callback">keyboard_callback</a></code>). The <code><a href="#MjSim.run">run</a></code> method provides a basic structure
for running the main simulation loop, handling viewer synchronization, and processing user inputs
in real-time.</p>

<p>This base class includes functionality to issue warnings if important methods, such as the control
loop or keyboard callback, are not implemented in a subclass.</p>
</div>


                            <div id="MjSim.gripper" class="classattr">
                                <div class="attr variable">
            <span class="name">gripper</span>

        
    </div>
    <a class="headerlink" href="#MjSim.gripper"></a>
    
    

                            </div>
                            <div id="MjSim.mocap" class="classattr">
                                <div class="attr variable">
            <span class="name">mocap</span>

        
    </div>
    <a class="headerlink" href="#MjSim.mocap"></a>
    
    

                            </div>
                            <div id="MjSim.T_mocap_tcp" class="classattr">
                                <div class="attr variable">
            <span class="name">T_mocap_tcp</span>

        
    </div>
    <a class="headerlink" href="#MjSim.T_mocap_tcp"></a>
    
    

                            </div>
                            <div id="MjSim.spec" class="classattr">
                                <div class="attr variable">
            <span class="name">spec</span>

        
    </div>
    <a class="headerlink" href="#MjSim.spec"></a>
    
    

                            </div>
                            <div id="MjSim.tasks" class="classattr">
                                <div class="attr variable">
            <span class="name">tasks</span>

        
    </div>
    <a class="headerlink" href="#MjSim.tasks"></a>
    
    

                            </div>
                            <div id="MjSim.h" class="classattr">
                                <div class="attr variable">
            <span class="name">h</span>

        
    </div>
    <a class="headerlink" href="#MjSim.h"></a>
    
    

                            </div>
                            <div id="MjSim.theta" class="classattr">
                                <div class="attr variable">
            <span class="name">theta</span>

        
    </div>
    <a class="headerlink" href="#MjSim.theta"></a>
    
    

                            </div>
                            <div id="MjSim.delta" class="classattr">
                                <div class="attr variable">
            <span class="name">delta</span>

        
    </div>
    <a class="headerlink" href="#MjSim.delta"></a>
    
    

                            </div>
                            <div id="MjSim.begin" class="classattr">
                                <div class="attr variable">
            <span class="name">begin</span>

        
    </div>
    <a class="headerlink" href="#MjSim.begin"></a>
    
    

                            </div>
                            <div id="MjSim.init" class="classattr">
                                        <input id="MjSim.init-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MjSim.init-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.init"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.init-80"><a href="#MjSim.init-80"><span class="linenos"> 80</span></a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MjSim.init-81"><a href="#MjSim.init-81"><span class="linenos"> 81</span></a>        <span class="c1"># root</span>
</span><span id="MjSim.init-82"><a href="#MjSim.init-82"><span class="linenos"> 82</span></a>        <span class="n">_HERE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span>
</span><span id="MjSim.init-83"><a href="#MjSim.init-83"><span class="linenos"> 83</span></a>
</span><span id="MjSim.init-84"><a href="#MjSim.init-84"><span class="linenos"> 84</span></a>        <span class="c1"># create keyframe file</span>
</span><span id="MjSim.init-85"><a href="#MjSim.init-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span><span class="p">,</span> <span class="s2">&quot;keyframes&quot;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s2">&quot;.xml&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-86"><a href="#MjSim.init-86"><span class="linenos"> 86</span></a>
</span><span id="MjSim.init-87"><a href="#MjSim.init-87"><span class="linenos"> 87</span></a>        <span class="c1"># Ensure the parent directory exists</span>
</span><span id="MjSim.init-88"><a href="#MjSim.init-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="MjSim.init-89"><a href="#MjSim.init-89"><span class="linenos"> 89</span></a>
</span><span id="MjSim.init-90"><a href="#MjSim.init-90"><span class="linenos"> 90</span></a>        <span class="c1"># Create an empty file if it doesn&#39;t exist</span>
</span><span id="MjSim.init-91"><a href="#MjSim.init-91"><span class="linenos"> 91</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="MjSim.init-92"><a href="#MjSim.init-92"><span class="linenos"> 92</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
</span><span id="MjSim.init-93"><a href="#MjSim.init-93"><span class="linenos"> 93</span></a>            <span class="c1"># Define the XML content you want to append</span>
</span><span id="MjSim.init-94"><a href="#MjSim.init-94"><span class="linenos"> 94</span></a>            <span class="n">xml_content</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
</span><span id="MjSim.init-95"><a href="#MjSim.init-95"><span class="linenos"> 95</span></a><span class="s2">            &lt;mujoco&gt;</span>
</span><span id="MjSim.init-96"><a href="#MjSim.init-96"><span class="linenos"> 96</span></a><span class="s2">            &lt;/mujoco&gt;</span>
</span><span id="MjSim.init-97"><a href="#MjSim.init-97"><span class="linenos"> 97</span></a><span class="s2">            &quot;&quot;&quot;</span>
</span><span id="MjSim.init-98"><a href="#MjSim.init-98"><span class="linenos"> 98</span></a>            <span class="c1"># Open the file in append mode and write the XML content</span>
</span><span id="MjSim.init-99"><a href="#MjSim.init-99"><span class="linenos"> 99</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="MjSim.init-100"><a href="#MjSim.init-100"><span class="linenos">100</span></a>                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">xml_content</span><span class="p">)</span>
</span><span id="MjSim.init-101"><a href="#MjSim.init-101"><span class="linenos">101</span></a>
</span><span id="MjSim.init-102"><a href="#MjSim.init-102"><span class="linenos">102</span></a>            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span><span id="MjSim.init-103"><a href="#MjSim.init-103"><span class="linenos">103</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.init-104"><a href="#MjSim.init-104"><span class="linenos">104</span></a>            <span class="c1"># find keyframes file and load in</span>
</span><span id="MjSim.init-105"><a href="#MjSim.init-105"><span class="linenos">105</span></a>            <span class="n">keyframe</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span><span id="MjSim.init-106"><a href="#MjSim.init-106"><span class="linenos">106</span></a>
</span><span id="MjSim.init-107"><a href="#MjSim.init-107"><span class="linenos">107</span></a>        <span class="c1"># scene path</span>
</span><span id="MjSim.init-108"><a href="#MjSim.init-108"><span class="linenos">108</span></a>        <span class="n">_XML_SCENE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;scenes/empty.xml&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-109"><a href="#MjSim.init-109"><span class="linenos">109</span></a>        <span class="n">scene</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_SCENE</span><span class="p">)</span>
</span><span id="MjSim.init-110"><a href="#MjSim.init-110"><span class="linenos">110</span></a>
</span><span id="MjSim.init-111"><a href="#MjSim.init-111"><span class="linenos">111</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">keyframe</span><span class="p">)</span>
</span><span id="MjSim.init-112"><a href="#MjSim.init-112"><span class="linenos">112</span></a>
</span><span id="MjSim.init-113"><a href="#MjSim.init-113"><span class="linenos">113</span></a>        <span class="c1"># panda path</span>
</span><span id="MjSim.init-114"><a href="#MjSim.init-114"><span class="linenos">114</span></a>        <span class="n">_XML_PANDA</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/franka_emika_panda/hand.xml&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-115"><a href="#MjSim.init-115"><span class="linenos">115</span></a>        <span class="c1"># _XML_panda = Path(_HERE / &quot;assets/robotiq_panda/panda-gs.xml&quot;)</span>
</span><span id="MjSim.init-116"><a href="#MjSim.init-116"><span class="linenos">116</span></a>        <span class="n">panda_hand</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_PANDA</span><span class="p">)</span>
</span><span id="MjSim.init-117"><a href="#MjSim.init-117"><span class="linenos">117</span></a>
</span><span id="MjSim.init-118"><a href="#MjSim.init-118"><span class="linenos">118</span></a>        <span class="n">mocap_body</span> <span class="o">=</span> <span class="n">scene</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="MjSim.init-119"><a href="#MjSim.init-119"><span class="linenos">119</span></a>            <span class="s2">&quot;body&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-120"><a href="#MjSim.init-120"><span class="linenos">120</span></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mocap&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-121"><a href="#MjSim.init-121"><span class="linenos">121</span></a>            <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;0 0 0.1&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-122"><a href="#MjSim.init-122"><span class="linenos">122</span></a>            <span class="n">mocap</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-123"><a href="#MjSim.init-123"><span class="linenos">123</span></a>        <span class="p">)</span>
</span><span id="MjSim.init-124"><a href="#MjSim.init-124"><span class="linenos">124</span></a>        <span class="n">mocap_body</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="MjSim.init-125"><a href="#MjSim.init-125"><span class="linenos">125</span></a>            <span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;0.01 0.01 0.01&quot;</span><span class="p">,</span> <span class="n">contype</span><span class="o">=</span><span class="s2">&quot;0&quot;</span><span class="p">,</span> <span class="n">conaffinity</span><span class="o">=</span><span class="s2">&quot;0&quot;</span>
</span><span id="MjSim.init-126"><a href="#MjSim.init-126"><span class="linenos">126</span></a>        <span class="p">)</span>
</span><span id="MjSim.init-127"><a href="#MjSim.init-127"><span class="linenos">127</span></a>        <span class="n">mocap_site</span> <span class="o">=</span> <span class="n">mocap_body</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;site&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mocap_site&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-128"><a href="#MjSim.init-128"><span class="linenos">128</span></a>
</span><span id="MjSim.init-129"><a href="#MjSim.init-129"><span class="linenos">129</span></a>        <span class="n">mocap_site</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">panda_hand</span><span class="p">)</span>
</span><span id="MjSim.init-130"><a href="#MjSim.init-130"><span class="linenos">130</span></a>
</span><span id="MjSim.init-131"><a href="#MjSim.init-131"><span class="linenos">131</span></a>        <span class="c1"># rgmc practice board</span>
</span><span id="MjSim.init-132"><a href="#MjSim.init-132"><span class="linenos">132</span></a>        <span class="n">_XML_BOARD</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span>
</span><span id="MjSim.init-133"><a href="#MjSim.init-133"><span class="linenos">133</span></a>            <span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/rgmc_practice_task_board_2020/task_board_mjx.xml&quot;</span>
</span><span id="MjSim.init-134"><a href="#MjSim.init-134"><span class="linenos">134</span></a>        <span class="p">)</span>
</span><span id="MjSim.init-135"><a href="#MjSim.init-135"><span class="linenos">135</span></a>        <span class="n">board</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_BOARD</span><span class="p">)</span>
</span><span id="MjSim.init-136"><a href="#MjSim.init-136"><span class="linenos">136</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">board</span><span class="p">)</span>
</span><span id="MjSim.init-137"><a href="#MjSim.init-137"><span class="linenos">137</span></a>
</span><span id="MjSim.init-138"><a href="#MjSim.init-138"><span class="linenos">138</span></a>        <span class="c1"># table</span>
</span><span id="MjSim.init-139"><a href="#MjSim.init-139"><span class="linenos">139</span></a>        <span class="n">_XML_TABLE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/props/flexcell_top.xml&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-140"><a href="#MjSim.init-140"><span class="linenos">140</span></a>        <span class="n">table</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_TABLE</span><span class="p">)</span>
</span><span id="MjSim.init-141"><a href="#MjSim.init-141"><span class="linenos">141</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</span><span id="MjSim.init-142"><a href="#MjSim.init-142"><span class="linenos">142</span></a>
</span><span id="MjSim.init-143"><a href="#MjSim.init-143"><span class="linenos">143</span></a>        <span class="c1"># cable</span>
</span><span id="MjSim.init-144"><a href="#MjSim.init-144"><span class="linenos">144</span></a>        <span class="n">_XML_CABLE</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">_HERE</span> <span class="o">/</span> <span class="s2">&quot;assets/props/cable.xml&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-145"><a href="#MjSim.init-145"><span class="linenos">145</span></a>        <span class="n">cable</span> <span class="o">=</span> <span class="n">mjcf</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">_XML_CABLE</span><span class="p">)</span>
</span><span id="MjSim.init-146"><a href="#MjSim.init-146"><span class="linenos">146</span></a>
</span><span id="MjSim.init-147"><a href="#MjSim.init-147"><span class="linenos">147</span></a>        <span class="n">cable_body</span> <span class="o">=</span> <span class="n">cable</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;cable&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-148"><a href="#MjSim.init-148"><span class="linenos">148</span></a>        <span class="n">cable_body</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.67521462</span><span class="p">,</span> <span class="mf">0.27162106</span><span class="p">,</span> <span class="mf">0.08657647</span><span class="p">]</span>
</span><span id="MjSim.init-149"><a href="#MjSim.init-149"><span class="linenos">149</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">cable</span><span class="p">)</span>
</span><span id="MjSim.init-150"><a href="#MjSim.init-150"><span class="linenos">150</span></a>
</span><span id="MjSim.init-151"><a href="#MjSim.init-151"><span class="linenos">151</span></a>        <span class="c1"># add pseudo fingers</span>
</span><span id="MjSim.init-152"><a href="#MjSim.init-152"><span class="linenos">152</span></a>        <span class="n">rf</span> <span class="o">=</span> <span class="n">panda_hand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;right_finger&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-153"><a href="#MjSim.init-153"><span class="linenos">153</span></a>        <span class="n">rf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="MjSim.init-154"><a href="#MjSim.init-154"><span class="linenos">154</span></a>            <span class="s2">&quot;geom&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-155"><a href="#MjSim.init-155"><span class="linenos">155</span></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;right_finger&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-156"><a href="#MjSim.init-156"><span class="linenos">156</span></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-157"><a href="#MjSim.init-157"><span class="linenos">157</span></a>            <span class="n">size</span><span class="o">=</span><span class="s2">&quot;0.01 0.02 0.01&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-158"><a href="#MjSim.init-158"><span class="linenos">158</span></a>            <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;0 0.02 0.1&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-159"><a href="#MjSim.init-159"><span class="linenos">159</span></a>            <span class="n">axisangle</span><span class="o">=</span><span class="s2">&quot;1 0 0 -1&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-160"><a href="#MjSim.init-160"><span class="linenos">160</span></a>            <span class="n">solref</span><span class="o">=</span><span class="s2">&quot;0.000000001 1&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-161"><a href="#MjSim.init-161"><span class="linenos">161</span></a>            <span class="n">friction</span><span class="o">=</span><span class="s2">&quot;0.3 0.3 0.3&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-162"><a href="#MjSim.init-162"><span class="linenos">162</span></a>            <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-163"><a href="#MjSim.init-163"><span class="linenos">163</span></a>        <span class="p">)</span>
</span><span id="MjSim.init-164"><a href="#MjSim.init-164"><span class="linenos">164</span></a>        <span class="n">lf</span> <span class="o">=</span> <span class="n">panda_hand</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;left_finger&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-165"><a href="#MjSim.init-165"><span class="linenos">165</span></a>        <span class="n">lf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
</span><span id="MjSim.init-166"><a href="#MjSim.init-166"><span class="linenos">166</span></a>            <span class="s2">&quot;geom&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-167"><a href="#MjSim.init-167"><span class="linenos">167</span></a>            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;left_finger&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-168"><a href="#MjSim.init-168"><span class="linenos">168</span></a>            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-169"><a href="#MjSim.init-169"><span class="linenos">169</span></a>            <span class="n">size</span><span class="o">=</span><span class="s2">&quot;0.01 0.02 0.01&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-170"><a href="#MjSim.init-170"><span class="linenos">170</span></a>            <span class="n">pos</span><span class="o">=</span><span class="s2">&quot;0 0.02 0.1&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-171"><a href="#MjSim.init-171"><span class="linenos">171</span></a>            <span class="n">axisangle</span><span class="o">=</span><span class="s2">&quot;1 0 0 -1&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-172"><a href="#MjSim.init-172"><span class="linenos">172</span></a>            <span class="n">solref</span><span class="o">=</span><span class="s2">&quot;0.000000001 1&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-173"><a href="#MjSim.init-173"><span class="linenos">173</span></a>            <span class="n">friction</span><span class="o">=</span><span class="s2">&quot;0.3 0.3 0.3&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-174"><a href="#MjSim.init-174"><span class="linenos">174</span></a>            <span class="n">priority</span><span class="o">=</span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span id="MjSim.init-175"><a href="#MjSim.init-175"><span class="linenos">175</span></a>        <span class="p">)</span>
</span><span id="MjSim.init-176"><a href="#MjSim.init-176"><span class="linenos">176</span></a>
</span><span id="MjSim.init-177"><a href="#MjSim.init-177"><span class="linenos">177</span></a>        <span class="n">board_body</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="s2">&quot;task_board&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-178"><a href="#MjSim.init-178"><span class="linenos">178</span></a>        <span class="n">board_body</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim.init-179"><a href="#MjSim.init-179"><span class="linenos">179</span></a>        <span class="n">wire_washer_3</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_washer_3&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-180"><a href="#MjSim.init-180"><span class="linenos">180</span></a>        <span class="n">wire_washer_2</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_washer_2&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-181"><a href="#MjSim.init-181"><span class="linenos">181</span></a>        <span class="n">wire_washer_1</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_washer_1&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-182"><a href="#MjSim.init-182"><span class="linenos">182</span></a>        <span class="n">wire_bolt_3</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_bolt_3&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-183"><a href="#MjSim.init-183"><span class="linenos">183</span></a>        <span class="n">wire_bolt_2</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_bolt_2&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-184"><a href="#MjSim.init-184"><span class="linenos">184</span></a>        <span class="n">wire_bolt_1</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">worldbody</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;geom&quot;</span><span class="p">,</span> <span class="s2">&quot;wire_bolt_1&quot;</span><span class="p">)</span>
</span><span id="MjSim.init-185"><a href="#MjSim.init-185"><span class="linenos">185</span></a>        <span class="n">wire_washer_3</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim.init-186"><a href="#MjSim.init-186"><span class="linenos">186</span></a>        <span class="n">wire_washer_2</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim.init-187"><a href="#MjSim.init-187"><span class="linenos">187</span></a>        <span class="n">wire_washer_1</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim.init-188"><a href="#MjSim.init-188"><span class="linenos">188</span></a>        <span class="n">wire_bolt_3</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim.init-189"><a href="#MjSim.init-189"><span class="linenos">189</span></a>        <span class="n">wire_bolt_2</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim.init-190"><a href="#MjSim.init-190"><span class="linenos">190</span></a>        <span class="n">wire_bolt_1</span><span class="o">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">0.2</span>
</span><span id="MjSim.init-191"><a href="#MjSim.init-191"><span class="linenos">191</span></a>
</span><span id="MjSim.init-192"><a href="#MjSim.init-192"><span class="linenos">192</span></a>        <span class="n">m</span> <span class="o">=</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="o">.</span><span class="n">from_xml_string</span><span class="p">(</span><span class="n">scene</span><span class="o">.</span><span class="n">to_xml_string</span><span class="p">(),</span> <span class="n">scene</span><span class="o">.</span><span class="n">get_assets</span><span class="p">())</span>
</span><span id="MjSim.init-193"><a href="#MjSim.init-193"><span class="linenos">193</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</span><span id="MjSim.init-194"><a href="#MjSim.init-194"><span class="linenos">194</span></a>
</span><span id="MjSim.init-195"><a href="#MjSim.init-195"><span class="linenos">195</span></a>        <span class="c1"># step once to compute the poses of objects</span>
</span><span id="MjSim.init-196"><a href="#MjSim.init-196"><span class="linenos">196</span></a>        <span class="n">mj</span><span class="o">.</span><span class="n">mj_step</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="MjSim.init-197"><a href="#MjSim.init-197"><span class="linenos">197</span></a>
</span><span id="MjSim.init-198"><a href="#MjSim.init-198"><span class="linenos">198</span></a>        <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span>
</span></pre></div>


    

                            </div>
                            <div id="MjSim.spin" class="classattr">
                                        <input id="MjSim.spin-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">spin</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ss</span><span class="p">:</span> <span class="n"><a href="base_sim.html#SimSync">sims.base_sim.SimSync</a></span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MjSim.spin-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.spin"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.spin-200"><a href="#MjSim.spin-200"><span class="linenos">200</span></a>    <span class="k">def</span> <span class="nf">spin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ss</span><span class="p">:</span> <span class="n">SimSync</span><span class="p">):</span>
</span><span id="MjSim.spin-201"><a href="#MjSim.spin-201"><span class="linenos">201</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="MjSim.spin-202"><a href="#MjSim.spin-202"><span class="linenos">202</span></a>            <span class="n">ss</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span></pre></div>


    

                            </div>
                            <div id="MjSim.get_check_point_frames" class="classattr">
                                        <input id="MjSim.get_check_point_frames-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_check_point_frames</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="MjSim.get_check_point_frames-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.get_check_point_frames"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.get_check_point_frames-204"><a href="#MjSim.get_check_point_frames-204"><span class="linenos">204</span></a>    <span class="k">def</span> <span class="nf">get_check_point_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">]:</span>
</span><span id="MjSim.get_check_point_frames-205"><a href="#MjSim.get_check_point_frames-205"><span class="linenos">205</span></a>        <span class="n">traj</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="MjSim.get_check_point_frames-206"><a href="#MjSim.get_check_point_frames-206"><span class="linenos">206</span></a>        <span class="n">traj</span><span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>
</span><span id="MjSim.get_check_point_frames-207"><a href="#MjSim.get_check_point_frames-207"><span class="linenos">207</span></a>
</span><span id="MjSim.get_check_point_frames-208"><a href="#MjSim.get_check_point_frames-208"><span class="linenos">208</span></a>        <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim.get_check_point_frames-209"><a href="#MjSim.get_check_point_frames-209"><span class="linenos">209</span></a>        <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim.get_check_point_frames-210"><a href="#MjSim.get_check_point_frames-210"><span class="linenos">210</span></a>        <span class="n">z_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim.get_check_point_frames-211"><a href="#MjSim.get_check_point_frames-211"><span class="linenos">211</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_orientation</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
</span><span id="MjSim.get_check_point_frames-212"><a href="#MjSim.get_check_point_frames-212"><span class="linenos">212</span></a>        <span class="n">traj</span><span class="p">[</span><span class="s2">&quot;init_orientation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim.get_check_point_frames-213"><a href="#MjSim.get_check_point_frames-213"><span class="linenos">213</span></a>        <span class="n">N_SPEC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="MjSim.get_check_point_frames-214"><a href="#MjSim.get_check_point_frames-214"><span class="linenos">214</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SPEC</span><span class="p">):</span>
</span><span id="MjSim.get_check_point_frames-215"><a href="#MjSim.get_check_point_frames-215"><span class="linenos">215</span></a>            <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim.get_check_point_frames-216"><a href="#MjSim.get_check_point_frames-216"><span class="linenos">216</span></a>            <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim.get_check_point_frames-217"><a href="#MjSim.get_check_point_frames-217"><span class="linenos">217</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_close</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.get_check_point_frames-218"><a href="#MjSim.get_check_point_frames-218"><span class="linenos">218</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;move_close_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim.get_check_point_frames-219"><a href="#MjSim.get_check_point_frames-219"><span class="linenos">219</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.get_check_point_frames-220"><a href="#MjSim.get_check_point_frames-220"><span class="linenos">220</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp1_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim.get_check_point_frames-221"><a href="#MjSim.get_check_point_frames-221"><span class="linenos">221</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.get_check_point_frames-222"><a href="#MjSim.get_check_point_frames-222"><span class="linenos">222</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp2_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim.get_check_point_frames-223"><a href="#MjSim.get_check_point_frames-223"><span class="linenos">223</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.get_check_point_frames-224"><a href="#MjSim.get_check_point_frames-224"><span class="linenos">224</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp3_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim.get_check_point_frames-225"><a href="#MjSim.get_check_point_frames-225"><span class="linenos">225</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp4</span><span class="p">(</span><span class="n">z_height</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.get_check_point_frames-226"><a href="#MjSim.get_check_point_frames-226"><span class="linenos">226</span></a>            <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;opp4_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span>
</span><span id="MjSim.get_check_point_frames-227"><a href="#MjSim.get_check_point_frames-227"><span class="linenos">227</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">N_SPEC</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MjSim.get_check_point_frames-228"><a href="#MjSim.get_check_point_frames-228"><span class="linenos">228</span></a>                <span class="n">o_next_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim.get_check_point_frames-229"><a href="#MjSim.get_check_point_frames-229"><span class="linenos">229</span></a>                <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_to_next_alignment</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">o_next_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.get_check_point_frames-230"><a href="#MjSim.get_check_point_frames-230"><span class="linenos">230</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate_about</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.get_check_point_frames-231"><a href="#MjSim.get_check_point_frames-231"><span class="linenos">231</span></a>                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">Ti</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
</span><span id="MjSim.get_check_point_frames-232"><a href="#MjSim.get_check_point_frames-232"><span class="linenos">232</span></a>                    <span class="n">traj</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;rotate_about_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Ti</span>
</span><span id="MjSim.get_check_point_frames-233"><a href="#MjSim.get_check_point_frames-233"><span class="linenos">233</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="MjSim.get_check_point_frames-234"><a href="#MjSim.get_check_point_frames-234"><span class="linenos">234</span></a>
</span><span id="MjSim.get_check_point_frames-235"><a href="#MjSim.get_check_point_frames-235"><span class="linenos">235</span></a>        <span class="k">return</span> <span class="n">traj</span>
</span></pre></div>


    

                            </div>
                            <div id="MjSim.weaving" class="classattr">
                                        <input id="MjSim.weaving-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">weaving</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">ss</span><span class="p">:</span> <span class="n"><a href="base_sim.html#SimSync">sims.base_sim.SimSync</a></span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MjSim.weaving-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.weaving"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.weaving-237"><a href="#MjSim.weaving-237"><span class="linenos">237</span></a>    <span class="k">def</span> <span class="nf">weaving</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ss</span><span class="p">:</span> <span class="n">SimSync</span><span class="p">):</span>
</span><span id="MjSim.weaving-238"><a href="#MjSim.weaving-238"><span class="linenos">238</span></a>        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin</span><span class="p">:</span>
</span><span id="MjSim.weaving-239"><a href="#MjSim.weaving-239"><span class="linenos">239</span></a>            <span class="n">ss</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="MjSim.weaving-240"><a href="#MjSim.weaving-240"><span class="linenos">240</span></a>
</span><span id="MjSim.weaving-241"><a href="#MjSim.weaving-241"><span class="linenos">241</span></a>        <span class="n">DEFAULT_VEL</span> <span class="o">=</span> <span class="mf">0.1</span>
</span><span id="MjSim.weaving-242"><a href="#MjSim.weaving-242"><span class="linenos">242</span></a>        <span class="n">FAST_VEL</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="MjSim.weaving-243"><a href="#MjSim.weaving-243"><span class="linenos">243</span></a>        <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim.weaving-244"><a href="#MjSim.weaving-244"><span class="linenos">244</span></a>        <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s2">&quot;o0&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim.weaving-245"><a href="#MjSim.weaving-245"><span class="linenos">245</span></a>        <span class="n">z_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim.weaving-246"><a href="#MjSim.weaving-246"><span class="linenos">246</span></a>        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_orientation</span><span class="p">(</span><span class="n">o_name</span><span class="p">)</span>
</span><span id="MjSim.weaving-247"><a href="#MjSim.weaving-247"><span class="linenos">247</span></a>        <span class="c1"># rotate the gripper towards the first obstacle</span>
</span><span id="MjSim.weaving-248"><a href="#MjSim.weaving-248"><span class="linenos">248</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span><span class="p">)</span>
</span><span id="MjSim.weaving-249"><a href="#MjSim.weaving-249"><span class="linenos">249</span></a>
</span><span id="MjSim.weaving-250"><a href="#MjSim.weaving-250"><span class="linenos">250</span></a>        <span class="n">N_SPEC</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="MjSim.weaving-251"><a href="#MjSim.weaving-251"><span class="linenos">251</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_SPEC</span><span class="p">):</span>
</span><span id="MjSim.weaving-252"><a href="#MjSim.weaving-252"><span class="linenos">252</span></a>            <span class="n">o_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim.weaving-253"><a href="#MjSim.weaving-253"><span class="linenos">253</span></a>            <span class="n">o_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim.weaving-254"><a href="#MjSim.weaving-254"><span class="linenos">254</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">move_close</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</span><span id="MjSim.weaving-255"><a href="#MjSim.weaving-255"><span class="linenos">255</span></a>            <span class="c1"># move towards the i&#39;th obstacle and keep moving until a distance of (radius) is achieved</span>
</span><span id="MjSim.weaving-256"><a href="#MjSim.weaving-256"><span class="linenos">256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">DEFAULT_VEL</span><span class="p">)</span>
</span><span id="MjSim.weaving-257"><a href="#MjSim.weaving-257"><span class="linenos">257</span></a>
</span><span id="MjSim.weaving-258"><a href="#MjSim.weaving-258"><span class="linenos">258</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="MjSim.weaving-259"><a href="#MjSim.weaving-259"><span class="linenos">259</span></a>                <span class="k">return</span>
</span><span id="MjSim.weaving-260"><a href="#MjSim.weaving-260"><span class="linenos">260</span></a>
</span><span id="MjSim.weaving-261"><a href="#MjSim.weaving-261"><span class="linenos">261</span></a>            <span class="c1"># lift up the cable</span>
</span><span id="MjSim.weaving-262"><a href="#MjSim.weaving-262"><span class="linenos">262</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp1</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.weaving-263"><a href="#MjSim.weaving-263"><span class="linenos">263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">DEFAULT_VEL</span><span class="p">)</span>
</span><span id="MjSim.weaving-264"><a href="#MjSim.weaving-264"><span class="linenos">264</span></a>            <span class="c1"># rotate the gripper theta</span>
</span><span id="MjSim.weaving-265"><a href="#MjSim.weaving-265"><span class="linenos">265</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.weaving-266"><a href="#MjSim.weaving-266"><span class="linenos">266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span><span class="p">)</span>
</span><span id="MjSim.weaving-267"><a href="#MjSim.weaving-267"><span class="linenos">267</span></a>            <span class="c1"># move over the obstacle distance delta</span>
</span><span id="MjSim.weaving-268"><a href="#MjSim.weaving-268"><span class="linenos">268</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp3</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.weaving-269"><a href="#MjSim.weaving-269"><span class="linenos">269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span><span class="p">)</span>
</span><span id="MjSim.weaving-270"><a href="#MjSim.weaving-270"><span class="linenos">270</span></a>            <span class="c1"># move down again</span>
</span><span id="MjSim.weaving-271"><a href="#MjSim.weaving-271"><span class="linenos">271</span></a>            <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">opp4</span><span class="p">(</span><span class="n">z_height</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.weaving-272"><a href="#MjSim.weaving-272"><span class="linenos">272</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span><span class="n">T</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">DEFAULT_VEL</span><span class="p">)</span>
</span><span id="MjSim.weaving-273"><a href="#MjSim.weaving-273"><span class="linenos">273</span></a>
</span><span id="MjSim.weaving-274"><a href="#MjSim.weaving-274"><span class="linenos">274</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">N_SPEC</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="MjSim.weaving-275"><a href="#MjSim.weaving-275"><span class="linenos">275</span></a>                <span class="c1"># rotate about the obstacle until the gripper is aligned with the new</span>
</span><span id="MjSim.weaving-276"><a href="#MjSim.weaving-276"><span class="linenos">276</span></a>                <span class="n">o_next_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
</span><span id="MjSim.weaving-277"><a href="#MjSim.weaving-277"><span class="linenos">277</span></a>                <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_to_next_alignment</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o_name</span><span class="p">,</span> <span class="n">o_next_name</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.weaving-278"><a href="#MjSim.weaving-278"><span class="linenos">278</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotate_about</span><span class="p">(</span><span class="n">o_name</span><span class="p">,</span> <span class="n">o_dir</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">T_init</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
</span><span id="MjSim.weaving-279"><a href="#MjSim.weaving-279"><span class="linenos">279</span></a>                <span class="k">for</span> <span class="n">Ti</span> <span class="ow">in</span> <span class="n">T</span><span class="p">:</span>
</span><span id="MjSim.weaving-280"><a href="#MjSim.weaving-280"><span class="linenos">280</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">mocap</span><span class="o">.</span><span class="n">move_l</span><span class="p">(</span>
</span><span id="MjSim.weaving-281"><a href="#MjSim.weaving-281"><span class="linenos">281</span></a>                        <span class="n">Ti</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_mocap_tcp</span><span class="o">.</span><span class="n">inv</span><span class="p">(),</span> <span class="n">ss</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">FAST_VEL</span>
</span><span id="MjSim.weaving-282"><a href="#MjSim.weaving-282"><span class="linenos">282</span></a>                    <span class="p">)</span>
</span><span id="MjSim.weaving-283"><a href="#MjSim.weaving-283"><span class="linenos">283</span></a>                <span class="n">T</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                            <div id="MjSim.data" class="classattr">
                                        <input id="MjSim.data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">data</span><span class="annotation">: mujoco._structs.MjData</span>

                <label class="view-source-button" for="MjSim.data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.data-285"><a href="#MjSim.data-285"><span class="linenos">285</span></a>    <span class="nd">@property</span>
</span><span id="MjSim.data-286"><a href="#MjSim.data-286"><span class="linenos">286</span></a>    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjData</span><span class="p">:</span>
</span><span id="MjSim.data-287"><a href="#MjSim.data-287"><span class="linenos">287</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span>
</span></pre></div>


            <div class="docstring"><p>Access the current simulation data.</p>

<p>This property provides access to an instance of the <code>MjData</code> class, which contains the dynamic
simulation state. This includes quantities such as joint positions, velocities,
actuator forces, and sensory information. The <code>MjData</code> object is updated at each simulation step
and can be used to inspect the real-time state of said simulation.</p>

<h2 id="returns">Returns</h2>

<p>mj.MjData
    An object representing the current dynamic state of the simulation.</p>
</div>


                            </div>
                            <div id="MjSim.model" class="classattr">
                                        <input id="MjSim.model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">model</span><span class="annotation">: mujoco._structs.MjModel</span>

                <label class="view-source-button" for="MjSim.model-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.model"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.model-289"><a href="#MjSim.model-289"><span class="linenos">289</span></a>    <span class="nd">@property</span>
</span><span id="MjSim.model-290"><a href="#MjSim.model-290"><span class="linenos">290</span></a>    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">mj</span><span class="o">.</span><span class="n">MjModel</span><span class="p">:</span>
</span><span id="MjSim.model-291"><a href="#MjSim.model-291"><span class="linenos">291</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model</span>
</span></pre></div>


            <div class="docstring"><p>Access the model of the MuJoCo simulation.</p>

<p>This property returns an instance of the <code>MjModel</code> class, which describes the physical and
mechanical properties of the simulation. The <code>MjModel</code> object contains static information about the
simulation such as its kinematic trees, inertial properties, joint and actuator definitions, and geometry
configurations. It is used to define the system's structure and behavior within the simulation.</p>

<h2 id="returns">Returns</h2>

<p>mj.MjModel
    An object representing the static model of the system and overall MuJoCo simulation.</p>
</div>


                            </div>
                            <div id="MjSim.keyboard_callback" class="classattr">
                                        <input id="MjSim.keyboard_callback-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">keyboard_callback</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">key</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MjSim.keyboard_callback-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.keyboard_callback"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.keyboard_callback-293"><a href="#MjSim.keyboard_callback-293"><span class="linenos">293</span></a>    <span class="k">def</span> <span class="nf">keyboard_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="MjSim.keyboard_callback-294"><a href="#MjSim.keyboard_callback-294"><span class="linenos">294</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="n">glfw</span><span class="o">.</span><span class="n">KEY_SPACE</span><span class="p">:</span>
</span><span id="MjSim.keyboard_callback-295"><a href="#MjSim.keyboard_callback-295"><span class="linenos">295</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You pressed space...&quot;</span><span class="p">)</span>
</span><span id="MjSim.keyboard_callback-296"><a href="#MjSim.keyboard_callback-296"><span class="linenos">296</span></a>        <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="n">glfw</span><span class="o">.</span><span class="n">KEY_PERIOD</span><span class="p">:</span>
</span><span id="MjSim.keyboard_callback-297"><a href="#MjSim.keyboard_callback-297"><span class="linenos">297</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You pressed period...&quot;</span><span class="p">)</span>
</span><span id="MjSim.keyboard_callback-298"><a href="#MjSim.keyboard_callback-298"><span class="linenos">298</span></a>            <span class="n">save_keyframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;s0_1&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">keyframe_path</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Handle keyboard inputs during the simulation.</p>

<p>This method is intended to be overridden in the child class to define how the simulation responds
to specific keyboard inputs. The <code>key</code> parameter corresponds to the key pressed by the user,
allowing for custom behavior (e.g., sending trajectories to robots' task queues, logging data
or start/stopping processes).</p>

<p>If this method is not implemented in the child class, a warning will be issued.</p>

<h2 id="parameters">Parameters</h2>

<p>key : int
    The key pressed by the user represented by a key code.</p>

<h2 id="raises">Raises</h2>

<p>UserWarning
    If the method is not implemented in the child class.</p>
</div>


                            </div>
                            <div id="MjSim.init_orientation" class="classattr">
                                        <input id="MjSim.init_orientation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">init_orientation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">vel</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span>,</span><span class="param">	<span class="n">T_init</span><span class="p">:</span> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MjSim.init_orientation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.init_orientation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.init_orientation-300"><a href="#MjSim.init_orientation-300"><span class="linenos">300</span></a>    <span class="k">def</span> <span class="nf">init_orientation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">vel</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="MjSim.init_orientation-301"><a href="#MjSim.init_orientation-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim.init_orientation-302"><a href="#MjSim.init_orientation-302"><span class="linenos">302</span></a><span class="sd">        Align the TCP&#39;s y-axis to point directly away from a specified object.</span>
</span><span id="MjSim.init_orientation-303"><a href="#MjSim.init_orientation-303"><span class="linenos">303</span></a>
</span><span id="MjSim.init_orientation-304"><a href="#MjSim.init_orientation-304"><span class="linenos">304</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim.init_orientation-305"><a href="#MjSim.init_orientation-305"><span class="linenos">305</span></a><span class="sd">        - geom_name (str): Name of the geometry to align away from.</span>
</span><span id="MjSim.init_orientation-306"><a href="#MjSim.init_orientation-306"><span class="linenos">306</span></a><span class="sd">        - vel (float): Desired rotation velocity in radians per second (currently unused).</span>
</span><span id="MjSim.init_orientation-307"><a href="#MjSim.init_orientation-307"><span class="linenos">307</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="MjSim.init_orientation-308"><a href="#MjSim.init_orientation-308"><span class="linenos">308</span></a>
</span><span id="MjSim.init_orientation-309"><a href="#MjSim.init_orientation-309"><span class="linenos">309</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim.init_orientation-310"><a href="#MjSim.init_orientation-310"><span class="linenos">310</span></a><span class="sd">        - sm.SE3: The target pose after rotation.</span>
</span><span id="MjSim.init_orientation-311"><a href="#MjSim.init_orientation-311"><span class="linenos">311</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim.init_orientation-312"><a href="#MjSim.init_orientation-312"><span class="linenos">312</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim.init_orientation-313"><a href="#MjSim.init_orientation-313"><span class="linenos">313</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim.init_orientation-314"><a href="#MjSim.init_orientation-314"><span class="linenos">314</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.init_orientation-315"><a href="#MjSim.init_orientation-315"><span class="linenos">315</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim.init_orientation-316"><a href="#MjSim.init_orientation-316"><span class="linenos">316</span></a>
</span><span id="MjSim.init_orientation-317"><a href="#MjSim.init_orientation-317"><span class="linenos">317</span></a>        <span class="n">ry_T_w_tcp</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>  <span class="c1"># Extract the x-axis of the TCP&#39;s rotation matrix</span>
</span><span id="MjSim.init_orientation-318"><a href="#MjSim.init_orientation-318"><span class="linenos">318</span></a>
</span><span id="MjSim.init_orientation-319"><a href="#MjSim.init_orientation-319"><span class="linenos">319</span></a>        <span class="n">T_w_o</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim.init_orientation-320"><a href="#MjSim.init_orientation-320"><span class="linenos">320</span></a>
</span><span id="MjSim.init_orientation-321"><a href="#MjSim.init_orientation-321"><span class="linenos">321</span></a>        <span class="n">p_tcp_p_o</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="MjSim.init_orientation-322"><a href="#MjSim.init_orientation-322"><span class="linenos">322</span></a>            <span class="n">T_w_o</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim.init_orientation-323"><a href="#MjSim.init_orientation-323"><span class="linenos">323</span></a>        <span class="p">)</span>  <span class="c1"># Relative 2D position from TCP to object</span>
</span><span id="MjSim.init_orientation-324"><a href="#MjSim.init_orientation-324"><span class="linenos">324</span></a>
</span><span id="MjSim.init_orientation-325"><a href="#MjSim.init_orientation-325"><span class="linenos">325</span></a>        <span class="c1"># Normalize vectors for angle calculation</span>
</span><span id="MjSim.init_orientation-326"><a href="#MjSim.init_orientation-326"><span class="linenos">326</span></a>        <span class="n">ry_T_w_tcp</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ry_T_w_tcp</span><span class="p">)</span>
</span><span id="MjSim.init_orientation-327"><a href="#MjSim.init_orientation-327"><span class="linenos">327</span></a>        <span class="n">p_tcp_p_o</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p_tcp_p_o</span><span class="p">)</span>
</span><span id="MjSim.init_orientation-328"><a href="#MjSim.init_orientation-328"><span class="linenos">328</span></a>
</span><span id="MjSim.init_orientation-329"><a href="#MjSim.init_orientation-329"><span class="linenos">329</span></a>        <span class="c1"># Compute the angle between the TCP&#39;s x-axis and the relative position vector</span>
</span><span id="MjSim.init_orientation-330"><a href="#MjSim.init_orientation-330"><span class="linenos">330</span></a>        <span class="n">phi</span> <span class="o">=</span> <span class="n">angle</span><span class="p">(</span>
</span><span id="MjSim.init_orientation-331"><a href="#MjSim.init_orientation-331"><span class="linenos">331</span></a>            <span class="n">ry_T_w_tcp</span><span class="p">,</span> <span class="n">p_tcp_p_o</span>
</span><span id="MjSim.init_orientation-332"><a href="#MjSim.init_orientation-332"><span class="linenos">332</span></a>        <span class="p">)</span>  <span class="c1"># Angle between current x-axis and target direction</span>
</span><span id="MjSim.init_orientation-333"><a href="#MjSim.init_orientation-333"><span class="linenos">333</span></a>        <span class="n">cross</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span>
</span><span id="MjSim.init_orientation-334"><a href="#MjSim.init_orientation-334"><span class="linenos">334</span></a>            <span class="n">ry_T_w_tcp</span><span class="p">,</span> <span class="n">p_tcp_p_o</span>
</span><span id="MjSim.init_orientation-335"><a href="#MjSim.init_orientation-335"><span class="linenos">335</span></a>        <span class="p">)</span>  <span class="c1"># Determine rotation direction (2D cross product)</span>
</span><span id="MjSim.init_orientation-336"><a href="#MjSim.init_orientation-336"><span class="linenos">336</span></a>
</span><span id="MjSim.init_orientation-337"><a href="#MjSim.init_orientation-337"><span class="linenos">337</span></a>        <span class="k">if</span> <span class="n">cross</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MjSim.init_orientation-338"><a href="#MjSim.init_orientation-338"><span class="linenos">338</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">phi</span>  <span class="c1"># Rotate counter-clockwise</span>
</span><span id="MjSim.init_orientation-339"><a href="#MjSim.init_orientation-339"><span class="linenos">339</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.init_orientation-340"><a href="#MjSim.init_orientation-340"><span class="linenos">340</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">phi</span>  <span class="c1"># Rotate clockwise</span>
</span><span id="MjSim.init_orientation-341"><a href="#MjSim.init_orientation-341"><span class="linenos">341</span></a>
</span><span id="MjSim.init_orientation-342"><a href="#MjSim.init_orientation-342"><span class="linenos">342</span></a>        <span class="c1"># Compute the target pose by rotating the TCP pose around the z-axis</span>
</span><span id="MjSim.init_orientation-343"><a href="#MjSim.init_orientation-343"><span class="linenos">343</span></a>        <span class="n">T_target</span> <span class="o">=</span> <span class="n">T_w_tcp</span> <span class="o">@</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="MjSim.init_orientation-344"><a href="#MjSim.init_orientation-344"><span class="linenos">344</span></a>
</span><span id="MjSim.init_orientation-345"><a href="#MjSim.init_orientation-345"><span class="linenos">345</span></a>        <span class="k">return</span> <span class="n">T_target</span>
</span></pre></div>


            <div class="docstring"><p>Align the TCP's y-axis to point directly away from a specified object.</p>

<p>Parameters:</p>

<ul>
<li>geom_name (str): Name of the geometry to align away from.</li>
<li>vel (float): Desired rotation velocity in radians per second (currently unused).</li>
<li>T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</li>
</ul>

<p>Returns:</p>

<ul>
<li>sm.SE3: The target pose after rotation.</li>
</ul>
</div>


                            </div>
                            <div id="MjSim.move_close" class="classattr">
                                        <input id="MjSim.move_close-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">move_close</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.06</span>,</span><span class="param">	<span class="n">T_init</span><span class="p">:</span> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span>:</span></span>

                <label class="view-source-button" for="MjSim.move_close-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.move_close"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.move_close-347"><a href="#MjSim.move_close-347"><span class="linenos">347</span></a>    <span class="k">def</span> <span class="nf">move_close</span><span class="p">(</span>
</span><span id="MjSim.move_close-348"><a href="#MjSim.move_close-348"><span class="linenos">348</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MjSim.move_close-349"><a href="#MjSim.move_close-349"><span class="linenos">349</span></a>        <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim.move_close-350"><a href="#MjSim.move_close-350"><span class="linenos">350</span></a>        <span class="n">radius</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.06</span><span class="p">,</span>
</span><span id="MjSim.move_close-351"><a href="#MjSim.move_close-351"><span class="linenos">351</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MjSim.move_close-352"><a href="#MjSim.move_close-352"><span class="linenos">352</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim.move_close-353"><a href="#MjSim.move_close-353"><span class="linenos">353</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim.move_close-354"><a href="#MjSim.move_close-354"><span class="linenos">354</span></a><span class="sd">        Move towards the object specified by geom_name until within a given radius.</span>
</span><span id="MjSim.move_close-355"><a href="#MjSim.move_close-355"><span class="linenos">355</span></a>
</span><span id="MjSim.move_close-356"><a href="#MjSim.move_close-356"><span class="linenos">356</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim.move_close-357"><a href="#MjSim.move_close-357"><span class="linenos">357</span></a><span class="sd">        - geom_name: str, the name of the geometry to move towards.</span>
</span><span id="MjSim.move_close-358"><a href="#MjSim.move_close-358"><span class="linenos">358</span></a><span class="sd">        - radius: float, the distance to maintain from the object.</span>
</span><span id="MjSim.move_close-359"><a href="#MjSim.move_close-359"><span class="linenos">359</span></a><span class="sd">        - vel: float, the velocity of the movement.</span>
</span><span id="MjSim.move_close-360"><a href="#MjSim.move_close-360"><span class="linenos">360</span></a>
</span><span id="MjSim.move_close-361"><a href="#MjSim.move_close-361"><span class="linenos">361</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim.move_close-362"><a href="#MjSim.move_close-362"><span class="linenos">362</span></a><span class="sd">        - sm.SE3: Pose radius away from a geometry.</span>
</span><span id="MjSim.move_close-363"><a href="#MjSim.move_close-363"><span class="linenos">363</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim.move_close-364"><a href="#MjSim.move_close-364"><span class="linenos">364</span></a>
</span><span id="MjSim.move_close-365"><a href="#MjSim.move_close-365"><span class="linenos">365</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim.move_close-366"><a href="#MjSim.move_close-366"><span class="linenos">366</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim.move_close-367"><a href="#MjSim.move_close-367"><span class="linenos">367</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.move_close-368"><a href="#MjSim.move_close-368"><span class="linenos">368</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim.move_close-369"><a href="#MjSim.move_close-369"><span class="linenos">369</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim.move_close-370"><a href="#MjSim.move_close-370"><span class="linenos">370</span></a>        <span class="n">dpos</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span>
</span><span id="MjSim.move_close-371"><a href="#MjSim.move_close-371"><span class="linenos">371</span></a>        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dpos</span><span class="p">)</span>
</span><span id="MjSim.move_close-372"><a href="#MjSim.move_close-372"><span class="linenos">372</span></a>
</span><span id="MjSim.move_close-373"><a href="#MjSim.move_close-373"><span class="linenos">373</span></a>        <span class="c1"># Adjust the translation to stop within the specified radius</span>
</span><span id="MjSim.move_close-374"><a href="#MjSim.move_close-374"><span class="linenos">374</span></a>        <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="n">radius</span><span class="p">:</span>
</span><span id="MjSim.move_close-375"><a href="#MjSim.move_close-375"><span class="linenos">375</span></a>            <span class="n">pos_unit</span> <span class="o">=</span> <span class="n">dpos</span> <span class="o">/</span> <span class="n">dt</span>
</span><span id="MjSim.move_close-376"><a href="#MjSim.move_close-376"><span class="linenos">376</span></a>            <span class="n">scale</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">radius</span>
</span><span id="MjSim.move_close-377"><a href="#MjSim.move_close-377"><span class="linenos">377</span></a>            <span class="n">pos_unit</span> <span class="o">*=</span> <span class="n">scale</span>
</span><span id="MjSim.move_close-378"><a href="#MjSim.move_close-378"><span class="linenos">378</span></a>            <span class="n">T1</span> <span class="o">=</span> <span class="n">make_tf</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">pos_unit</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
</span><span id="MjSim.move_close-379"><a href="#MjSim.move_close-379"><span class="linenos">379</span></a>            <span class="c1"># T1 = sm.SE3.Rt(R=T_gripper.R, t=T_gripper.t + pos_unit)</span>
</span><span id="MjSim.move_close-380"><a href="#MjSim.move_close-380"><span class="linenos">380</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.move_close-381"><a href="#MjSim.move_close-381"><span class="linenos">381</span></a>            <span class="n">T1</span> <span class="o">=</span> <span class="n">T_w_geom</span>
</span><span id="MjSim.move_close-382"><a href="#MjSim.move_close-382"><span class="linenos">382</span></a>
</span><span id="MjSim.move_close-383"><a href="#MjSim.move_close-383"><span class="linenos">383</span></a>        <span class="k">return</span> <span class="n">T1</span>
</span></pre></div>


            <div class="docstring"><p>Move towards the object specified by geom_name until within a given radius.</p>

<p>Parameters:</p>

<ul>
<li>geom_name: str, the name of the geometry to move towards.</li>
<li>radius: float, the distance to maintain from the object.</li>
<li>vel: float, the velocity of the movement.</li>
</ul>

<p>Returns:</p>

<ul>
<li>sm.SE3: Pose radius away from a geometry.</li>
</ul>
</div>


                            </div>
                            <div id="MjSim.angle_to_next_alignment" class="classattr">
                                        <input id="MjSim.angle_to_next_alignment-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">angle_to_next_alignment</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">geom_indx</span><span class="p">:</span> <span class="nb">int</span>,</span><span class="param">	<span class="n">current_geom_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">next_geom_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">T_init</span><span class="p">:</span> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="MjSim.angle_to_next_alignment-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.angle_to_next_alignment"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.angle_to_next_alignment-385"><a href="#MjSim.angle_to_next_alignment-385"><span class="linenos">385</span></a>    <span class="k">def</span> <span class="nf">angle_to_next_alignment</span><span class="p">(</span>
</span><span id="MjSim.angle_to_next_alignment-386"><a href="#MjSim.angle_to_next_alignment-386"><span class="linenos">386</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MjSim.angle_to_next_alignment-387"><a href="#MjSim.angle_to_next_alignment-387"><span class="linenos">387</span></a>        <span class="n">geom_indx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="MjSim.angle_to_next_alignment-388"><a href="#MjSim.angle_to_next_alignment-388"><span class="linenos">388</span></a>        <span class="n">current_geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim.angle_to_next_alignment-389"><a href="#MjSim.angle_to_next_alignment-389"><span class="linenos">389</span></a>        <span class="n">next_geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim.angle_to_next_alignment-390"><a href="#MjSim.angle_to_next_alignment-390"><span class="linenos">390</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MjSim.angle_to_next_alignment-391"><a href="#MjSim.angle_to_next_alignment-391"><span class="linenos">391</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="MjSim.angle_to_next_alignment-392"><a href="#MjSim.angle_to_next_alignment-392"><span class="linenos">392</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim.angle_to_next_alignment-393"><a href="#MjSim.angle_to_next_alignment-393"><span class="linenos">393</span></a><span class="sd">        Compute the angle to align the TCP with a tangent direction between two geometries.</span>
</span><span id="MjSim.angle_to_next_alignment-394"><a href="#MjSim.angle_to_next_alignment-394"><span class="linenos">394</span></a>
</span><span id="MjSim.angle_to_next_alignment-395"><a href="#MjSim.angle_to_next_alignment-395"><span class="linenos">395</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim.angle_to_next_alignment-396"><a href="#MjSim.angle_to_next_alignment-396"><span class="linenos">396</span></a><span class="sd">        - geom_indx (int): Index of the geometry in the specification.</span>
</span><span id="MjSim.angle_to_next_alignment-397"><a href="#MjSim.angle_to_next_alignment-397"><span class="linenos">397</span></a><span class="sd">        - current_geom_name (str): Name of the current geometry.</span>
</span><span id="MjSim.angle_to_next_alignment-398"><a href="#MjSim.angle_to_next_alignment-398"><span class="linenos">398</span></a><span class="sd">        - next_geom_name (str): Name of the next geometry to align with.</span>
</span><span id="MjSim.angle_to_next_alignment-399"><a href="#MjSim.angle_to_next_alignment-399"><span class="linenos">399</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="MjSim.angle_to_next_alignment-400"><a href="#MjSim.angle_to_next_alignment-400"><span class="linenos">400</span></a>
</span><span id="MjSim.angle_to_next_alignment-401"><a href="#MjSim.angle_to_next_alignment-401"><span class="linenos">401</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim.angle_to_next_alignment-402"><a href="#MjSim.angle_to_next_alignment-402"><span class="linenos">402</span></a><span class="sd">        - float: The angle in radians for the alignment.</span>
</span><span id="MjSim.angle_to_next_alignment-403"><a href="#MjSim.angle_to_next_alignment-403"><span class="linenos">403</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim.angle_to_next_alignment-404"><a href="#MjSim.angle_to_next_alignment-404"><span class="linenos">404</span></a>
</span><span id="MjSim.angle_to_next_alignment-405"><a href="#MjSim.angle_to_next_alignment-405"><span class="linenos">405</span></a>        <span class="k">def</span> <span class="nf">tangent_points</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">):</span>
</span><span id="MjSim.angle_to_next_alignment-406"><a href="#MjSim.angle_to_next_alignment-406"><span class="linenos">406</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim.angle_to_next_alignment-407"><a href="#MjSim.angle_to_next_alignment-407"><span class="linenos">407</span></a><span class="sd">            Compute the tangent points on a circle centered at (cx, cy) with radius r</span>
</span><span id="MjSim.angle_to_next_alignment-408"><a href="#MjSim.angle_to_next_alignment-408"><span class="linenos">408</span></a><span class="sd">            from an external point (px, py).</span>
</span><span id="MjSim.angle_to_next_alignment-409"><a href="#MjSim.angle_to_next_alignment-409"><span class="linenos">409</span></a>
</span><span id="MjSim.angle_to_next_alignment-410"><a href="#MjSim.angle_to_next_alignment-410"><span class="linenos">410</span></a><span class="sd">            Parameters</span>
</span><span id="MjSim.angle_to_next_alignment-411"><a href="#MjSim.angle_to_next_alignment-411"><span class="linenos">411</span></a><span class="sd">            ----------</span>
</span><span id="MjSim.angle_to_next_alignment-412"><a href="#MjSim.angle_to_next_alignment-412"><span class="linenos">412</span></a><span class="sd">            cx, cy : float</span>
</span><span id="MjSim.angle_to_next_alignment-413"><a href="#MjSim.angle_to_next_alignment-413"><span class="linenos">413</span></a><span class="sd">                Circle center coordinates.</span>
</span><span id="MjSim.angle_to_next_alignment-414"><a href="#MjSim.angle_to_next_alignment-414"><span class="linenos">414</span></a><span class="sd">            r : float</span>
</span><span id="MjSim.angle_to_next_alignment-415"><a href="#MjSim.angle_to_next_alignment-415"><span class="linenos">415</span></a><span class="sd">                Circle radius.</span>
</span><span id="MjSim.angle_to_next_alignment-416"><a href="#MjSim.angle_to_next_alignment-416"><span class="linenos">416</span></a><span class="sd">            px, py : float</span>
</span><span id="MjSim.angle_to_next_alignment-417"><a href="#MjSim.angle_to_next_alignment-417"><span class="linenos">417</span></a><span class="sd">                External point coordinates.</span>
</span><span id="MjSim.angle_to_next_alignment-418"><a href="#MjSim.angle_to_next_alignment-418"><span class="linenos">418</span></a>
</span><span id="MjSim.angle_to_next_alignment-419"><a href="#MjSim.angle_to_next_alignment-419"><span class="linenos">419</span></a><span class="sd">            Returns</span>
</span><span id="MjSim.angle_to_next_alignment-420"><a href="#MjSim.angle_to_next_alignment-420"><span class="linenos">420</span></a><span class="sd">            -------</span>
</span><span id="MjSim.angle_to_next_alignment-421"><a href="#MjSim.angle_to_next_alignment-421"><span class="linenos">421</span></a><span class="sd">            tuple</span>
</span><span id="MjSim.angle_to_next_alignment-422"><a href="#MjSim.angle_to_next_alignment-422"><span class="linenos">422</span></a><span class="sd">                Coordinates of the two tangent points as (t1, t2), where t1 and t2</span>
</span><span id="MjSim.angle_to_next_alignment-423"><a href="#MjSim.angle_to_next_alignment-423"><span class="linenos">423</span></a><span class="sd">                are (x, y) tuples.</span>
</span><span id="MjSim.angle_to_next_alignment-424"><a href="#MjSim.angle_to_next_alignment-424"><span class="linenos">424</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="MjSim.angle_to_next_alignment-425"><a href="#MjSim.angle_to_next_alignment-425"><span class="linenos">425</span></a>            <span class="c1"># Translate the circle center and point to local coordinates</span>
</span><span id="MjSim.angle_to_next_alignment-426"><a href="#MjSim.angle_to_next_alignment-426"><span class="linenos">426</span></a>            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">])</span>
</span><span id="MjSim.angle_to_next_alignment-427"><a href="#MjSim.angle_to_next_alignment-427"><span class="linenos">427</span></a>            <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">])</span>
</span><span id="MjSim.angle_to_next_alignment-428"><a href="#MjSim.angle_to_next_alignment-428"><span class="linenos">428</span></a>            <span class="n">local_p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">c</span>
</span><span id="MjSim.angle_to_next_alignment-429"><a href="#MjSim.angle_to_next_alignment-429"><span class="linenos">429</span></a>
</span><span id="MjSim.angle_to_next_alignment-430"><a href="#MjSim.angle_to_next_alignment-430"><span class="linenos">430</span></a>            <span class="c1"># Compute tangent points in local coordinates</span>
</span><span id="MjSim.angle_to_next_alignment-431"><a href="#MjSim.angle_to_next_alignment-431"><span class="linenos">431</span></a>            <span class="n">d0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">local_p</span><span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-432"><a href="#MjSim.angle_to_next_alignment-432"><span class="linenos">432</span></a>            <span class="k">if</span> <span class="n">d0</span> <span class="o">&lt;=</span> <span class="n">r</span><span class="p">:</span>
</span><span id="MjSim.angle_to_next_alignment-433"><a href="#MjSim.angle_to_next_alignment-433"><span class="linenos">433</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MjSim.angle_to_next_alignment-434"><a href="#MjSim.angle_to_next_alignment-434"><span class="linenos">434</span></a>                    <span class="s2">&quot;Point must be outside the circle for tangent lines to exist.&quot;</span>
</span><span id="MjSim.angle_to_next_alignment-435"><a href="#MjSim.angle_to_next_alignment-435"><span class="linenos">435</span></a>                <span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-436"><a href="#MjSim.angle_to_next_alignment-436"><span class="linenos">436</span></a>
</span><span id="MjSim.angle_to_next_alignment-437"><a href="#MjSim.angle_to_next_alignment-437"><span class="linenos">437</span></a>            <span class="n">i1_local</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">local_p</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="MjSim.angle_to_next_alignment-438"><a href="#MjSim.angle_to_next_alignment-438"><span class="linenos">438</span></a>                <span class="n">d0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>
</span><span id="MjSim.angle_to_next_alignment-439"><a href="#MjSim.angle_to_next_alignment-439"><span class="linenos">439</span></a>            <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">local_p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">local_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</span><span id="MjSim.angle_to_next_alignment-440"><a href="#MjSim.angle_to_next_alignment-440"><span class="linenos">440</span></a>            <span class="n">i2_local</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">local_p</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="n">d0</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
</span><span id="MjSim.angle_to_next_alignment-441"><a href="#MjSim.angle_to_next_alignment-441"><span class="linenos">441</span></a>                <span class="n">d0</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">r</span><span class="o">**</span><span class="mi">2</span>
</span><span id="MjSim.angle_to_next_alignment-442"><a href="#MjSim.angle_to_next_alignment-442"><span class="linenos">442</span></a>            <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">local_p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">local_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</span><span id="MjSim.angle_to_next_alignment-443"><a href="#MjSim.angle_to_next_alignment-443"><span class="linenos">443</span></a>
</span><span id="MjSim.angle_to_next_alignment-444"><a href="#MjSim.angle_to_next_alignment-444"><span class="linenos">444</span></a>            <span class="c1"># Transform tangent points back to global coordinates</span>
</span><span id="MjSim.angle_to_next_alignment-445"><a href="#MjSim.angle_to_next_alignment-445"><span class="linenos">445</span></a>            <span class="n">t1</span> <span class="o">=</span> <span class="n">i1_local</span> <span class="o">+</span> <span class="n">c</span>
</span><span id="MjSim.angle_to_next_alignment-446"><a href="#MjSim.angle_to_next_alignment-446"><span class="linenos">446</span></a>            <span class="n">t2</span> <span class="o">=</span> <span class="n">i2_local</span> <span class="o">+</span> <span class="n">c</span>
</span><span id="MjSim.angle_to_next_alignment-447"><a href="#MjSim.angle_to_next_alignment-447"><span class="linenos">447</span></a>
</span><span id="MjSim.angle_to_next_alignment-448"><a href="#MjSim.angle_to_next_alignment-448"><span class="linenos">448</span></a>            <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>
</span><span id="MjSim.angle_to_next_alignment-449"><a href="#MjSim.angle_to_next_alignment-449"><span class="linenos">449</span></a>
</span><span id="MjSim.angle_to_next_alignment-450"><a href="#MjSim.angle_to_next_alignment-450"><span class="linenos">450</span></a>        <span class="k">def</span> <span class="nf">angle_between_vectors</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;ccw&quot;</span><span class="p">):</span>
</span><span id="MjSim.angle_to_next_alignment-451"><a href="#MjSim.angle_to_next_alignment-451"><span class="linenos">451</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim.angle_to_next_alignment-452"><a href="#MjSim.angle_to_next_alignment-452"><span class="linenos">452</span></a><span class="sd">            Compute the angle between two 2D vectors in the specified direction.</span>
</span><span id="MjSim.angle_to_next_alignment-453"><a href="#MjSim.angle_to_next_alignment-453"><span class="linenos">453</span></a>
</span><span id="MjSim.angle_to_next_alignment-454"><a href="#MjSim.angle_to_next_alignment-454"><span class="linenos">454</span></a><span class="sd">            Parameters</span>
</span><span id="MjSim.angle_to_next_alignment-455"><a href="#MjSim.angle_to_next_alignment-455"><span class="linenos">455</span></a><span class="sd">            ----------</span>
</span><span id="MjSim.angle_to_next_alignment-456"><a href="#MjSim.angle_to_next_alignment-456"><span class="linenos">456</span></a><span class="sd">            u, v : array-like</span>
</span><span id="MjSim.angle_to_next_alignment-457"><a href="#MjSim.angle_to_next_alignment-457"><span class="linenos">457</span></a><span class="sd">                Input 2D vectors.</span>
</span><span id="MjSim.angle_to_next_alignment-458"><a href="#MjSim.angle_to_next_alignment-458"><span class="linenos">458</span></a><span class="sd">            direction : str, optional</span>
</span><span id="MjSim.angle_to_next_alignment-459"><a href="#MjSim.angle_to_next_alignment-459"><span class="linenos">459</span></a><span class="sd">                Direction of the angle, either &quot;ccw&quot; (counterclockwise) or &quot;cw&quot; (clockwise).</span>
</span><span id="MjSim.angle_to_next_alignment-460"><a href="#MjSim.angle_to_next_alignment-460"><span class="linenos">460</span></a><span class="sd">                Default is &quot;ccw&quot;.</span>
</span><span id="MjSim.angle_to_next_alignment-461"><a href="#MjSim.angle_to_next_alignment-461"><span class="linenos">461</span></a>
</span><span id="MjSim.angle_to_next_alignment-462"><a href="#MjSim.angle_to_next_alignment-462"><span class="linenos">462</span></a><span class="sd">            Returns</span>
</span><span id="MjSim.angle_to_next_alignment-463"><a href="#MjSim.angle_to_next_alignment-463"><span class="linenos">463</span></a><span class="sd">            -------</span>
</span><span id="MjSim.angle_to_next_alignment-464"><a href="#MjSim.angle_to_next_alignment-464"><span class="linenos">464</span></a><span class="sd">            float</span>
</span><span id="MjSim.angle_to_next_alignment-465"><a href="#MjSim.angle_to_next_alignment-465"><span class="linenos">465</span></a><span class="sd">                Angle in radians (0 to 2π) in the specified direction.</span>
</span><span id="MjSim.angle_to_next_alignment-466"><a href="#MjSim.angle_to_next_alignment-466"><span class="linenos">466</span></a>
</span><span id="MjSim.angle_to_next_alignment-467"><a href="#MjSim.angle_to_next_alignment-467"><span class="linenos">467</span></a><span class="sd">            Raises</span>
</span><span id="MjSim.angle_to_next_alignment-468"><a href="#MjSim.angle_to_next_alignment-468"><span class="linenos">468</span></a><span class="sd">            ------</span>
</span><span id="MjSim.angle_to_next_alignment-469"><a href="#MjSim.angle_to_next_alignment-469"><span class="linenos">469</span></a><span class="sd">            ValueError</span>
</span><span id="MjSim.angle_to_next_alignment-470"><a href="#MjSim.angle_to_next_alignment-470"><span class="linenos">470</span></a><span class="sd">                If the `direction` is not &quot;ccw&quot; or &quot;cw&quot;.</span>
</span><span id="MjSim.angle_to_next_alignment-471"><a href="#MjSim.angle_to_next_alignment-471"><span class="linenos">471</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="MjSim.angle_to_next_alignment-472"><a href="#MjSim.angle_to_next_alignment-472"><span class="linenos">472</span></a>            <span class="c1"># Normalize the vectors</span>
</span><span id="MjSim.angle_to_next_alignment-473"><a href="#MjSim.angle_to_next_alignment-473"><span class="linenos">473</span></a>            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-474"><a href="#MjSim.angle_to_next_alignment-474"><span class="linenos">474</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-475"><a href="#MjSim.angle_to_next_alignment-475"><span class="linenos">475</span></a>
</span><span id="MjSim.angle_to_next_alignment-476"><a href="#MjSim.angle_to_next_alignment-476"><span class="linenos">476</span></a>            <span class="c1"># Dot product and cross product (z-component only)</span>
</span><span id="MjSim.angle_to_next_alignment-477"><a href="#MjSim.angle_to_next_alignment-477"><span class="linenos">477</span></a>            <span class="n">dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-478"><a href="#MjSim.angle_to_next_alignment-478"><span class="linenos">478</span></a>            <span class="n">cross</span> <span class="o">=</span> <span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="MjSim.angle_to_next_alignment-479"><a href="#MjSim.angle_to_next_alignment-479"><span class="linenos">479</span></a>
</span><span id="MjSim.angle_to_next_alignment-480"><a href="#MjSim.angle_to_next_alignment-480"><span class="linenos">480</span></a>            <span class="c1"># Compute the unsigned angle using the dot product</span>
</span><span id="MjSim.angle_to_next_alignment-481"><a href="#MjSim.angle_to_next_alignment-481"><span class="linenos">481</span></a>            <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">dot</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>  <span class="c1"># Clip for numerical stability</span>
</span><span id="MjSim.angle_to_next_alignment-482"><a href="#MjSim.angle_to_next_alignment-482"><span class="linenos">482</span></a>
</span><span id="MjSim.angle_to_next_alignment-483"><a href="#MjSim.angle_to_next_alignment-483"><span class="linenos">483</span></a>            <span class="c1"># Adjust for the specified direction</span>
</span><span id="MjSim.angle_to_next_alignment-484"><a href="#MjSim.angle_to_next_alignment-484"><span class="linenos">484</span></a>            <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="MjSim.angle_to_next_alignment-485"><a href="#MjSim.angle_to_next_alignment-485"><span class="linenos">485</span></a>                <span class="k">if</span> <span class="n">cross</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Negative cross-product means CW direction</span>
</span><span id="MjSim.angle_to_next_alignment-486"><a href="#MjSim.angle_to_next_alignment-486"><span class="linenos">486</span></a>                    <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">angle</span>
</span><span id="MjSim.angle_to_next_alignment-487"><a href="#MjSim.angle_to_next_alignment-487"><span class="linenos">487</span></a>            <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;cw&quot;</span><span class="p">:</span>
</span><span id="MjSim.angle_to_next_alignment-488"><a href="#MjSim.angle_to_next_alignment-488"><span class="linenos">488</span></a>                <span class="k">if</span> <span class="n">cross</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Positive cross-product means CCW direction</span>
</span><span id="MjSim.angle_to_next_alignment-489"><a href="#MjSim.angle_to_next_alignment-489"><span class="linenos">489</span></a>                    <span class="n">angle</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">angle</span>
</span><span id="MjSim.angle_to_next_alignment-490"><a href="#MjSim.angle_to_next_alignment-490"><span class="linenos">490</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.angle_to_next_alignment-491"><a href="#MjSim.angle_to_next_alignment-491"><span class="linenos">491</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="MjSim.angle_to_next_alignment-492"><a href="#MjSim.angle_to_next_alignment-492"><span class="linenos">492</span></a>                    <span class="sa">f</span><span class="s2">&quot;Invalid direction: </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">. Must be &#39;ccw&#39; or &#39;cw&#39;.&quot;</span>
</span><span id="MjSim.angle_to_next_alignment-493"><a href="#MjSim.angle_to_next_alignment-493"><span class="linenos">493</span></a>                <span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-494"><a href="#MjSim.angle_to_next_alignment-494"><span class="linenos">494</span></a>
</span><span id="MjSim.angle_to_next_alignment-495"><a href="#MjSim.angle_to_next_alignment-495"><span class="linenos">495</span></a>            <span class="k">return</span> <span class="n">angle</span>
</span><span id="MjSim.angle_to_next_alignment-496"><a href="#MjSim.angle_to_next_alignment-496"><span class="linenos">496</span></a>
</span><span id="MjSim.angle_to_next_alignment-497"><a href="#MjSim.angle_to_next_alignment-497"><span class="linenos">497</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim.angle_to_next_alignment-498"><a href="#MjSim.angle_to_next_alignment-498"><span class="linenos">498</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim.angle_to_next_alignment-499"><a href="#MjSim.angle_to_next_alignment-499"><span class="linenos">499</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.angle_to_next_alignment-500"><a href="#MjSim.angle_to_next_alignment-500"><span class="linenos">500</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim.angle_to_next_alignment-501"><a href="#MjSim.angle_to_next_alignment-501"><span class="linenos">501</span></a>
</span><span id="MjSim.angle_to_next_alignment-502"><a href="#MjSim.angle_to_next_alignment-502"><span class="linenos">502</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">current_geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-503"><a href="#MjSim.angle_to_next_alignment-503"><span class="linenos">503</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">next_geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span><span class="o">.</span><span class="n">t</span>
</span><span id="MjSim.angle_to_next_alignment-504"><a href="#MjSim.angle_to_next_alignment-504"><span class="linenos">504</span></a>        <span class="n">c</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span>
</span><span id="MjSim.angle_to_next_alignment-505"><a href="#MjSim.angle_to_next_alignment-505"><span class="linenos">505</span></a>
</span><span id="MjSim.angle_to_next_alignment-506"><a href="#MjSim.angle_to_next_alignment-506"><span class="linenos">506</span></a>        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-507"><a href="#MjSim.angle_to_next_alignment-507"><span class="linenos">507</span></a>
</span><span id="MjSim.angle_to_next_alignment-508"><a href="#MjSim.angle_to_next_alignment-508"><span class="linenos">508</span></a>        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">tangent_points</span><span class="p">(</span><span class="n">cx</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cy</span><span class="o">=</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">r</span><span class="o">=</span><span class="n">d</span><span class="p">,</span> <span class="n">px</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">py</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MjSim.angle_to_next_alignment-509"><a href="#MjSim.angle_to_next_alignment-509"><span class="linenos">509</span></a>
</span><span id="MjSim.angle_to_next_alignment-510"><a href="#MjSim.angle_to_next_alignment-510"><span class="linenos">510</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim.angle_to_next_alignment-511"><a href="#MjSim.angle_to_next_alignment-511"><span class="linenos">511</span></a>        <span class="n">v1</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">-</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim.angle_to_next_alignment-512"><a href="#MjSim.angle_to_next_alignment-512"><span class="linenos">512</span></a>        <span class="n">v2</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim.angle_to_next_alignment-513"><a href="#MjSim.angle_to_next_alignment-513"><span class="linenos">513</span></a>
</span><span id="MjSim.angle_to_next_alignment-514"><a href="#MjSim.angle_to_next_alignment-514"><span class="linenos">514</span></a>        <span class="n">theta1</span> <span class="o">=</span> <span class="n">angle_between_vectors</span><span class="p">(</span>
</span><span id="MjSim.angle_to_next_alignment-515"><a href="#MjSim.angle_to_next_alignment-515"><span class="linenos">515</span></a>            <span class="n">u</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">geom_indx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim.angle_to_next_alignment-516"><a href="#MjSim.angle_to_next_alignment-516"><span class="linenos">516</span></a>        <span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-517"><a href="#MjSim.angle_to_next_alignment-517"><span class="linenos">517</span></a>        <span class="n">theta2</span> <span class="o">=</span> <span class="n">angle_between_vectors</span><span class="p">(</span>
</span><span id="MjSim.angle_to_next_alignment-518"><a href="#MjSim.angle_to_next_alignment-518"><span class="linenos">518</span></a>            <span class="n">u</span><span class="p">,</span> <span class="n">v2</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;o</span><span class="si">{</span><span class="n">geom_indx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][</span><span class="s2">&quot;dir&quot;</span><span class="p">]</span>
</span><span id="MjSim.angle_to_next_alignment-519"><a href="#MjSim.angle_to_next_alignment-519"><span class="linenos">519</span></a>        <span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-520"><a href="#MjSim.angle_to_next_alignment-520"><span class="linenos">520</span></a>        <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="nb">min</span><span class="p">(</span><span class="n">theta1</span><span class="p">,</span> <span class="n">theta2</span><span class="p">)</span>
</span><span id="MjSim.angle_to_next_alignment-521"><a href="#MjSim.angle_to_next_alignment-521"><span class="linenos">521</span></a>
</span><span id="MjSim.angle_to_next_alignment-522"><a href="#MjSim.angle_to_next_alignment-522"><span class="linenos">522</span></a>        <span class="k">return</span> <span class="n">theta</span>
</span></pre></div>


            <div class="docstring"><p>Compute the angle to align the TCP with a tangent direction between two geometries.</p>

<p>Parameters:</p>

<ul>
<li>geom_indx (int): Index of the geometry in the specification.</li>
<li>current_geom_name (str): Name of the current geometry.</li>
<li>next_geom_name (str): Name of the next geometry to align with.</li>
<li>T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</li>
</ul>

<p>Returns:</p>

<ul>
<li>float: The angle in radians for the alignment.</li>
</ul>
</div>


                            </div>
                            <div id="MjSim.rotate_about" class="classattr">
                                        <input id="MjSim.rotate_about-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rotate_about</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">phi</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span>,</span><span class="param">	<span class="n">T_init</span><span class="p">:</span> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span>:</span></span>

                <label class="view-source-button" for="MjSim.rotate_about-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.rotate_about"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.rotate_about-524"><a href="#MjSim.rotate_about-524"><span class="linenos">524</span></a>    <span class="k">def</span> <span class="nf">rotate_about</span><span class="p">(</span>
</span><span id="MjSim.rotate_about-525"><a href="#MjSim.rotate_about-525"><span class="linenos">525</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MjSim.rotate_about-526"><a href="#MjSim.rotate_about-526"><span class="linenos">526</span></a>        <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim.rotate_about-527"><a href="#MjSim.rotate_about-527"><span class="linenos">527</span></a>        <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim.rotate_about-528"><a href="#MjSim.rotate_about-528"><span class="linenos">528</span></a>        <span class="n">phi</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="MjSim.rotate_about-529"><a href="#MjSim.rotate_about-529"><span class="linenos">529</span></a>        <span class="n">n_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="MjSim.rotate_about-530"><a href="#MjSim.rotate_about-530"><span class="linenos">530</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MjSim.rotate_about-531"><a href="#MjSim.rotate_about-531"><span class="linenos">531</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim.rotate_about-532"><a href="#MjSim.rotate_about-532"><span class="linenos">532</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim.rotate_about-533"><a href="#MjSim.rotate_about-533"><span class="linenos">533</span></a><span class="sd">        Generate a pose rotating the TCP relative to a specified geometry.</span>
</span><span id="MjSim.rotate_about-534"><a href="#MjSim.rotate_about-534"><span class="linenos">534</span></a>
</span><span id="MjSim.rotate_about-535"><a href="#MjSim.rotate_about-535"><span class="linenos">535</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim.rotate_about-536"><a href="#MjSim.rotate_about-536"><span class="linenos">536</span></a><span class="sd">        - geom_name (str): Name of the geometry to rotate around.</span>
</span><span id="MjSim.rotate_about-537"><a href="#MjSim.rotate_about-537"><span class="linenos">537</span></a><span class="sd">        - dir (str): Direction of rotation, &quot;ccw&quot; for counterclockwise or &quot;cw&quot; for clockwise.</span>
</span><span id="MjSim.rotate_about-538"><a href="#MjSim.rotate_about-538"><span class="linenos">538</span></a><span class="sd">        - phi (float): Angle of rotation in radians.</span>
</span><span id="MjSim.rotate_about-539"><a href="#MjSim.rotate_about-539"><span class="linenos">539</span></a><span class="sd">        - n_steps (int): Number of steps in the trajectory.</span>
</span><span id="MjSim.rotate_about-540"><a href="#MjSim.rotate_about-540"><span class="linenos">540</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="MjSim.rotate_about-541"><a href="#MjSim.rotate_about-541"><span class="linenos">541</span></a>
</span><span id="MjSim.rotate_about-542"><a href="#MjSim.rotate_about-542"><span class="linenos">542</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim.rotate_about-543"><a href="#MjSim.rotate_about-543"><span class="linenos">543</span></a><span class="sd">        - sm.SE3: Rotated pose.</span>
</span><span id="MjSim.rotate_about-544"><a href="#MjSim.rotate_about-544"><span class="linenos">544</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim.rotate_about-545"><a href="#MjSim.rotate_about-545"><span class="linenos">545</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim.rotate_about-546"><a href="#MjSim.rotate_about-546"><span class="linenos">546</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim.rotate_about-547"><a href="#MjSim.rotate_about-547"><span class="linenos">547</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.rotate_about-548"><a href="#MjSim.rotate_about-548"><span class="linenos">548</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim.rotate_about-549"><a href="#MjSim.rotate_about-549"><span class="linenos">549</span></a>
</span><span id="MjSim.rotate_about-550"><a href="#MjSim.rotate_about-550"><span class="linenos">550</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim.rotate_about-551"><a href="#MjSim.rotate_about-551"><span class="linenos">551</span></a>        <span class="n">c_traj</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_w_tcp</span><span class="p">]</span>
</span><span id="MjSim.rotate_about-552"><a href="#MjSim.rotate_about-552"><span class="linenos">552</span></a>        <span class="n">phi</span> <span class="o">=</span> <span class="o">-</span><span class="n">phi</span> <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span> <span class="k">else</span> <span class="n">phi</span>
</span><span id="MjSim.rotate_about-553"><a href="#MjSim.rotate_about-553"><span class="linenos">553</span></a>        <span class="k">for</span> <span class="n">phi</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">):</span>
</span><span id="MjSim.rotate_about-554"><a href="#MjSim.rotate_about-554"><span class="linenos">554</span></a>            <span class="n">T_tcp_geom</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">inv</span><span class="p">()</span> <span class="o">*</span> <span class="n">T_w_tcp</span>
</span><span id="MjSim.rotate_about-555"><a href="#MjSim.rotate_about-555"><span class="linenos">555</span></a>            <span class="n">Rz</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
</span><span id="MjSim.rotate_about-556"><a href="#MjSim.rotate_about-556"><span class="linenos">556</span></a>            <span class="n">T_w_tcp_new</span> <span class="o">=</span> <span class="n">T_w_geom</span> <span class="o">*</span> <span class="n">Rz</span> <span class="o">*</span> <span class="n">T_tcp_geom</span>
</span><span id="MjSim.rotate_about-557"><a href="#MjSim.rotate_about-557"><span class="linenos">557</span></a>            <span class="n">c_traj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T_w_tcp_new</span><span class="p">)</span>
</span><span id="MjSim.rotate_about-558"><a href="#MjSim.rotate_about-558"><span class="linenos">558</span></a>        <span class="k">return</span> <span class="n">c_traj</span>
</span></pre></div>


            <div class="docstring"><p>Generate a pose rotating the TCP relative to a specified geometry.</p>

<p>Parameters:</p>

<ul>
<li>geom_name (str): Name of the geometry to rotate around.</li>
<li>dir (str): Direction of rotation, "ccw" for counterclockwise or "cw" for clockwise.</li>
<li>phi (float): Angle of rotation in radians.</li>
<li>n_steps (int): Number of steps in the trajectory.</li>
<li>T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</li>
</ul>

<p>Returns:</p>

<ul>
<li>sm.SE3: Rotated pose.</li>
</ul>
</div>


                            </div>
                            <div id="MjSim.opp1" class="classattr">
                                        <input id="MjSim.opp1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">opp1</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">h</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">T_init</span><span class="p">:</span> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span>:</span></span>

                <label class="view-source-button" for="MjSim.opp1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.opp1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.opp1-560"><a href="#MjSim.opp1-560"><span class="linenos">560</span></a>    <span class="k">def</span> <span class="nf">opp1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim.opp1-561"><a href="#MjSim.opp1-561"><span class="linenos">561</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim.opp1-562"><a href="#MjSim.opp1-562"><span class="linenos">562</span></a><span class="sd">        Generate a Cartesian pose from the end effector pose to a new pose above an obstacle.</span>
</span><span id="MjSim.opp1-563"><a href="#MjSim.opp1-563"><span class="linenos">563</span></a>
</span><span id="MjSim.opp1-564"><a href="#MjSim.opp1-564"><span class="linenos">564</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim.opp1-565"><a href="#MjSim.opp1-565"><span class="linenos">565</span></a><span class="sd">        - h (float): Height offset above the obstacle.</span>
</span><span id="MjSim.opp1-566"><a href="#MjSim.opp1-566"><span class="linenos">566</span></a><span class="sd">        - geom_name (str): Name of the obstacle geometry.</span>
</span><span id="MjSim.opp1-567"><a href="#MjSim.opp1-567"><span class="linenos">567</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="MjSim.opp1-568"><a href="#MjSim.opp1-568"><span class="linenos">568</span></a>
</span><span id="MjSim.opp1-569"><a href="#MjSim.opp1-569"><span class="linenos">569</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim.opp1-570"><a href="#MjSim.opp1-570"><span class="linenos">570</span></a><span class="sd">        - sm.SE3: Target pose above the obstacle.</span>
</span><span id="MjSim.opp1-571"><a href="#MjSim.opp1-571"><span class="linenos">571</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim.opp1-572"><a href="#MjSim.opp1-572"><span class="linenos">572</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim.opp1-573"><a href="#MjSim.opp1-573"><span class="linenos">573</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim.opp1-574"><a href="#MjSim.opp1-574"><span class="linenos">574</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.opp1-575"><a href="#MjSim.opp1-575"><span class="linenos">575</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim.opp1-576"><a href="#MjSim.opp1-576"><span class="linenos">576</span></a>
</span><span id="MjSim.opp1-577"><a href="#MjSim.opp1-577"><span class="linenos">577</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim.opp1-578"><a href="#MjSim.opp1-578"><span class="linenos">578</span></a>        <span class="n">Tz</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Tz</span><span class="p">(</span><span class="n">h</span> <span class="o">+</span> <span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
</span><span id="MjSim.opp1-579"><a href="#MjSim.opp1-579"><span class="linenos">579</span></a>        <span class="n">T_w_up</span> <span class="o">=</span> <span class="n">Tz</span> <span class="o">@</span> <span class="n">T_w_tcp</span>
</span><span id="MjSim.opp1-580"><a href="#MjSim.opp1-580"><span class="linenos">580</span></a>
</span><span id="MjSim.opp1-581"><a href="#MjSim.opp1-581"><span class="linenos">581</span></a>        <span class="c1"># T = ctraj(T_start=T_w_tcp, T_end=T_world_up, t=n_steps)</span>
</span><span id="MjSim.opp1-582"><a href="#MjSim.opp1-582"><span class="linenos">582</span></a>        <span class="c1"># # T = rtb.ctraj(T0=T_world_tcp, T1=T_world_up, t=n_steps)</span>
</span><span id="MjSim.opp1-583"><a href="#MjSim.opp1-583"><span class="linenos">583</span></a>        <span class="c1"># poses.extend(T)</span>
</span><span id="MjSim.opp1-584"><a href="#MjSim.opp1-584"><span class="linenos">584</span></a>        <span class="c1"># return poses</span>
</span><span id="MjSim.opp1-585"><a href="#MjSim.opp1-585"><span class="linenos">585</span></a>        <span class="k">return</span> <span class="n">T_w_up</span>
</span></pre></div>


            <div class="docstring"><p>Generate a Cartesian pose from the end effector pose to a new pose above an obstacle.</p>

<p>Parameters:</p>

<ul>
<li>h (float): Height offset above the obstacle.</li>
<li>geom_name (str): Name of the obstacle geometry.</li>
<li>T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</li>
</ul>

<p>Returns:</p>

<ul>
<li>sm.SE3: Target pose above the obstacle.</li>
</ul>
</div>


                            </div>
                            <div id="MjSim.opp2" class="classattr">
                                        <input id="MjSim.opp2-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">opp2</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">theta</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">T_init</span><span class="p">:</span> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span>:</span></span>

                <label class="view-source-button" for="MjSim.opp2-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.opp2"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.opp2-587"><a href="#MjSim.opp2-587"><span class="linenos">587</span></a>    <span class="k">def</span> <span class="nf">opp2</span><span class="p">(</span>
</span><span id="MjSim.opp2-588"><a href="#MjSim.opp2-588"><span class="linenos">588</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="MjSim.opp2-589"><a href="#MjSim.opp2-589"><span class="linenos">589</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim.opp2-590"><a href="#MjSim.opp2-590"><span class="linenos">590</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim.opp2-591"><a href="#MjSim.opp2-591"><span class="linenos">591</span></a><span class="sd">        Generate a Cartesian pose rotated theta raltive to some obstacle.</span>
</span><span id="MjSim.opp2-592"><a href="#MjSim.opp2-592"><span class="linenos">592</span></a>
</span><span id="MjSim.opp2-593"><a href="#MjSim.opp2-593"><span class="linenos">593</span></a><span class="sd">        Parameters:</span>
</span><span id="MjSim.opp2-594"><a href="#MjSim.opp2-594"><span class="linenos">594</span></a><span class="sd">        - theta (float): Angle of rotation in radians.</span>
</span><span id="MjSim.opp2-595"><a href="#MjSim.opp2-595"><span class="linenos">595</span></a><span class="sd">        - dir (str): Direction of rotation, &quot;ccw&quot; or &quot;cw&quot;.</span>
</span><span id="MjSim.opp2-596"><a href="#MjSim.opp2-596"><span class="linenos">596</span></a><span class="sd">        - geom_name (str): Name of the obstacle geometry.</span>
</span><span id="MjSim.opp2-597"><a href="#MjSim.opp2-597"><span class="linenos">597</span></a><span class="sd">        - T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</span>
</span><span id="MjSim.opp2-598"><a href="#MjSim.opp2-598"><span class="linenos">598</span></a>
</span><span id="MjSim.opp2-599"><a href="#MjSim.opp2-599"><span class="linenos">599</span></a><span class="sd">        Returns:</span>
</span><span id="MjSim.opp2-600"><a href="#MjSim.opp2-600"><span class="linenos">600</span></a><span class="sd">        - sm.SE3: Target pose after the rotation.</span>
</span><span id="MjSim.opp2-601"><a href="#MjSim.opp2-601"><span class="linenos">601</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim.opp2-602"><a href="#MjSim.opp2-602"><span class="linenos">602</span></a>
</span><span id="MjSim.opp2-603"><a href="#MjSim.opp2-603"><span class="linenos">603</span></a>        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="MjSim.opp2-604"><a href="#MjSim.opp2-604"><span class="linenos">604</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span>
</span><span id="MjSim.opp2-605"><a href="#MjSim.opp2-605"><span class="linenos">605</span></a>        <span class="k">elif</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;cw&quot;</span><span class="p">:</span>
</span><span id="MjSim.opp2-606"><a href="#MjSim.opp2-606"><span class="linenos">606</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span>
</span><span id="MjSim.opp2-607"><a href="#MjSim.opp2-607"><span class="linenos">607</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.opp2-608"><a href="#MjSim.opp2-608"><span class="linenos">608</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;dir must be either &quot;ccw&quot; or &quot;cw&quot;, but &quot;</span><span class="si">{</span><span class="nb">dir</span><span class="si">}</span><span class="s1">&quot; was given&#39;</span><span class="p">)</span>
</span><span id="MjSim.opp2-609"><a href="#MjSim.opp2-609"><span class="linenos">609</span></a>
</span><span id="MjSim.opp2-610"><a href="#MjSim.opp2-610"><span class="linenos">610</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim.opp2-611"><a href="#MjSim.opp2-611"><span class="linenos">611</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim.opp2-612"><a href="#MjSim.opp2-612"><span class="linenos">612</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.opp2-613"><a href="#MjSim.opp2-613"><span class="linenos">613</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim.opp2-614"><a href="#MjSim.opp2-614"><span class="linenos">614</span></a>
</span><span id="MjSim.opp2-615"><a href="#MjSim.opp2-615"><span class="linenos">615</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim.opp2-616"><a href="#MjSim.opp2-616"><span class="linenos">616</span></a>
</span><span id="MjSim.opp2-617"><a href="#MjSim.opp2-617"><span class="linenos">617</span></a>        <span class="c1"># angle to slign axis with direction towards obstacle</span>
</span><span id="MjSim.opp2-618"><a href="#MjSim.opp2-618"><span class="linenos">618</span></a>        <span class="k">def</span> <span class="nf">get_phi</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="MjSim.opp2-619"><a href="#MjSim.opp2-619"><span class="linenos">619</span></a>            <span class="n">tcp_y</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">[:</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="MjSim.opp2-620"><a href="#MjSim.opp2-620"><span class="linenos">620</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">tcp_y</span>
</span><span id="MjSim.opp2-621"><a href="#MjSim.opp2-621"><span class="linenos">621</span></a>            <span class="n">b</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim.opp2-622"><a href="#MjSim.opp2-622"><span class="linenos">622</span></a>            <span class="k">return</span> <span class="n">angle</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span id="MjSim.opp2-623"><a href="#MjSim.opp2-623"><span class="linenos">623</span></a>
</span><span id="MjSim.opp2-624"><a href="#MjSim.opp2-624"><span class="linenos">624</span></a>        <span class="c1"># the angle to correct the direction and the deviation angle theta</span>
</span><span id="MjSim.opp2-625"><a href="#MjSim.opp2-625"><span class="linenos">625</span></a>        <span class="n">theta</span> <span class="o">=</span> <span class="n">get_phi</span><span class="p">()</span> <span class="o">+</span> <span class="n">theta</span>
</span><span id="MjSim.opp2-626"><a href="#MjSim.opp2-626"><span class="linenos">626</span></a>
</span><span id="MjSim.opp2-627"><a href="#MjSim.opp2-627"><span class="linenos">627</span></a>        <span class="k">return</span> <span class="n">T_w_tcp</span> <span class="o">@</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="o">.</span><span class="n">Rz</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generate a Cartesian pose rotated theta raltive to some obstacle.</p>

<p>Parameters:</p>

<ul>
<li>theta (float): Angle of rotation in radians.</li>
<li>dir (str): Direction of rotation, "ccw" or "cw".</li>
<li>geom_name (str): Name of the obstacle geometry.</li>
<li>T_init (sm.SE3, optional): Initial pose of the TCP. If None, fetches the current TCP pose.</li>
</ul>

<p>Returns:</p>

<ul>
<li>sm.SE3: Target pose after the rotation.</li>
</ul>
</div>


                            </div>
                            <div id="MjSim.opp3" class="classattr">
                                        <input id="MjSim.opp3-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">opp3</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">delta</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">theta</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">T_init</span><span class="p">:</span> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span>:</span></span>

                <label class="view-source-button" for="MjSim.opp3-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.opp3"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.opp3-629"><a href="#MjSim.opp3-629"><span class="linenos">629</span></a>    <span class="k">def</span> <span class="nf">opp3</span><span class="p">(</span>
</span><span id="MjSim.opp3-630"><a href="#MjSim.opp3-630"><span class="linenos">630</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="MjSim.opp3-631"><a href="#MjSim.opp3-631"><span class="linenos">631</span></a>        <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="MjSim.opp3-632"><a href="#MjSim.opp3-632"><span class="linenos">632</span></a>        <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
</span><span id="MjSim.opp3-633"><a href="#MjSim.opp3-633"><span class="linenos">633</span></a>        <span class="nb">dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim.opp3-634"><a href="#MjSim.opp3-634"><span class="linenos">634</span></a>        <span class="n">geom_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="MjSim.opp3-635"><a href="#MjSim.opp3-635"><span class="linenos">635</span></a>        <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="MjSim.opp3-636"><a href="#MjSim.opp3-636"><span class="linenos">636</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim.opp3-637"><a href="#MjSim.opp3-637"><span class="linenos">637</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim.opp3-638"><a href="#MjSim.opp3-638"><span class="linenos">638</span></a><span class="sd">        Compute a target pose for the robot&#39;s end-effector based on positional and rotational offsets.</span>
</span><span id="MjSim.opp3-639"><a href="#MjSim.opp3-639"><span class="linenos">639</span></a>
</span><span id="MjSim.opp3-640"><a href="#MjSim.opp3-640"><span class="linenos">640</span></a><span class="sd">        Parameters</span>
</span><span id="MjSim.opp3-641"><a href="#MjSim.opp3-641"><span class="linenos">641</span></a><span class="sd">        ----------</span>
</span><span id="MjSim.opp3-642"><a href="#MjSim.opp3-642"><span class="linenos">642</span></a><span class="sd">        delta : float</span>
</span><span id="MjSim.opp3-643"><a href="#MjSim.opp3-643"><span class="linenos">643</span></a><span class="sd">            Distance offset from the current end-effector position towards the target geometry in the xy-plane.</span>
</span><span id="MjSim.opp3-644"><a href="#MjSim.opp3-644"><span class="linenos">644</span></a><span class="sd">        theta : float</span>
</span><span id="MjSim.opp3-645"><a href="#MjSim.opp3-645"><span class="linenos">645</span></a><span class="sd">            Angle of rotation around the z-axis (in radians).</span>
</span><span id="MjSim.opp3-646"><a href="#MjSim.opp3-646"><span class="linenos">646</span></a><span class="sd">        dir : str</span>
</span><span id="MjSim.opp3-647"><a href="#MjSim.opp3-647"><span class="linenos">647</span></a><span class="sd">            Direction of rotation (&quot;ccw&quot; for counterclockwise, any other value for clockwise).</span>
</span><span id="MjSim.opp3-648"><a href="#MjSim.opp3-648"><span class="linenos">648</span></a><span class="sd">        geom_name : str</span>
</span><span id="MjSim.opp3-649"><a href="#MjSim.opp3-649"><span class="linenos">649</span></a><span class="sd">            Name of the target geometry to compute the offset and rotation with respect to.</span>
</span><span id="MjSim.opp3-650"><a href="#MjSim.opp3-650"><span class="linenos">650</span></a><span class="sd">        T_init : sm.SE3, optional</span>
</span><span id="MjSim.opp3-651"><a href="#MjSim.opp3-651"><span class="linenos">651</span></a><span class="sd">            Initial pose of the end-effector. If None, the current pose is fetched from the robot, by default None.</span>
</span><span id="MjSim.opp3-652"><a href="#MjSim.opp3-652"><span class="linenos">652</span></a>
</span><span id="MjSim.opp3-653"><a href="#MjSim.opp3-653"><span class="linenos">653</span></a><span class="sd">        Returns</span>
</span><span id="MjSim.opp3-654"><a href="#MjSim.opp3-654"><span class="linenos">654</span></a><span class="sd">        -------</span>
</span><span id="MjSim.opp3-655"><a href="#MjSim.opp3-655"><span class="linenos">655</span></a><span class="sd">        sm.SE3</span>
</span><span id="MjSim.opp3-656"><a href="#MjSim.opp3-656"><span class="linenos">656</span></a><span class="sd">            The computed target pose in the world frame.</span>
</span><span id="MjSim.opp3-657"><a href="#MjSim.opp3-657"><span class="linenos">657</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim.opp3-658"><a href="#MjSim.opp3-658"><span class="linenos">658</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim.opp3-659"><a href="#MjSim.opp3-659"><span class="linenos">659</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim.opp3-660"><a href="#MjSim.opp3-660"><span class="linenos">660</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.opp3-661"><a href="#MjSim.opp3-661"><span class="linenos">661</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim.opp3-662"><a href="#MjSim.opp3-662"><span class="linenos">662</span></a>
</span><span id="MjSim.opp3-663"><a href="#MjSim.opp3-663"><span class="linenos">663</span></a>        <span class="n">T_w_geom</span> <span class="o">=</span> <span class="n">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">geom_name</span><span class="p">,</span> <span class="n">ObjType</span><span class="o">.</span><span class="n">GEOM</span><span class="p">)</span>
</span><span id="MjSim.opp3-664"><a href="#MjSim.opp3-664"><span class="linenos">664</span></a>
</span><span id="MjSim.opp3-665"><a href="#MjSim.opp3-665"><span class="linenos">665</span></a>        <span class="n">t_tcp_geom</span> <span class="o">=</span> <span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span id="MjSim.opp3-666"><a href="#MjSim.opp3-666"><span class="linenos">666</span></a>        <span class="n">t_tcp_geom_norm</span> <span class="o">=</span> <span class="n">t_tcp_geom</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t_tcp_geom</span><span class="p">)</span>
</span><span id="MjSim.opp3-667"><a href="#MjSim.opp3-667"><span class="linenos">667</span></a>        <span class="n">t_tcp_target</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_tcp_geom_norm</span><span class="p">))</span> <span class="o">+</span> <span class="n">t_tcp_geom</span>
</span><span id="MjSim.opp3-668"><a href="#MjSim.opp3-668"><span class="linenos">668</span></a>
</span><span id="MjSim.opp3-669"><a href="#MjSim.opp3-669"><span class="linenos">669</span></a>        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="MjSim.opp3-670"><a href="#MjSim.opp3-670"><span class="linenos">670</span></a>            <span class="n">theta</span> <span class="o">=</span> <span class="o">-</span><span class="n">theta</span>
</span><span id="MjSim.opp3-671"><a href="#MjSim.opp3-671"><span class="linenos">671</span></a>
</span><span id="MjSim.opp3-672"><a href="#MjSim.opp3-672"><span class="linenos">672</span></a>        <span class="n">t_tcp_target_rot</span> <span class="o">=</span> <span class="n">rotate_vector_2d</span><span class="p">(</span><span class="n">t_tcp_target</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
</span><span id="MjSim.opp3-673"><a href="#MjSim.opp3-673"><span class="linenos">673</span></a>
</span><span id="MjSim.opp3-674"><a href="#MjSim.opp3-674"><span class="linenos">674</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_tcp_target_rot</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="MjSim.opp3-675"><a href="#MjSim.opp3-675"><span class="linenos">675</span></a>
</span><span id="MjSim.opp3-676"><a href="#MjSim.opp3-676"><span class="linenos">676</span></a>        <span class="n">rz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="MjSim.opp3-677"><a href="#MjSim.opp3-677"><span class="linenos">677</span></a>        <span class="n">rx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="MjSim.opp3-678"><a href="#MjSim.opp3-678"><span class="linenos">678</span></a>            <span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">T_w_geom</span><span class="o">.</span><span class="n">t</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="p">[:</span><span class="mi">2</span><span class="p">]),</span> <span class="mi">0</span>
</span><span id="MjSim.opp3-679"><a href="#MjSim.opp3-679"><span class="linenos">679</span></a>        <span class="p">)</span>
</span><span id="MjSim.opp3-680"><a href="#MjSim.opp3-680"><span class="linenos">680</span></a>        <span class="k">if</span> <span class="nb">dir</span> <span class="o">==</span> <span class="s2">&quot;ccw&quot;</span><span class="p">:</span>
</span><span id="MjSim.opp3-681"><a href="#MjSim.opp3-681"><span class="linenos">681</span></a>            <span class="n">rx</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="MjSim.opp3-682"><a href="#MjSim.opp3-682"><span class="linenos">682</span></a>        <span class="n">ry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rz</span><span class="p">,</span> <span class="n">rx</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">rz</span><span class="p">,</span> <span class="n">rx</span><span class="p">))</span>
</span><span id="MjSim.opp3-683"><a href="#MjSim.opp3-683"><span class="linenos">683</span></a>
</span><span id="MjSim.opp3-684"><a href="#MjSim.opp3-684"><span class="linenos">684</span></a>        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">))</span>
</span><span id="MjSim.opp3-685"><a href="#MjSim.opp3-685"><span class="linenos">685</span></a>
</span><span id="MjSim.opp3-686"><a href="#MjSim.opp3-686"><span class="linenos">686</span></a>        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="MjSim.opp3-687"><a href="#MjSim.opp3-687"><span class="linenos">687</span></a>            <span class="n">ry</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="MjSim.opp3-688"><a href="#MjSim.opp3-688"><span class="linenos">688</span></a>            <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">rx</span><span class="p">,</span> <span class="n">ry</span><span class="p">,</span> <span class="n">rz</span><span class="p">))</span>
</span><span id="MjSim.opp3-689"><a href="#MjSim.opp3-689"><span class="linenos">689</span></a>
</span><span id="MjSim.opp3-690"><a href="#MjSim.opp3-690"><span class="linenos">690</span></a>        <span class="n">T_w_target</span> <span class="o">=</span> <span class="n">make_tf</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="n">R</span><span class="p">)</span>
</span><span id="MjSim.opp3-691"><a href="#MjSim.opp3-691"><span class="linenos">691</span></a>
</span><span id="MjSim.opp3-692"><a href="#MjSim.opp3-692"><span class="linenos">692</span></a>        <span class="k">return</span> <span class="n">T_w_target</span>
</span></pre></div>


            <div class="docstring"><p>Compute a target pose for the robot's end-effector based on positional and rotational offsets.</p>

<h2 id="parameters">Parameters</h2>

<p>delta : float
    Distance offset from the current end-effector position towards the target geometry in the xy-plane.
theta : float
    Angle of rotation around the z-axis (in radians).
dir : str
    Direction of rotation ("ccw" for counterclockwise, any other value for clockwise).
geom_name : str
    Name of the target geometry to compute the offset and rotation with respect to.
T_init : sm.SE3, optional
    Initial pose of the end-effector. If None, the current pose is fetched from the robot, by default None.</p>

<h2 id="returns">Returns</h2>

<p>sm.SE3
    The computed target pose in the world frame.</p>
</div>


                            </div>
                            <div id="MjSim.opp4" class="classattr">
                                        <input id="MjSim.opp4-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">opp4</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">z_height</span><span class="p">:</span> <span class="nb">float</span>,</span><span class="param">	<span class="n">T_init</span><span class="p">:</span> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n">spatialmath</span><span class="o">.</span><span class="n">pose3d</span><span class="o">.</span><span class="n">SE3</span>:</span></span>

                <label class="view-source-button" for="MjSim.opp4-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MjSim.opp4"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MjSim.opp4-694"><a href="#MjSim.opp4-694"><span class="linenos">694</span></a>    <span class="k">def</span> <span class="nf">opp4</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z_height</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T_init</span><span class="p">:</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">sm</span><span class="o">.</span><span class="n">SE3</span><span class="p">:</span>
</span><span id="MjSim.opp4-695"><a href="#MjSim.opp4-695"><span class="linenos">695</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="MjSim.opp4-696"><a href="#MjSim.opp4-696"><span class="linenos">696</span></a><span class="sd">        Compute a target pose for the robot&#39;s end-effector with a specified z-height.</span>
</span><span id="MjSim.opp4-697"><a href="#MjSim.opp4-697"><span class="linenos">697</span></a>
</span><span id="MjSim.opp4-698"><a href="#MjSim.opp4-698"><span class="linenos">698</span></a><span class="sd">        Parameters</span>
</span><span id="MjSim.opp4-699"><a href="#MjSim.opp4-699"><span class="linenos">699</span></a><span class="sd">        ----------</span>
</span><span id="MjSim.opp4-700"><a href="#MjSim.opp4-700"><span class="linenos">700</span></a><span class="sd">        z_height : float</span>
</span><span id="MjSim.opp4-701"><a href="#MjSim.opp4-701"><span class="linenos">701</span></a><span class="sd">            Desired height (z-coordinate) for the end-effector in the world frame.</span>
</span><span id="MjSim.opp4-702"><a href="#MjSim.opp4-702"><span class="linenos">702</span></a><span class="sd">        T_init : sm.SE3, optional</span>
</span><span id="MjSim.opp4-703"><a href="#MjSim.opp4-703"><span class="linenos">703</span></a><span class="sd">            Initial pose of the end-effector. If None, the current pose is fetched from the robot, by default None.</span>
</span><span id="MjSim.opp4-704"><a href="#MjSim.opp4-704"><span class="linenos">704</span></a>
</span><span id="MjSim.opp4-705"><a href="#MjSim.opp4-705"><span class="linenos">705</span></a><span class="sd">        Returns</span>
</span><span id="MjSim.opp4-706"><a href="#MjSim.opp4-706"><span class="linenos">706</span></a><span class="sd">        -------</span>
</span><span id="MjSim.opp4-707"><a href="#MjSim.opp4-707"><span class="linenos">707</span></a><span class="sd">        sm.SE3</span>
</span><span id="MjSim.opp4-708"><a href="#MjSim.opp4-708"><span class="linenos">708</span></a><span class="sd">            The computed target pose with the specified z-height.</span>
</span><span id="MjSim.opp4-709"><a href="#MjSim.opp4-709"><span class="linenos">709</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MjSim.opp4-710"><a href="#MjSim.opp4-710"><span class="linenos">710</span></a>        <span class="k">if</span> <span class="n">T_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="MjSim.opp4-711"><a href="#MjSim.opp4-711"><span class="linenos">711</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gripper</span><span class="o">.</span><span class="n">get_ee_pose</span><span class="p">()</span>  <span class="c1"># Current TCP pose in world frame</span>
</span><span id="MjSim.opp4-712"><a href="#MjSim.opp4-712"><span class="linenos">712</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MjSim.opp4-713"><a href="#MjSim.opp4-713"><span class="linenos">713</span></a>            <span class="n">T_w_tcp</span> <span class="o">=</span> <span class="n">T_init</span>
</span><span id="MjSim.opp4-714"><a href="#MjSim.opp4-714"><span class="linenos">714</span></a>
</span><span id="MjSim.opp4-715"><a href="#MjSim.opp4-715"><span class="linenos">715</span></a>        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">T_w_tcp</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Make a copy of the translation vector</span>
</span><span id="MjSim.opp4-716"><a href="#MjSim.opp4-716"><span class="linenos">716</span></a>        <span class="n">end_pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_height</span>
</span><span id="MjSim.opp4-717"><a href="#MjSim.opp4-717"><span class="linenos">717</span></a>        <span class="n">T_target</span> <span class="o">=</span> <span class="n">make_tf</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">end_pos</span><span class="p">,</span> <span class="n">ori</span><span class="o">=</span><span class="n">T_w_tcp</span><span class="o">.</span><span class="n">R</span><span class="p">)</span>
</span><span id="MjSim.opp4-718"><a href="#MjSim.opp4-718"><span class="linenos">718</span></a>
</span><span id="MjSim.opp4-719"><a href="#MjSim.opp4-719"><span class="linenos">719</span></a>        <span class="k">return</span> <span class="n">T_target</span>
</span></pre></div>


            <div class="docstring"><p>Compute a target pose for the robot's end-effector with a specified z-height.</p>

<h2 id="parameters">Parameters</h2>

<p>z_height : float
    Desired height (z-coordinate) for the end-effector in the world frame.
T_init : sm.SE3, optional
    Initial pose of the end-effector. If None, the current pose is fetched from the robot, by default None.</p>

<h2 id="returns">Returns</h2>

<p>sm.SE3
    The computed target pose with the specified z-height.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="base_sim.html#BaseSim">sims.base_sim.BaseSim</a></dt>
                                <dd id="MjSim.control_loop" class="function"><a href="base_sim.html#BaseSim.control_loop">control_loop</a></dd>
                <dd id="MjSim.run" class="function"><a href="base_sim.html#BaseSim.run">run</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>